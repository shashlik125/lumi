{% extends "base.html" %}

{% block title %}Lumi ‚Äî –ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è{% endblock %}

{% block extra_css %}
<style>

/* –û–°–ù–û–í–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï */
:root {
  --primary-color: #264653;
  --accent-gradient: linear-gradient(to right, #60F4E3, #FFEFFD, #FF70EC);
  --accent-teal: #60F4E3;
  --accent-pink: #FF70EC;
  --background-light: #f8f9fa;
  --card-bg: #ffffff;
  --text-color: #264653;
  --text-muted: #6c757d;
  --border-radius: 20px;
  --shadow: 0 6px 16px rgba(0,0,0,0.1);
  --transition: all 0.3s ease;
  --danger: #F44336;
  --white: #ffffff;
  
  /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–∞–ª–µ–Ω–¥–∞—Ä—è */
  --primary: #60F4E3;
  --primary-dark: #48cbbd;
  --secondary: #FF70EC;
  --accent: #FFEFFD;
  --dark: #264653;
  --light: #f8f9fa;
  --gray: #6c757d;
  --success: #4CAF50;
  --warning: #FFC107;
  --border-radius-chart: 16px;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  font-family: 'Montserrat', sans-serif;
}

body { 
  margin: 0; 
  background: linear-gradient(to right, #60F4E3 0%, #FFEFFD 50%, #FF70EC 100%);
  color: var(--dark);
  line-height: 1.6;
  min-height: 100vh;
  padding-top: 80px; /* –û—Ç—Å—Ç—É–ø –¥–ª—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ö–µ–¥–µ—Ä–∞ */
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.dropdown a {
  padding: 12px 16px;
  text-decoration: none;
  color: var(--text-color);
  font-weight: 500;
  transition: var(--transition);
}

.dropdown a:hover,
.dropdown a:focus {
  background: #f2f2f2;
}

main { 
  padding: 30px 20px; 
  max-width: 1000px; 
  margin: 0 auto; 
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
  flex-wrap: wrap;
  gap: 15px;
}

h1 {
  font-size: 28px;
  color: var(--dark);
  position: relative;
  padding-bottom: 10px;
  font-weight: 700;
}

h1:after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  width: 60px;
  height: 4px;
  background: linear-gradient(to right, var(--primary), var(--secondary));
  border-radius: 2px;
}

.calendar-container {
  background: var(--white);
  border-radius: var(--border-radius);
  box-shadow: var(--shadow);
  padding: 25px;
  margin-bottom: 30px;
}

.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.calendar-title {
  font-size: 22px;
  font-weight: 700;
  color: var(--dark);
}

.calendar-controls {
  display: flex;
  gap: 10px;
  align-items: center;
}

.calendar-btn {
  background: var(--primary);
  border: none;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-weight: bold;
  transition: var(--transition);
  color: var(--dark);
}

.calendar-btn:hover {
  background: var(--primary-dark);
  transform: scale(1.1);
}

.today-btn {
  padding: 8px 16px;
  background: var(--white);
  border: 2px solid var(--primary);
  border-radius: 20px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  color: var(--dark);
}

.today-btn:hover {
  background: var(--primary);
  transform: translateY(-2px);
}

.weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  text-align: center;
  font-weight: 600;
  margin-bottom: 10px;
  color: var(--gray);
  background: rgba(96, 244, 227, 0.1);
  border-radius: 10px;
  padding: 10px 0;
}

.weekday {
  padding: 10px;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
}

.calendar-day {
  aspect-ratio: 1/1;
  border-radius: 12px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  background: var(--light);
  transition: var(--transition);
  position: relative;
  padding: 5px;
  border: 2px solid transparent;
  font-family: inherit;
  color: inherit;
}

.calendar-day:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  border-color: var(--primary);
}

.day-number {
  font-weight: 600;
  font-size: 16px;
  margin-bottom: 5px;
}

.other-month {
  background: rgba(248, 248, 248, 0.5);
  color: #ccc;
}

.current-day {
  background: var(--accent);
  border: 2px solid var(--primary);
  box-shadow: 0 2px 8px rgba(96, 244, 227, 0.3);
}

.mood-good {
  background: rgba(96, 244, 227, 0.3);
  border-color: var(--primary);
}

.mood-neutral {
  background: rgba(255, 112, 236, 0.2);
  border-color: var(--secondary);
}

.mood-bad {
  background: rgba(244, 67, 54, 0.2);
  border-color: var(--danger);
}

.mood-indicator {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  position: absolute;
  bottom: 5px;
  right: 5px;
  border: 2px solid var(--white);
}

.mood-good .mood-indicator {
  background: var(--primary);
}

.mood-neutral .mood-indicator {
  background: var(--secondary);
}

.mood-bad .mood-indicator {
  background: var(--danger);
}

.stats-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-top: 30px;
}

.stat-card {
  background: var(--white);
  border-radius: var(--border-radius);
  box-shadow: var(--shadow);
  padding: 20px;
  text-align: center;
  transition: var(--transition);
  border: 2px solid transparent;
}

.stat-card:hover {
  transform: translateY(-5px);
  border-color: var(--primary);
}

.stat-title {
  font-size: 16px;
  color: var(--gray);
  margin-bottom: 10px;
  font-weight: 600;
}

.stat-value {
  font-size: 28px;
  font-weight: 700;
  color: var(--primary);
}

.mood-legend {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 20px;
  flex-wrap: wrap;
  background: var(--white);
  padding: 15px;
  border-radius: var(--border-radius);
  box-shadow: var(--shadow);
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  padding: 8px 12px;
  border-radius: 20px;
  background: var(--light);
}

.legend-color {
  width: 15px;
  height: 15px;
  border-radius: 50%;
}

/* –¢–æ—á–∫–∞ –¥–ª—è —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–Ω—è */
.today-dot {
    position: absolute;
    top: 6px;
    right: 6px;
    width: 8px;
    height: 8px;
    background: #000000;
    border-radius: 50%;
    border: 1.5px solid white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    z-index: 5;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
    20%, 40%, 60%, 80% { transform: translateX(3px); }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
.toast {
    position: fixed;
    top: 90px; /* –ü–æ–¥ —Ö–µ–¥–µ—Ä–æ–º */
    right: 20px;
    background: var(--danger);
    color: white;
    padding: 12px 16px;
    border-radius: 8px;
    box-shadow: var(--shadow);
    z-index: 1000;
    font-weight: 500;
    font-size: 14px;
    opacity: 0;
    transform: translateX(100px);
    transition: opacity 0.3s ease, transform 0.3s ease;
    max-width: 250px;
    text-align: left;
    word-break: break-word;
}

.toast.show {
    opacity: 1;
    transform: translateX(0);
}

.toast.error {
    background: var(--danger);
}

.toast.success {
    background: #4CAF50;
}

.toast.info {
    background: #2196F3;
}

/* –ú–û–ë–ò–õ–¨–ù–ê–Ø –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ - –¢–û–õ–¨–ö–û –ó–î–ï–°–¨ –ú–ï–ù–Ø–ï–ú */

@media (max-width: 768px) {
    /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ö–µ–¥–µ—Ä –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ –∏ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ */
    body {
        padding-top: 60px; /* –£–º–µ–Ω—å—à–∏–ª–∏ –æ—Ç—Å—Ç—É–ø */
    }

    nav a.active::after {
    display: block !important; /* –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ */
    width: 100% !important;
    height: 2px;
    background: var(--accent-pink);
    bottom: 0;
}
    
    
    .user span {
        display: none; /* –°–∫—Ä—ã–≤–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
    }
    
    /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
    main {
        padding: 20px 15px;
    }
    
    h1 {
        font-size: 24px;
        padding-bottom: 8px;
    }
    
    .calendar-container {
        padding: 20px;
        border-radius: 18px;
        margin-bottom: 25px;
    }
    
    .calendar-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
        margin-bottom: 15px;
    }
    
    .calendar-title {
        font-size: 18px;
    }
    
    .calendar-controls {
        width: 100%;
        justify-content: space-between;
    }
    
    .today-btn {
        padding: 8px 16px;
        font-size: 14px;
    }
    
    .calendar-btn {
        width: 36px;
        height: 36px;
    }
    
    .weekdays {
        padding: 8px 0;
        font-size: 14px;
        margin-bottom: 8px;
    }
    
    .weekday {
        padding: 6px 2px;
        font-size: 13px;
    }
    
    .calendar-grid {
        gap: 6px;
    }
    
    .calendar-day {
        min-height: 45px;
        border-radius: 10px;
        padding: 4px;
    }
    
    .day-number {
        font-size: 14px;
        margin-bottom: 3px;
    }
    
    .mood-indicator {
        width: 16px;
        height: 16px;
        bottom: 4px;
        right: 4px;
    }
    
    .today-dot {
        top: 4px;
        right: 4px;
        width: 6px;
        height: 6px;
    }
    
    .stats-container {
        grid-template-columns: 1fr;
        gap: 15px;
        margin-top: 25px;
    }
    
    .stat-card {
        padding: 15px;
        border-radius: 16px;
    }
    
    .stat-title {
        font-size: 14px;
        margin-bottom: 8px;
    }
    
    .stat-value {
        font-size: 24px;
    }
    
    .mood-legend {
        padding: 12px;
        border-radius: 16px;
        gap: 12px;
        margin-top: 20px;
        flex-direction: column;
        align-items: center;
    }
    
    .legend-item {
        font-size: 13px;
        padding: 6px 10px;
        width: 100%;
        justify-content: center;
    }
    
    .legend-color {
        width: 12px;
        height: 12px;
    }
    
    /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    .toast {
        top: 70px;
        right: 10px;
        left: 10px;
        max-width: none;
        text-align: center;
        font-size: 13px;
    }
    
    /* –£–±–∏—Ä–∞–µ–º hover-—ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è —Ç–∞—á-—É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    .calendar-day:hover,
    .stat-card:hover {
        transform: none;
        box-shadow: none;
        border-color: transparent;
    }
}

@media (max-width: 480px) {
    /* –ï—â–µ –±–æ–ª–µ–µ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ */
    body {
        padding-top: 55px;
    }

    main {
        padding: 15px 10px;
    }
    
    h1 {
        font-size: 22px;
    }
    
    .calendar-container {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 16px;
    }
    
    .calendar-title {
        font-size: 16px;
    }
    
    .today-btn {
        padding: 6px 12px;
        font-size: 13px;
    }
    
    .calendar-btn {
        width: 32px;
        height: 32px;
    }
    
    .calendar-btn i {
        font-size: 12px;
    }
    
    .weekday {
        padding: 5px 1px;
        font-size: 12px;
    }
    
    .calendar-grid {
        gap: 4px;
    }
    
    .calendar-day {
        min-height: 40px;
        border-radius: 8px;
        padding: 3px;
    }
    
    .day-number {
        font-size: 12px;
    }
    
    .mood-indicator {
        width: 14px;
        height: 14px;
        bottom: 3px;
        right: 3px;
    }
    
    .today-dot {
        top: 3px;
        right: 3px;
        width: 5px;
        height: 5px;
    }
    
    .stat-title {
        font-size: 13px;
    }
    
    .stat-value {
        font-size: 22px;
    }
}

/* –õ–∞–Ω–¥—à–∞—Ñ—Ç–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è */
@media (max-height: 500px) and (orientation: landscape) {

    .calendar-day {
        min-height: 35px;
    }
}
</style>
{% endblock %}

{% block content %}

<main>
  <div class="page-header">
    <h1>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è</h1>
  </div>

  <div class="calendar-container">
    <div class="calendar-header">
      <div class="calendar-title" id="monthYear"></div>
      <div class="calendar-controls">
        <button class="calendar-btn" onclick="changeMonth(-1)">
          <i class="fas fa-chevron-left"></i>
        </button>
        <button class="today-btn" onclick="goToToday()">
          –°–µ–≥–æ–¥–Ω—è
        </button>
        <button class="calendar-btn" onclick="changeMonth(1)">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>

    <div class="weekdays">
      <div class="weekday">–ü–Ω</div>
      <div class="weekday">–í—Ç</div>
      <div class="weekday">–°—Ä</div>
      <div class="weekday">–ß—Ç</div>
      <div class="weekday">–ü—Ç</div>
      <div class="weekday">–°–±</div>
      <div class="weekday">–í—Å</div>
    </div>

    <div class="calendar-grid" id="calendar"></div>
  </div>

  <div class="mood-legend">
    <div class="legend-item">
      <div class="legend-color" style="background: var(--primary);"></div>
      <span>–•–æ—Ä–æ—à–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: var(--secondary);"></div>
      <span>–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: var(--danger);"></div>
      <span>–ü–ª–æ—Ö–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</span>
    </div>
  </div>

  <div class="stats-container">
    <div class="stat-card">
      <div class="stat-title">–•–æ—Ä–æ—à–∏—Ö –¥–Ω–µ–π –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ</div>
      <div class="stat-value" id="goodDays">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-title">–°—Ä–µ–¥–Ω–∏–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è</div>
      <div class="stat-value" id="avgMood">0.0</div>
    </div>
    <div class="stat-card">
      <div class="stat-title">–ó–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –¥–Ω–µ–π</div>
      <div class="stat-value" id="filledDays">0/30</div>
    </div>
  </div>
  
  <!-- –£–ë–ò–†–ê–ï–ú –ü–û–°–õ–ï–î–ù–Æ–Æ –ü–õ–ê–®–ö–£ "–ß—Ç–æ –ø–æ—Ä–∞–¥–æ–≤–∞–ª–æ —Å–µ–≥–æ–¥–Ω—è" - –ï–Å –ó–î–ï–°–¨ –ù–ï–¢ -->
</main>
{% endblock %}

{% block extra_js %}

<script>
const API_BASE = "{{ url_for('main.mood_entries') }}";
const STATS_API = "{{ url_for('main.stats') }}";

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let currentDate = new Date();
let moods = [];

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showToast(message, type = 'success') {
    const existingToasts = document.querySelectorAll('.toast');
    existingToasts.forEach(toast => toast.remove());
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('show');
    }, 10);
    
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
async function loadMoodData() {
    try {
        console.log('üì° –ó–∞–ø—Ä–æ—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π —Å API:', API_BASE);
        const response = await fetch(API_BASE);
        
        console.log('üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status);
        
        if (response.ok) {
            let allMoods = await response.json();
            console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π:', allMoods.length);
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            moods = allMoods.filter(entry => {
                const entryDate = new Date(entry.date + 'T00:00:00');
                const isPastOrToday = entryDate <= today;
                
                if (!isPastOrToday) {
                    console.log('‚è© –ü—Ä–æ–ø—É—â–µ–Ω–æ –±—É–¥—É—â–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ:', entry.date);
                }
                
                return isPastOrToday;
            });
            
            console.log('‚úÖ –ê–∫—Ç—É–∞–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π:', moods.length);
            console.log('üìã –ü—Ä–∏–º–µ—Ä—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π:', moods.slice(0, 3));
            
            return true;
        } else {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', response.status);
            moods = [];
            return false;
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π:', error);
        moods = [];
        return false;
    }
}

// –û—á–∏—Å—Ç–∫–∞ –±—É–¥—É—â–∏—Ö –∑–∞–ø–∏—Å–µ–π
async function cleanupFutureEntries() {
    const today = new Date().toISOString().split('T')[0];
    
    try {
        const response = await fetch(API_BASE);
        if (!response.ok) return;
        
        const allEntries = await response.json();
        const futureEntries = allEntries.filter(entry => entry.date > today);
        
        if (futureEntries.length > 0) {
            for (const entry of futureEntries) {
                await fetch(`${API_BASE}/${entry.id}`, {
                    method: 'DELETE',
                });
            }
            
            await loadMoodData();
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –±—É–¥—É—â–∏—Ö –∑–∞–ø–∏—Å–µ–π:', error);
    }
}

// –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
const calendar = document.getElementById("calendar");
const monthYear = document.getElementById("monthYear");

function formatISO(year, month, day) {
    return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
}

function parseDateISO(str) {
    const [y, m, d] = str.split("-").map(Number);
    return new Date(y, m - 1, d);
}

function createDayElement(dayNumber, className, isOtherMonth) {
    const dayElement = document.createElement("div");
    dayElement.classList.add("calendar-day");

    if (className) dayElement.classList.add(className);

    const numberElement = document.createElement("div");
    numberElement.classList.add("day-number");
    numberElement.textContent = dayNumber;

    dayElement.appendChild(numberElement);

    if (isOtherMonth) {
        dayElement.style.cursor = 'default';
        dayElement.style.pointerEvents = 'none';
    }

    return dayElement;
}

function openDayDetail(dateKey, event) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const selectedDate = new Date(dateKey + 'T00:00:00');
    
    if (selectedDate > today) {
        showToast('‚ùå –î–∞—Ç–∞ –≤ –±—É–¥—É—â–µ–º', 'error');
        
        const dayElement = event.target.closest('.calendar-day');
        if (dayElement && !dayElement.classList.contains('other-month')) {
            dayElement.style.animation = 'shake 0.5s';
            setTimeout(() => {
                dayElement.style.animation = '';
            }, 500);
        }
        
        return;
    }
    
    window.location.href = `/calendar/day/${dateKey}`;
}

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
function renderCalendar() {
    if (!calendar) return;
    
    calendar.innerHTML = "";
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();

    monthYear.textContent = currentDate.toLocaleString("ru-RU", { 
        month: "long", year: "numeric" 
    });

    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    
    let startDay = firstDay.getDay();
    if (startDay === 0) startDay = 7;

    const prevMonthDays = new Date(year, month, 0).getDate();
    for (let i = startDay - 1; i > 0; i--) {
        const day = createDayElement(prevMonthDays - i + 1, "other-month", true);
        calendar.appendChild(day);
    }

    const today = new Date();

    for (let i = 1; i <= daysInMonth; i++) {
        const dateKey = formatISO(year, month + 1, i);
        const day = createDayElement(i, "", false);

        const isToday = today.getDate() === i && 
                today.getMonth() === month && 
                today.getFullYear() === year;
        if (isToday) {
            day.classList.add("current-day");
            
            const todayDot = document.createElement("div");
            todayDot.className = "today-dot";
            todayDot.title = "–°–µ–≥–æ–¥–Ω—è";
            day.appendChild(todayDot);
        }

        const dayMoods = moods.filter(entry => entry.date === dateKey);
        if (dayMoods.length > 0) {
            const avgMood = dayMoods.reduce((s, m) => s + m.mood, 0) / dayMoods.length;

            if (avgMood >= 7) day.classList.add("mood-good");
            else if (avgMood >= 4) day.classList.add("mood-neutral");
            else day.classList.add("mood-bad");

            const indicator = document.createElement("div");
            indicator.classList.add("mood-indicator");
            day.appendChild(indicator);
        }

        day.addEventListener('click', function(event) {
            openDayDetail(dateKey, event);
        });

        calendar.appendChild(day);
    }

    const totalCells = 35;
    const filledCells = startDay - 1 + daysInMonth;

    if (filledCells < totalCells) {
        for (let i = 1; i <= totalCells - filledCells; i++) {
            const day = createDayElement(i, "other-month", true);
            calendar.appendChild(day);
        }
    }
}

function changeMonth(step) {
    currentDate.setMonth(currentDate.getMonth() + step);
    renderCalendar();
    updateStats();
}

function goToToday() {
    currentDate = new Date();
    renderCalendar();
    updateStats();
}

async function updateStats() {
    try {
        console.log('üìä –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...');
        console.log('üìÖ –¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü:', currentDate.getMonth() + 1, currentDate.getFullYear());
        console.log('üé≠ –í—Å–µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π:', moods.length);
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∑–∞ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
        const monthlyMoods = moods.filter(entry => {
            const entryDate = new Date(entry.date + 'T00:00:00');
            return entryDate.getFullYear() === year && 
                   entryDate.getMonth() === month;
        });
        
        console.log('üé≠ –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–π –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ:', monthlyMoods.length);
        
        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        let goodDaysCount = 0;
        let totalMood = 0;
        const filledDates = new Set();
        
        monthlyMoods.forEach(entry => {
            filledDates.add(entry.date);
            totalMood += entry.mood;
            
            if (entry.mood >= 7) {
                goodDaysCount++;
            }
        });
        
        const filledDaysCount = filledDates.size;
        const avgMoodValue = filledDaysCount > 0 ? (totalMood / filledDaysCount).toFixed(1) : "0.0";
        
        console.log('üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:', {
            —Ö–æ—Ä–æ—à–∏—Ö–î–Ω–µ–π: goodDaysCount,
            —Å—Ä–µ–¥–Ω–µ–µ–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: avgMoodValue,
            –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö–î–Ω–µ–π: filledDaysCount
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º DOM
        const goodDaysElement = document.getElementById("goodDays");
        const avgMoodElement = document.getElementById("avgMood");
        const filledDaysElement = document.getElementById("filledDays");
        
        if (goodDaysElement) goodDaysElement.textContent = goodDaysCount;
        if (avgMoodElement) avgMoodElement.textContent = avgMoodValue;
        if (filledDaysElement) filledDaysElement.textContent = `${filledDaysCount}/${daysInMonth}`;
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–∏ –æ—à–∏–±–∫–µ
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        const goodDaysElement = document.getElementById("goodDays");
        const avgMoodElement = document.getElementById("avgMood");
        const filledDaysElement = document.getElementById("filledDays");
        
        if (goodDaysElement) goodDaysElement.textContent = "0";
        if (avgMoodElement) avgMoodElement.textContent = "0.0";
        if (filledDaysElement) filledDaysElement.textContent = `0/${daysInMonth}`;
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', async function() {
    try {
        console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–∞–ª–µ–Ω–¥–∞—Ä—è...');
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        const loaded = await loadMoodData();
        console.log('‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', moods.length, '–∑–∞–ø–∏—Å–µ–π');
        
        // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
        renderCalendar();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        updateStats();
        
        // –û—á–∏—â–∞–µ–º –±—É–¥—É—â–∏–µ –∑–∞–ø–∏—Å–∏ –≤ —Ñ–æ–Ω–µ
        cleanupFutureEntries();
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
    }
});

// –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ HTML
window.changeMonth = changeMonth;
window.goToToday = goToToday;
window.showToast = showToast;
window.renderCalendar = renderCalendar;
window.updateStats = updateStats;
</script>
{% endblock %}