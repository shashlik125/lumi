{% extends "base.html" %}

{% block title %}Lumi ‚Äî –ê–Ω–∞–ª–∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è{% endblock %}

{% block extra_css %}
<style>
@import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap');

:root {
  --primary-color: #264653;
  --accent-gradient: linear-gradient(to right, #60F4E3, #FFEFFD, #FF70EC);
  --accent-teal: #60F4E3;
  --accent-pink: #FF70EC;
  --background-light: #f8f9fa;
  --card-bg: #ffffff;
  --text-color: #264653;
  --text-muted: #6c757d;
  --border-radius: 20px;
  --shadow: 0 6px 16px rgba(0,0,0,0.1);
  --transition: all 0.3s ease;
  --danger: #F44336;
  --white: #ffffff;
  
  /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∞–Ω–∞–ª–∏–∑–∞ */
  --primary: #60F4E3;
  --primary-dark: #48cbbd;
  --secondary: #FF70EC;
  --accent: #FFEFFD;
  --dark: #264653;
  --light: #f8f9fa;
  --gray: #6c757d;
  --success: #4CAF50;
  --warning: #FFC107;
  --border-radius-chart: 16px;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  font-family: 'Montserrat', sans-serif;
}

body { 
  margin: 0; 
  background: linear-gradient(to right, #60F4E3 0%, #FFEFFD 50%, #FF70EC 100%);
  color: var(--dark);
  line-height: 1.6;
  min-height: 100vh;
  font-size: 18px;
  max-width: 100%;
  overflow-x: hidden;
  position: relative;
  padding-top: 80px; /* –û—Ç—Å—Ç—É–ø –¥–ª—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ö–µ–¥–µ—Ä–∞ */
}

/* –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –í–°–ï–ì–û –ö–û–ù–¢–ï–ù–¢–ê */
.container {
  width: 100%;
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 20px;
  display: flex;
  flex-direction: column;
  position: relative;
  z-index: 2;
}

/* –•–ï–î–ï–† - –ê–î–ê–ü–¢–ò–í–ù–´–ô –ö–ê–ö –í DASHBOARD */
header {
  background: white;
  padding: 15px 5%;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  min-height: 80px;
  
  background: linear-gradient(to bottom, 
    white 0%, 
    white 70%,
    rgba(255,255,255,0.9) 80%, 
    rgba(255,255,255,0.7) 90%,
    rgba(255,255,255,0.4) 95%,
    rgba(255,255,255,0) 100%);
}

.logo {
  font-size: 28px;
  font-weight: 700;
  color: #264653;
  letter-spacing: 1px;
  white-space: nowrap;
}

nav {
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
  justify-content: center;
}

nav a {
  text-decoration: none;
  color: #264653;
  font-weight: 600;
  position: relative;
  padding: 8px 12px;
  transition: all 0.3s ease;
  font-size: 16px;
  white-space: nowrap;
}

nav a::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  width: 0;
  height: 2px;
  background: var(--accent-pink);
  transition: all 0.3s ease;
}

nav a:hover::after,
nav a:focus::after {
  width: 100%;
}

nav a.active::after {
  width: 100% !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∞–≤–∞—Ç–∞—Ä–∞ - –∫–∞–∫ –≤ dashboard */
.user-wrapper {
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  position: relative;
  padding: 5px 10px;
  border-radius: 8px;
  transition: all 0.3s ease;
  margin-left: auto;
  white-space: nowrap;
}

.user-wrapper:hover,
.user-wrapper:focus {
  background: rgba(255, 255, 255, 0.3);
}

.user-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: 2px solid var(--white);
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  object-fit: cover;
}

.dropdown {
  position: absolute;
  top: 100%;
  right: 0;
  background: var(--card-bg);
  border-radius: 12px;
  box-shadow: var(--shadow);
  display: none;
  flex-direction: column;
  min-width: 160px;
  overflow: hidden;
  z-index: 101;
  margin-top: 10px;
}

.dropdown.show {
  display: flex;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.dropdown a {
  padding: 12px 16px;
  text-decoration: none;
  color: var(--text-color);
  font-weight: 500;
  transition: all 0.3s ease;
}

.dropdown a:hover,
.dropdown a:focus {
  background: #f2f2f2;
}

/* –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ –°–¢–†–ê–ù–ò–¶–´ */
main { 
  padding: 30px 0; 
  max-width: 1200px; 
  margin: 0 auto; 
  min-height: calc(100vh - 140px);
  width: 100%;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
  flex-wrap: wrap;
  gap: 15px;
}

h1 {
  font-size: 28px;
  color: var(--dark);
  position: relative;
  padding-bottom: 10px;
  font-weight: 700;
}

h1:after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  width: 60px;
  height: 4px;
  background: linear-gradient(to right, var(--primary), var(--secondary));
  border-radius: 2px;
}

.controls-container {
  background: var(--white);
  border-radius: var(--border-radius);
  box-shadow: var(--shadow);
  padding: 20px;
  margin-bottom: 25px;
}

.period-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  flex-wrap: wrap;
  gap: 10px;
}

.period-title {
  font-size: 18px;
  font-weight: 600;
  color: var(--dark);
  min-width: 200px;
  text-align: center;
}

.period-nav {
  display: flex;
  align-items: center;
  gap: 10px;
}

.view-controls {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-top: 15px;
  flex-wrap: wrap;
}

.btn {
  padding: 10px 16px;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
}

.btn-primary {
  background: var(--primary);
  color: var(--dark);
}

.btn-primary:hover {
  background: var(--primary-dark);
  transform: translateY(-2px);
}

.btn-secondary {
  background: var(--white);
  color: var(--gray);
  border: 2px solid var(--primary);
}

.btn-secondary:hover {
  background: var(--primary);
  color: var(--dark);
  transform: translateY(-2px);
}

.btn-active {
  background: var(--secondary);
  color: var(--white);
  border: 2px solid var(--secondary);
}

.btn-active:hover {
  background: #e55cd8;
  transform: translateY(-2px);
}

.charts-container {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 25px;
  margin-bottom: 30px;
}

.main-chart {
  background: var(--white);
  border-radius: var(--border-radius);
  box-shadow: var(--shadow);
  padding: 25px;
  height: 400px;
  position: relative;
  min-height: 400px;
}

.side-charts {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.side-chart {
  background: var(--white);
  border-radius: var(--border-radius);
  box-shadow: var(--shadow);
  padding: 20px;
  height: 190px;
  position: relative;
  min-height: 190px;
}

.chart-title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 15px;
  text-align: center;
  color: var(--dark);
}

.chart-wrapper {
  position: relative;
  height: calc(100% - 35px);
  width: 100%;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-top: 30px;
}

.stat-card {
  background: var(--white);
  border-radius: var(--border-radius);
  box-shadow: var(--shadow);
  padding: 20px;
  text-align: center;
  transition: var(--transition);
  border: 2px solid transparent;
}

.stat-card:hover {
  transform: translateY(-5px);
  border-color: var(--primary);
}

.stat-title {
  font-size: 16px;
  color: var(--gray);
  margin-bottom: 10px;
  font-weight: 600;
}

.stat-value {
  font-size: 28px;
  font-weight: 700;
  color: var(--primary);
}

.stat-change {
  font-size: 14px;
  margin-top: 5px;
  color: var(--gray);
}

.positive {
  color: var(--success);
}

.negative {
  color: var(--danger);
}

.mood-legend {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin-top: 20px;
  flex-wrap: wrap;
  background: var(--white);
  padding: 15px;
  border-radius: var(--border-radius);
  box-shadow: var(--shadow);
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  padding: 8px 12px;
  border-radius: 20px;
  background: var(--light);
}

.legend-color {
  width: 15px;
  height: 15px;
  border-radius: 50%;
}

.good-color {
  background: var(--primary);
}

.neutral-color {
  background: var(--secondary);
}

.bad-color {
  background: var(--danger);
}

.insights {
  background: var(--white);
  border-radius: var(--border-radius);
  box-shadow: var(--shadow);
  padding: 25px;
  margin-top: 30px;
}

.insights-title {
  font-size: 20px;
  font-weight: 700;
  margin-bottom: 15px;
  color: var(--dark);
  display: flex;
  align-items: center;
  gap: 10px;
}

.insight-item {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 15px;
  padding: 15px;
  background: var(--light);
  border-radius: var(--border-radius);
  transition: var(--transition);
}

.insight-item:hover {
  transform: translateX(5px);
  background: rgba(96, 244, 227, 0.1);
}

.insight-icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--primary);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--dark);
  font-size: 18px;
  flex-shrink: 0;
}

.insight-text {
  flex: 1;
}

.no-data {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--gray);
  text-align: center;
  padding: 20px;
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--white);
  border-radius: var(--border-radius);
}

.no-data i {
  font-size: 48px;
  margin-bottom: 15px;
  opacity: 0.5;
}

.no-data p {
  font-size: 16px;
  margin-bottom: 10px;
}

.no-data .btn {
  margin-top: 15px;
}

.loading {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--gray);
}

.loading-spinner {
  width: 40px;
  height: 40px;
  border: 4px solid var(--light);
  border-top: 4px solid var(--primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
.toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background: var(--success);
  color: white;
  padding: 15px 20px;
  border-radius: 8px;
  box-shadow: var(--shadow);
  z-index: 1000;
  font-weight: 600;
  transform: translateX(100%);
  transition: transform 0.3s ease;
}

.toast.show {
  transform: translateX(0);
}

.toast.error {
  background: var(--danger);
}

/* –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ - –•–ï–î–ï–† */
@media (max-width: 992px) {
  .logo {
    font-size: 24px;
  }
  
  nav {
    gap: 10px;
  }
  
  nav a {
    padding: 6px 10px;
    font-size: 14px;
  }
}

/* –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ - –ú–û–ë–ò–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø (–¢–û–õ–¨–ö–û –ö–û–ù–¢–ï–ù–¢) */
@media (max-width: 768px) {
    /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ö–µ–¥–µ—Ä –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ –∏ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ */
    body {
        padding-top: 60px; /* –£–º–µ–Ω—å—à–∏–ª–∏ –æ—Ç—Å—Ç—É–ø */
    }
    
    header {
        padding: 10px 15px;
        min-height: 60px; /* –£–º–µ–Ω—å—à–∏–ª–∏ –≤—ã—Å–æ—Ç—É */
        flex-wrap: nowrap; /* –û–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ */
        overflow-x: auto; /* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –µ—Å–ª–∏ –Ω–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è */
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch; /* –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –Ω–∞ iOS */
        gap: 15px;
        justify-content: flex-start; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é */
        scrollbar-width: none; /* –°–∫—Ä—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä –¥–ª—è Firefox */
        -ms-overflow-style: none; /* –°–∫—Ä—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä –¥–ª—è IE/Edge */
    }
    
    /* –°–∫—Ä—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä –¥–ª—è Webkit –±—Ä–∞—É–∑–µ—Ä–æ–≤ */
    header::-webkit-scrollbar {
        display: none;
    }
    
    /* –£–ë–ò–†–ê–ï–ú –õ–û–ì–û–¢–ò–ü LUMI */
    .logo {
        display: none !important; /* –ü–æ–ª–Ω–æ—Å—Ç—å—é —Å–∫—Ä—ã–≤–∞–µ–º –ª–æ–≥–æ—Ç–∏–ø */
    }
    
    /* –ù–∞–≤–∏–≥–∞—Ü–∏—è - –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ */
    nav {
        order: 1;
        display: flex;
        gap: 8px;
        flex-shrink: 0; /* –ù–µ —Å–∂–∏–º–∞–µ—Ç—Å—è */
        margin: 0;
        padding: 0;
    }
    
    nav a {
        padding: 8px 12px;
        font-size: 14px;
        white-space: nowrap; /* –ù–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å —Ç–µ–∫—Å—Ç */
        flex-shrink: 0;
        border-radius: 0;
        background: transparent;
        border: none;
    }
    
    nav a.active {
        color: var(--primary-color);
        background: transparent;
        border: none;
    }
    
    nav a.active::after {
        display: block !important; /* –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ */
        width: 100% !important;
        height: 2px;
        background: var(--accent-pink);
        bottom: 0;
    }
    
    /* –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
    .user-wrapper {
        order: 2;
        margin-left: auto; /* –ü—Ä–∏–∂–∏–º–∞–µ–º –∫ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é */
        flex-shrink: 0;
        padding: 5px 8px;
        background: transparent;
        border-radius: 8px;
        min-width: 50px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞ */
    }
    
    .user-wrapper span {
        display: none; /* –°–∫—Ä—ã–≤–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
    }
    
    .user-avatar {
        width: 32px;
        height: 32px;
    }
    
  
  /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
    .container {
        padding: 0 15px;
    }
    
    main { 
        padding: 20px 0; 
        min-height: calc(100vh - 100px);
    }
    
    .page-header {
        margin-bottom: 20px;
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    h1 {
        font-size: 24px;
        padding-bottom: 8px;
    }
    
    h1:after {
        width: 50px;
        height: 3px;
    }
    
    .controls-container {
        padding: 15px;
        border-radius: 18px;
        margin-bottom: 20px;
    }
    
    .period-controls {
        flex-direction: column;
        align-items: center;
        text-align: center;
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .period-title {
        min-width: auto;
        font-size: 16px;
        order: -1;
        margin-bottom: 10px;
    }
    
    .period-nav {
        width: 100%;
        justify-content: center;
    }
    
    .view-controls {
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
    }
    
    .btn {
        padding: 8px 12px;
        font-size: 13px;
        min-width: 60px;
    }
    
    /* –î–∏–∞–≥—Ä–∞–º–º—ã */
    .charts-container {
        grid-template-columns: 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .main-chart {
        height: 300px;
        padding: 20px;
        min-height: 300px;
    }
    
    .side-charts {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
    }
    
    .side-chart {
        height: 180px;
        padding: 15px;
        min-height: 180px;
    }
    
    .chart-title {
        font-size: 15px;
        margin-bottom: 10px;
    }
    
    /* –õ–µ–≥–µ–Ω–¥–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π */
    .mood-legend {
        padding: 12px;
        border-radius: 16px;
        gap: 12px;
        margin-top: 15px;
        flex-direction: column;
        align-items: center;
    }
    
    .legend-item {
        font-size: 13px;
        padding: 6px 10px;
        width: 100%;
        justify-content: center;
    }
    
    .legend-color {
        width: 12px;
        height: 12px;
    }
    
    /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-top: 20px;
    }
    
    .stat-card {
        padding: 15px;
        border-radius: 16px;
    }
    
    .stat-title {
        font-size: 14px;
        margin-bottom: 8px;
    }
    
    .stat-value {
        font-size: 24px;
    }
    
    .stat-change {
        font-size: 12px;
    }
    
    /* –ò–Ω—Å–∞–π—Ç—ã */
    .insights {
        padding: 20px;
        border-radius: 16px;
        margin-top: 20px;
    }
    
    .insights-title {
        font-size: 18px;
        margin-bottom: 12px;
    }
    
    .insight-item {
        padding: 12px;
        margin-bottom: 12px;
    }
    
    .insight-icon {
        width: 36px;
        height: 36px;
        font-size: 16px;
    }
    
    .insight-text {
        font-size: 14px;
    }
    
    .no-data i {
        font-size: 36px;
        margin-bottom: 10px;
    }
    
    .no-data p {
        font-size: 14px;
        margin-bottom: 8px;
    }
    
    .loading-spinner {
        width: 32px;
        height: 32px;
    }
    
    /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    .toast {
        top: 70px;
        right: 10px;
        left: 10px;
        max-width: none;
        text-align: center;
        font-size: 13px;
    }
}

@media (max-width: 480px) {
    .side-charts {
        grid-template-columns: 1fr;
    }
    
    .side-chart {
        height: 160px;
        min-height: 160px;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .view-controls {
        flex-direction: column;
        align-items: stretch;
    }
    
    .btn {
        width: 100%;
        justify-content: center;
    }
    
    .period-nav {
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .period-nav .btn {
        flex: 1;
        min-width: 80px;
    }
}

@media (max-width: 360px) {
    .main-chart {
        height: 250px;
        padding: 15px;
        min-height: 250px;
    }
    
    .side-chart {
        height: 140px;
        padding: 12px;
        min-height: 140px;
    }
    
    .chart-title {
        font-size: 14px;
    }
    
    .btn {
        padding: 6px 10px;
        font-size: 12px;
    }
}



</style>
{% endblock %}

{% block content %}
<header>
  <div class="logo">Lumi</div>
  <nav>
    <a href="{{ url_for('main.chart') }}" 
       class="{% if request.endpoint == 'main.chart' %}active{% endif %}">
      –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
    </a>
    <a href="{{ url_for('main.dashboard') }}" 
       class="{% if request.endpoint == 'main.dashboard' %}active{% endif %}">
      –ì–ª–∞–≤–Ω–∞—è
    </a>
    <a href="{{ url_for('main.calendar') }}" 
       class="{% if request.endpoint == 'main.calendar' %}active{% endif %}">
      –ö–∞–ª–µ–Ω–¥–∞—Ä—å
    </a>
    <a href="{{ url_for('main.cycle_diary') }}" 
       class="{% if request.endpoint == 'main.cycle_diary' %}active{% endif %}">
      –î–Ω–µ–≤–Ω–∏–∫ —Ü–∏–∫–ª–∞
    </a>
  </nav>
  <div class="user-wrapper" tabindex="0" aria-haspopup="true" aria-expanded="false">
    <span id="username">
        {% if current_user.is_authenticated %}
            {{ current_user.first_name or current_user.username }}
        {% else %}
            –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        {% endif %}
    </span>
    {% if current_user.avatar_path %}
        <img src="{{ url_for('static', filename=current_user.avatar_path) }}" alt="–ê–≤–∞—Ç–∞—Ä" class="user-avatar">
    {% else %}
        <img src="https://ui-avatars.com/api/?name={{ current_user.first_name or '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' }}&background=60F4E3&color=264653" alt="–ê–≤–∞—Ç–∞—Ä" class="user-avatar">
    {% endif %}
    <div class="dropdown" id="userMenu">
        <a href="{{ url_for('main.profile') }}">–ü—Ä–æ—Ñ–∏–ª—å</a>
        <a href="{{ url_for('auth.logout') }}">–í—ã–π—Ç–∏</a>
    </div>
  </div>
</header>

<div class="container">
  <main>
    <div class="page-header">
      <h1>–ê–Ω–∞–ª–∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è</h1>
    </div>

    <div class="controls-container">
      <div class="period-controls">
        <div class="period-nav">
          <button class="btn btn-primary" onclick="changePeriod(-1)">
            <i class="fas fa-chevron-left"></i>
          </button>
          <button class="btn btn-secondary" onclick="goToday()">
            <i class="fas fa-calendar-day"></i> –°–µ–≥–æ–¥–Ω—è
          </button>
          <button class="btn btn-primary" onclick="changePeriod(1)">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
        <div class="period-title" id="periodLabel">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
      </div>

      <div class="view-controls">
        <button class="btn btn-secondary view-btn" id="dayBtn" onclick="setView('day')">
          <i class="fas fa-calendar-day"></i> –î–µ–Ω—å
        </button>
        <button class="btn btn-secondary view-btn" id="weekBtn" onclick="setView('week')">
          <i class="fas fa-calendar-week"></i> –ù–µ–¥–µ–ª—è
        </button>
        <button class="btn btn-secondary view-btn" id="monthBtn" onclick="setView('month')">
          <i class="fas fa-calendar-alt"></i> –ú–µ—Å—è—Ü
        </button>
        <button class="btn btn-secondary view-btn" id="yearBtn" onclick="setView('year')">
          <i class="fas fa-calendar"></i> –ì–æ–¥
        </button>
      </div>
    </div>

    <div class="charts-container">
      <!-- –û—Å–Ω–æ–≤–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ -->
      <div class="main-chart">
        <div class="chart-title" id="mainChartTitle">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–æ –¥–Ω—è–º</div>
        <div class="chart-wrapper">
          <canvas id="mainChart"></canvas>
          <div class="no-data" id="mainChartNoData" style="display: none;">
            <i class="fas fa-chart-line"></i>
            <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
            <p>–î–æ–±–∞–≤—å—Ç–µ –∑–∞–ø–∏—Å–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</p>
            <a href="{{ url_for('main.calendar') }}" class="btn btn-primary">
              <i class="fas fa-calendar"></i> –ü–µ—Ä–µ–π—Ç–∏ –∫ –∫–∞–ª–µ–Ω–¥–∞—Ä—é
            </a>
          </div>
          <div class="loading" id="mainChartLoading" style="display: none;">
            <div class="loading-spinner"></div>
          </div>
        </div>
      </div>

      <!-- –ë–æ–∫–æ–≤—ã–µ –¥–∏–∞–≥—Ä–∞–º–º—ã -->
      <div class="side-charts">
        <!-- –î–∏–∞–≥—Ä–∞–º–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π -->
        <div class="side-chart">
          <div class="chart-title">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–π</div>
          <div class="chart-wrapper">
            <canvas id="distributionChart"></canvas>
            <div class="no-data" id="distributionChartNoData" style="display: none;">
              <i class="fas fa-chart-pie"></i>
              <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
            </div>
            <div class="loading" id="distributionChartLoading" style="display: none;">
              <div class="loading-spinner"></div>
            </div>
          </div>
        </div>

        <!-- –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫ -->
        <div class="side-chart">
          <div class="chart-title">–ü–æ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫</div>
          <div class="chart-wrapper">
            <canvas id="timeChart"></canvas>
            <div class="no-data" id="timeChartNoData" style="display: none;">
              <i class="fas fa-clock"></i>
              <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
            </div>
            <div class="loading" id="timeChartLoading" style="display: none;">
              <div class="loading-spinner"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="mood-legend">
      <div class="legend-item">
        <div class="legend-color good-color"></div>
        <span>–•–æ—Ä–æ—à–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ (7-10)</span>
      </div>
      <div class="legend-item">
        <div class="legend-color neutral-color"></div>
        <span>–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ (4-6)</span>
      </div>
      <div class="legend-item">
        <div class="legend-color bad-color"></div>
        <span>–ü–ª–æ—Ö–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ (1-3)</span>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-title">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</div>
        <div class="stat-value" id="totalEntries">0</div>
        <div class="stat-change" id="entriesChange">–∑–∞ —Ç–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">–•–æ—Ä–æ—à–∏—Ö –¥–Ω–µ–π</div>
        <div class="stat-value" id="goodDays">0</div>
        <div class="stat-change" id="goodDaysChange">% –æ—Ç –æ–±—â–µ–≥–æ —á–∏—Å–ª–∞</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">–°—Ä–µ–¥–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</div>
        <div class="stat-value" id="avgMood">0.0</div>
        <div class="stat-change" id="avgMoodChange">–ø–æ —à–∫–∞–ª–µ 1-10</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
        <div class="stat-value" id="activityLevel">0%</div>
        <div class="stat-change">–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –¥–Ω–µ–π</div>
      </div>
    </div>

    <div class="insights">
      <h3 class="insights-title"><i class="fas fa-lightbulb"></i> –ò–Ω—Å–∞–π—Ç—ã</h3>
      <div class="insight-item">
        <div class="insight-icon">
          <i class="fas fa-chart-line"></i>
        </div>
        <div class="insight-text">
          <strong>–¢–µ–Ω–¥–µ–Ω—Ü–∏—è:</strong> <span id="trendText">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∞—à–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ...</span>
        </div>
      </div>
      <div class="insight-item">
        <div class="insight-icon">
          <i class="fas fa-calendar"></i>
        </div>
        <div class="insight-text">
          <strong>–õ—É—á—à–∏–π –ø–µ—Ä–∏–æ–¥:</strong> <span id="bestPeriodText">–û–ø—Ä–µ–¥–µ–ª—è–µ–º...</span>
        </div>
      </div>
      <div class="insight-item">
        <div class="insight-icon">
          <i class="fas fa-clock"></i>
        </div>
        <div class="insight-text">
          <strong>–ü–∏–∫–æ–≤–æ–µ –≤—Ä–µ–º—è:</strong> <span id="peakTimeText">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º...</span>
        </div>
      </div>
    </div>
  </main>
</div>
{% endblock %}

{% block extra_js %}
<script>
// JavaScript –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ –º–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
document.addEventListener('DOMContentLoaded', function() {
    initEventListeners();
});

function initEventListeners() {
    const userElement = document.querySelector('.user-wrapper');
    if (userElement) {
        userElement.addEventListener('click', toggleMenu);
    }
    
    document.addEventListener('click', function(e) {
        const menu = document.getElementById('userMenu');
        const user = document.querySelector('.user-wrapper');
        if (menu && menu.classList.contains('show') && user && !user.contains(e.target)) {
            toggleMenu();
        }
    });
}

function toggleMenu() {
    const menu = document.getElementById('userMenu');
    if (menu) {
        menu.classList.toggle('show');
    }
}

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showToast(message, type = 'success') {
    // Remove existing toasts
    const existingToasts = document.querySelectorAll('.toast');
    existingToasts.forEach(toast => toast.remove());
    
    // Create new toast
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    // Animate in
    setTimeout(() => {
        toast.classList.add('show');
    }, 10);
    
    // Remove after 3 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

window.showToast = showToast;
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const API_BASE = "{{ url_for('main.mood_entries') }}";
const HOURLY_MOODS_API = "{{ url_for('main.hourly_moods') }}";

let mainChart, distributionChart, timeChart;
let currentDate = new Date();
let currentView = "week";
let moodData = [];
let hourlyDataCache = {};

// –§–£–ù–ö–¶–ò–Ø –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–ò –î–ê–¢–´ - –ì–õ–ê–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï
function normalizeDate(dateString) {
    if (!dateString) return "";
    return dateString.split("T")[0];
}

// –¶–≤–µ—Ç–∞ –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º
const chartColors = {
    good: '#60F4E3',
    neutral: '#FF70EC', 
    bad: '#F44336',
    background: 'rgba(96, 244, 227, 0.1)',
    grid: 'rgba(0, 0, 0, 0.05)'
};

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∞–Ω–∞–ª–∏–∑–∞...');
    document.getElementById(`${currentView}Btn`).classList.add('btn-active');
    loadMoodData();
});

async function loadMoodData() {
    showLoading(true);
    try {
        console.log('üìä –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è...');
        const response = await fetch(API_BASE);
        if (response.ok) {
            moodData = await response.json();
            console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', moodData.length, '–∑–∞–ø–∏—Å–µ–π');
            
            // –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–Ø –î–ê–¢ –í moodData - –ö–õ–Æ–ß–ï–í–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï
            moodData = moodData.map(entry => ({
                ...entry,
                date: normalizeDate(entry.date),
                created_at: entry.created_at ? entry.created_at.replace('T', ' ').slice(0, 16) : null
            }));
            
            console.log('üìÖ –î–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏:', moodData);
            updateCharts();
        } else {
            throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
        showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
    } finally {
        showLoading(false);
    }
}

function showLoading(show) {
    const loadingElements = document.querySelectorAll('.loading');
    loadingElements.forEach(el => {
        el.style.display = show ? 'flex' : 'none';
    });
}

function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function formatDateDisplay(date) {
    return date.toLocaleDateString('ru-RU', {
        day: 'numeric',
        month: 'long',
        year: 'numeric'
    });
}

function getWeekDates(date) {
    let monday = new Date(date);
    monday.setDate(date.getDate() - ((date.getDay() + 6) % 7)); 
    return Array.from({length: 7}, (_, i) => {
        let d = new Date(monday);
        d.setDate(monday.getDate() + i);
        return d;
    });
}

function getMonthDates(date) {
    let year = date.getFullYear();
    let month = date.getMonth();
    let days = new Date(year, month + 1, 0).getDate();
    return Array.from({length: days}, (_, i) => new Date(year, month, i + 1));
}

function getYearMonths(date) {
    let year = date.getFullYear();
    return Array.from({length: 12}, (_, i) => new Date(year, i, 1));
}

function getMoodCategory(moodValue) {
    if (moodValue >= 7) return 'good';
    if (moodValue >= 4) return 'neutral';
    return 'bad';
}

function getMoodColor(category) {
    return chartColors[category];
}

function getMoodEmoji(moodValue) {
    if (moodValue >= 8) return 'üòä';
    if (moodValue >= 5) return 'üòê';
    if (moodValue >= 3) return 'üòï';
    return 'üòû';
}

async function loadHourlyData(date) {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
    if (hourlyDataCache[date]) {
        return hourlyDataCache[date];
    }
    
    try {
        const response = await fetch(`${HOURLY_MOODS_API}?date=${date}`);
        if (response.ok) {
            const data = await response.json();
            // –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–Ø –î–ê–¢ –í hourlyData
            const normalizedData = data.map(entry => ({
                ...entry,
                date: normalizeDate(entry.date)
            }));
            hourlyDataCache[date] = normalizedData;
            return normalizedData;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—á–∞—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', error);
    }
    return [];
}

async function generateMainChartData() {
    let labels = [];
    let data = [];
    let labelText = "";

    if (currentView === "day") {
        const dateStr = formatDate(currentDate);
        // –î–ª—è –¥–Ω—è –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—á–∞—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ HOURLY_MOODS_API
        const dayData = await loadHourlyData(dateStr);
        
        console.log('üìÖ –î–∞–Ω–Ω—ã–µ –∑–∞ –¥–µ–Ω—å:', dateStr, dayData);
        
        // –î–ª—è –¥–Ω—è –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—á–∞—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        labels = Array.from({length: 24}, (_, i) => `${i}:00`);
        data = Array.from({length: 24}, (_, hour) => {
            const hourData = dayData.find(entry => entry.hour === hour);
            return hourData ? hourData.mood : null;
        });
        labelText = `–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∑–∞ ${formatDateDisplay(currentDate)}`;
        
    } else if (currentView === "week") {
        const dates = getWeekDates(currentDate);
        labels = ["–ü–Ω", "–í—Ç", "–°—Ä", "–ß—Ç", "–ü—Ç", "–°–±", "–í—Å"];
        data = dates.map(d => {
            const key = formatDate(d);
            const dayEntries = moodData.filter(entry => entry.date === key);
            if (dayEntries.length === 0) return null;
            // –ë–µ—Ä–µ–º —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∑–∞ –¥–µ–Ω—å
            return dayEntries.reduce((sum, entry) => sum + entry.mood, 0) / dayEntries.length;
        });
        const startDate = dates[0];
        const endDate = dates[6];
        labelText = `–ù–µ–¥–µ–ª—è ${startDate.getDate()}-${endDate.getDate()} ${startDate.toLocaleString('ru', {month: 'long'})}`;
        
    } else if (currentView === "month") {
        const dates = getMonthDates(currentDate);
        labels = dates.map(d => d.getDate());
        data = dates.map(d => {
            const key = formatDate(d);
            const dayEntries = moodData.filter(entry => entry.date === key);
            if (dayEntries.length === 0) return null;
            return dayEntries.reduce((sum, entry) => sum + entry.mood, 0) / dayEntries.length;
        });
        labelText = `${currentDate.toLocaleString('ru', {month: 'long'})} ${currentDate.getFullYear()}`;
        
    } else {
        const dates = getYearMonths(currentDate);
        const months = ["–Ø–Ω–≤", "–§–µ–≤", "–ú–∞—Ä", "–ê–ø—Ä", "–ú–∞–π", "–ò—é–Ω", "–ò—é–ª", "–ê–≤–≥", "–°–µ–Ω", "–û–∫—Ç", "–ù–æ—è", "–î–µ–∫"];
        labels = months;
        data = dates.map(d => {
            const monthStr = d.toISOString().slice(0, 7);
            const monthData = moodData.filter(entry => entry.date.startsWith(monthStr));
            if (monthData.length === 0) return null;
            return monthData.reduce((sum, entry) => sum + entry.mood, 0) / monthData.length;
        });
        labelText = `${currentDate.getFullYear()} –≥–æ–¥`;
    }

    document.getElementById('periodLabel').textContent = labelText;
    document.getElementById('mainChartTitle').textContent = labelText;

    return { labels, data };
}

async function updateMainChart() {
    const { labels, data } = await generateMainChartData();
    
    if (mainChart) mainChart.destroy();

    const ctx = document.getElementById('mainChart').getContext('2d');
    const noDataElement = document.getElementById('mainChartNoData');
    
    const validData = data.filter(val => val !== null);
    const hasData = validData.length > 0;

    if (!hasData) {
        noDataElement.style.display = 'flex';
        return;
    } else {
        noDataElement.style.display = 'none';
    }

    mainChart = new Chart(ctx, {
        type: currentView === 'day' ? 'bar' : 'line',
        data: {
            labels: labels,
            datasets: [{
                label: '–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ',
                data: data,
                borderColor: chartColors.good,
                backgroundColor: currentView === 'day' ? 
                    data.map(val => val ? getMoodColor(getMoodCategory(val)) : chartColors.grid) : 
                    chartColors.background,
                tension: 0.4,
                fill: currentView !== 'day',
                pointBackgroundColor: data.map(val => val ? getMoodColor(getMoodCategory(val)) : chartColors.grid),
                pointBorderColor: '#fff',
                pointRadius: currentView === 'day' ? 0 : 6,
                pointHoverRadius: currentView === 'day' ? 0 : 8,
                borderWidth: currentView === 'day' ? 0 : 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    min: 1,
                    max: 10,
                    ticks: {
                        callback: function(value) {
                            const emojis = ['', 'üòû', '', '', 'üòê', '', '', 'üòä', '', 'ü§©'];
                            return emojis[value] || '';
                        },
                        stepSize: 1
                    },
                    grid: {
                        color: chartColors.grid
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw;
                            if (value === null) return '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                            const categories = {
                                'good': '–•–æ—Ä–æ—à–µ–µ',
                                'neutral': '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ', 
                                'bad': '–ü–ª–æ—Ö–æ–µ'
                            };
                            const emoji = getMoodEmoji(value);
                            return `${emoji} –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: ${value.toFixed(1)} (${categories[getMoodCategory(value)]})`;
                        }
                    }
                }
            }
        }
    });
}

function updateDistributionChart() {
    const currentData = getCurrentPeriodData();
    const distribution = { good: 0, neutral: 0, bad: 0 };

    currentData.forEach(entry => {
        distribution[getMoodCategory(entry.mood)]++;
    });

    const total = currentData.length;
    const noDataElement = document.getElementById('distributionChartNoData');

    if (total === 0) {
        noDataElement.style.display = 'flex';
        if (distributionChart) distributionChart.destroy();
        return;
    } else {
        noDataElement.style.display = 'none';
    }

    const percentages = {
        good: total > 0 ? (distribution.good / total * 100) : 0,
        neutral: total > 0 ? (distribution.neutral / total * 100) : 0,
        bad: total > 0 ? (distribution.bad / total * 100) : 0
    };

    if (distributionChart) distributionChart.destroy();

    const ctx = document.getElementById('distributionChart').getContext('2d');
    
    distributionChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['–•–æ—Ä–æ—à–µ–µ', '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ', '–ü–ª–æ—Ö–æ–µ'],
            datasets: [{
                data: [percentages.good, percentages.neutral, percentages.bad],
                backgroundColor: [chartColors.good, chartColors.neutral, chartColors.bad],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: ${context.raw.toFixed(1)}% (${Math.round(context.raw * total / 100)} –∑–∞–ø–∏—Å–µ–π)`;
                        }
                    }
                }
            }
        }
    });
}

function updateTimeChart() {
    const currentData = getCurrentPeriodData();
    const timeDistribution = Array(24).fill(0);
    const timeCount = Array(24).fill(0);

    currentData.forEach(entry => {
        if (entry.hour !== undefined && entry.hour !== null) {
            timeDistribution[entry.hour] += entry.mood;
            timeCount[entry.hour]++;
        }
    });

    const averages = timeDistribution.map((sum, i) => 
        timeCount[i] > 0 ? sum / timeCount[i] : null
    );

    const noDataElement = document.getElementById('timeChartNoData');
    const hasData = averages.some(avg => avg !== null);

    if (!hasData) {
        noDataElement.style.display = 'flex';
        if (timeChart) timeChart.destroy();
        return;
    } else {
        noDataElement.style.display = 'none';
    }

    if (timeChart) timeChart.destroy();

    const ctx = document.getElementById('timeChart').getContext('2d');
    
    timeChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Array.from({length: 24}, (_, i) => i),
            datasets: [{
                data: averages,
                backgroundColor: averages.map(avg => 
                    avg ? getMoodColor(getMoodCategory(avg)) : chartColors.grid
                ),
                borderWidth: 0,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    display: false,
                    min: 1,
                    max: 10
                },
                x: {
                    ticks: {
                        callback: function(value) {
                            return value === 0 || value === 6 || value === 12 || value === 18 || value === 23 ? value : '';
                        },
                        maxRotation: 0
                    },
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return `${context[0].label}:00`;
                        },
                        label: function(context) {
                            const value = context.raw;
                            return value ? `–°—Ä–µ–¥–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: ${value.toFixed(1)}` : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                        }
                    }
                }
            }
        }
    });
}

function getCurrentPeriodData() {
    if (currentView === "day") {
        const dateStr = formatDate(currentDate);
        return moodData.filter(entry => entry.date === dateStr);
    } else if (currentView === "week") {
        const dates = getWeekDates(currentDate);
        const dateStrs = dates.map(d => formatDate(d));
        return moodData.filter(entry => dateStrs.includes(entry.date));
    } else if (currentView === "month") {
        const monthStr = currentDate.toISOString().slice(0, 7);
        return moodData.filter(entry => entry.date.startsWith(monthStr));
    } else {
        const yearStr = currentDate.getFullYear().toString();
        return moodData.filter(entry => entry.date.startsWith(yearStr));
    }
}

function updateStats() {
    const currentData = getCurrentPeriodData();
    const totalEntries = currentData.length;
    
    document.getElementById('totalEntries').textContent = totalEntries;
    
    // –•–æ—Ä–æ—à–∏–µ –¥–Ω–∏ (–Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ >= 7)
    const goodEntries = currentData.filter(entry => entry.mood >= 7);
    const goodDays = new Set(goodEntries.map(entry => entry.date)).size;
    const goodPercentage = totalEntries > 0 ? Math.round((goodEntries.length / totalEntries) * 100) : 0;
    
    document.getElementById('goodDays').textContent = goodEntries.length;
    document.getElementById('goodDaysChange').textContent = `${goodPercentage}% –æ—Ç –æ–±—â–µ–≥–æ —á–∏—Å–ª–∞`;
    
    // –°—Ä–µ–¥–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
    const avgMood = totalEntries > 0 ? 
        (currentData.reduce((sum, entry) => sum + entry.mood, 0) / totalEntries).toFixed(1) : '0.0';
    document.getElementById('avgMood').textContent = avgMood;
    
    // –£—Ä–æ–≤–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    let totalDays = 0;
    if (currentView === "day") totalDays = 1;
    else if (currentView === "week") totalDays = 7;
    else if (currentView === "month") totalDays = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
    else totalDays = 12;
    
    const uniqueDays = new Set(currentData.map(entry => entry.date)).size;
    const activityLevel = Math.round((uniqueDays / totalDays) * 100);
    document.getElementById('activityLevel').textContent = `${activityLevel}%`;
    
    updateInsights(currentData, goodPercentage, avgMood);
}

function updateInsights(data, goodPercentage, avgMood) {
    if (data.length === 0) {
        document.getElementById('trendText').textContent = '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞';
        document.getElementById('bestPeriodText').textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Å–∞–π—Ç–æ–≤';
        document.getElementById('peakTimeText').textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –≤—Ä–µ–º–µ–Ω–∏';
        return;
    }
    
    // –ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–∞
    const recentData = data.slice(-5);
    let trend = '—Å—Ç–∞–±–∏–ª—å–Ω–æ–µ';
    if (recentData.length >= 2) {
        const first = recentData[0].mood;
        const last = recentData[recentData.length - 1].mood;
        if (last > first + 1) trend = '–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ';
        else if (last < first - 1) trend = '–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ';
    }
    document.getElementById('trendText').textContent = `–í–∞—à–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç ${trend} –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ`;
    
    // –õ—É—á—à–∏–π –ø–µ—Ä–∏–æ–¥
    if (goodPercentage > 60) {
        document.getElementById('bestPeriodText').textContent = '–û—Ç–ª–∏—á–Ω—ã–π –ø–µ—Ä–∏–æ–¥! –ü—Ä–µ–æ–±–ª–∞–¥–∞–µ—Ç —Ö–æ—Ä–æ—à–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ';
    } else if (goodPercentage > 30) {
        document.getElementById('bestPeriodText').textContent = '–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ —Å —Ä–∞–∑–Ω—ã–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ–º';
    } else {
        document.getElementById('bestPeriodText').textContent = '–ü–µ—Ä–∏–æ–¥ —Ç—Ä–µ–±—É–µ—Ç –±–æ–ª—å—à–µ –ø–æ–∑–∏—Ç–∏–≤–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤';
    }
    
    // –ü–∏–∫–æ–≤–æ–µ –≤—Ä–µ–º—è
    const hourCounts = {};
    data.forEach(entry => {
        if (entry.hour !== undefined) {
            hourCounts[entry.hour] = (hourCounts[entry.hour] || 0) + 1;
        }
    });
    
    let peakHour = null;
    let maxCount = 0;
    Object.entries(hourCounts).forEach(([hour, count]) => {
        if (count > maxCount) {
            maxCount = count;
            peakHour = hour;
        }
    });
    
    if (peakHour !== null) {
        const period = peakHour < 12 ? '—É—Ç—Ä–æ' : peakHour < 18 ? '–¥–µ–Ω—å' : '–≤–µ—á–µ—Ä';
        document.getElementById('peakTimeText').textContent = `–ù–∞–∏–±–æ–ª–µ–µ –∞–∫—Ç–∏–≤–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –∑–∞–ø–∏—Å–µ–π: ${period} (${peakHour}:00)`;
    } else {
        document.getElementById('peakTimeText').textContent = '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–∏–∫–æ–≤–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏';
    }
}

async function updateCharts() {
    console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∏–∞–≥—Ä–∞–º–º...');
    showLoading(true);
    try {
        await updateMainChart();
        updateDistributionChart();
        updateTimeChart();
        updateStats();
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∏–∞–≥—Ä–∞–º–º:', error);
    } finally {
        showLoading(false);
    }
}

function changePeriod(offset) {
    if (currentView === "day") {
        currentDate.setDate(currentDate.getDate() + offset);
    } else if (currentView === "week") {
        currentDate.setDate(currentDate.getDate() + offset * 7);
    } else if (currentView === "month") {
        currentDate.setMonth(currentDate.getMonth() + offset);
    } else if (currentView === "year") {
        currentDate.setFullYear(currentDate.getFullYear() + offset);
    }
    updateCharts();
}

function goToday() {
    currentDate = new Date();
    updateCharts();
}

function setView(view) {
    currentView = view;
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.remove('btn-active');
        btn.classList.add('btn-secondary');
    });
    document.getElementById(`${view}Btn`).classList.remove('btn-secondary');
    document.getElementById(`${view}Btn`).classList.add('btn-active');
    
    updateCharts();
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast ${type === 'error' ? 'error' : ''}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('show');
    }, 10);
    
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 300);
    }, 3000);
}
</script>
{% endblock %}