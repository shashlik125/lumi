{% extends "base.html" %}

{% block title %}Lumi ‚Äî –î–Ω–µ–≤–Ω–∏–∫ —Ü–∏–∫–ª–∞{% endblock %}

{% block extra_css %}
<style>
/* ==========================================================================
   –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
   ========================================================================== */
* {
    font-family: 'Montserrat', sans-serif !important;
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

:root {
    /* –û—Å–Ω–æ–≤–Ω—ã–µ —Ü–≤–µ—Ç–∞ */
    --primary: #60F4E3;
    --primary-dark: #48cbbd;
    --secondary: #FF70EC;
    --accent: #FFEFFD;
    --dark: #264653;
    --light: #f8f9fa;
    --white: #ffffff;
    --gray: #6c757d;
    --success: #4CAF50;
    --warning: #FFC107;
    --danger: #F44336;
    
    /* –§–∞–∑—ã —Ü–∏–∫–ª–∞ */
    --menstruation: #FF6B6B;
    --follicular: #60F4E3;
    --ovulation: #FF70EC;
    --luteal: #FFD166;
    --pms: #B8B3E9;
    
    /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
    --border-radius: 16px;
    --shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ==========================================================================
   –û—Å–Ω–æ–≤–Ω–æ–π –ª–µ–π–∞—É—Ç
   ========================================================================== */
body {
    margin: 0;
    background: linear-gradient(to right, #60F4E3 0%, #FFEFFD 50%, #FF70EC 100%);
    color: var(--dark);
    line-height: 1.6;
    min-height: 100vh;
    padding-top: 80px; /* –î–ª—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ö–µ–¥–µ—Ä–∞ */
}

main {
    padding: 30px 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    flex-wrap: wrap;
    gap: 15px;
}

h1 {
    font-size: 28px;
    color: var(--dark);
    position: relative;
    padding-bottom: 10px;
    font-weight: 700;
}

h1:after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 60px;
    height: 4px;
    background: linear-gradient(to right, var(--primary), var(--secondary));
    border-radius: 2px;
}

/* ==========================================================================
   –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ü–∏–∫–ª–∞
   ========================================================================== */
.cycle-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    padding: 20px;
    text-align: center;
    transition: var(--transition);
    border: 2px solid transparent;
}

.stat-card:hover {
    transform: translateY(-5px);
    border-color: var(--primary);
}

.stat-title {
    font-size: 16px;
    color: var(--gray);
    margin-bottom: 10px;
    font-weight: 600;
}

.stat-value {
    font-size: 28px;
    font-weight: 700;
    color: var(--primary);
}

.stat-change {
    font-size: 14px;
    margin-top: 5px;
    color: var(--gray);
}

/* ==========================================================================
   –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Ü–∏–∫–ª–∞
   ========================================================================== */
.cycle-calendar-container {
    background: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    padding: 25px;
    margin-bottom: 30px;
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.calendar-title {
    font-size: 22px;
    font-weight: 700;
    color: var(--dark);
}

.calendar-controls {
    display: flex;
    gap: 10px;
    align-items: center;
}

.calendar-btn {
    background: var(--primary);
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-weight: bold;
    transition: var(--transition);
    color: var(--dark);
}

.calendar-btn:hover {
    background: var(--primary-dark);
    transform: scale(1.1);
}

.today-btn {
    padding: 8px 16px;
    background: var(--white);
    border: 2px solid var(--primary);
    border-radius: 20px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    color: var(--dark);
}

.today-btn:hover {
    background: var(--primary);
    transform: translateY(-2px);
}

.weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    text-align: center;
    font-weight: 600;
    margin-bottom: 10px;
    color: var(--gray);
    background: rgba(96, 244, 227, 0.1);
    border-radius: 10px;
    padding: 10px 0;
}

.weekday {
    padding: 10px;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 8px;
}

/* ==========================================================================
   –î–Ω–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è - –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –í–ê–†–ò–ê–ù–¢
   ========================================================================== */
.calendar-day {
    aspect-ratio: 1/1;
    min-height: 85px;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    cursor: pointer;
    background: var(--light);
    transition: var(--transition);
    position: relative;
    padding: 8px 5px 5px 5px;
    border: 2px solid transparent;
    font-weight: 600;
    overflow: visible !important;
}

.calendar-day:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    border-color: var(--primary);
}

.day-number {
    font-size: 18px;
    margin-bottom: 5px;
    position: relative;
    z-index: 2;
}

.cycle-phase-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin: 1px 0;
}

/* ==========================================================================
   –§–∞–∑—ã —Ü–∏–∫–ª–∞ (—Ü–≤–µ—Ç–∞)
   ========================================================================== */
.menstruation {
    background: linear-gradient(135deg, rgba(255, 107, 107, 0.95), rgba(255, 168, 168, 0.95)) !important;
    color: white !important;
}

.calendar-day.menstruation .day-number {
    color: white !important;
    font-weight: bold;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}

.menstruation-indicator {
    position: absolute !important;
    top: 5px !important;
    right: 5px !important;
    font-size: 14px !important;
    z-index: 5 !important;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
}

.follicular {
    background: linear-gradient(135deg, var(--follicular), #A8F0E9);
}

.ovulation {
    background: linear-gradient(135deg, var(--ovulation), #FFB6F1);
    color: white;
}

.luteal {
    background: linear-gradient(135deg, var(--luteal), #FFE8B2);
}

.pms-phase {
    background: linear-gradient(135deg, var(--pms), #D8D5F2);
}

.fertile-window {
    border: 2px dashed var(--ovulation);
}

.predicted {
    border: 2px dotted var(--gray);
    opacity: 0.7;
}

.current-day {
    background: var(--accent);
    border: 2px solid var(--primary);
    box-shadow: 0 2px 8px rgba(96, 244, 227, 0.3);
}

.other-month {
    background: rgba(248, 248, 248, 0.5);
    color: #ccc;
    cursor: default;
    pointer-events: none;
    opacity: 0.5;
}

/* ==========================================================================
   –°–∏–º–ø—Ç–æ–º—ã –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ - –ö–õ–Æ–ß–ï–í–´–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø
   ========================================================================== */
.symptoms-dots-compact {
    display: flex;
    flex-wrap: wrap;
    gap: 3px;
    justify-content: center;
    align-content: center;
    padding: 2px;
    margin-top: 8px;
    min-height: 20px;
    position: relative;
    z-index: 3 !important;
}

.calendar-day.menstruation .symptoms-dots-compact {
    margin-top: 25px !important;
    z-index: 4 !important;
}

.symptom-dot-compact {
    width: 5px;
    height: 5px;
    border-radius: 50%;
    flex-shrink: 0;
    transition: transform 0.2s;
}

.calendar-day.menstruation .symptom-dot-compact {
    border: 1px solid rgba(255, 255, 255, 0.8) !important;
    box-shadow: 0 0 3px rgba(0, 0, 0, 0.3), 0 0 2px rgba(255, 255, 255, 0.8) !important;
}

.symptom-dot-compact:hover {
    transform: scale(1.5);
    z-index: 10;
}

/* –¢—É–ª—Ç–∏–ø—ã —Å–∏–º–ø—Ç–æ–º–æ–≤ */
.symptoms-tooltip {
    display: none;
    position: absolute;
    bottom: calc(100% + 10px);
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.95);
    color: white;
    padding: 10px 14px;
    border-radius: 10px;
    font-size: 12px;
    white-space: normal;
    max-width: 200px;
    width: max-content;
    z-index: 1000;
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
    line-height: 1.4;
    word-wrap: break-word;
    text-align: center;
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.symptoms-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border-width: 6px;
    border-style: solid;
    border-color: rgba(0, 0, 0, 0.95) transparent transparent transparent;
}

.symptoms-tooltip.has-many-items {
    text-align: left;
    max-height: 150px;
    overflow-y: auto;
    padding: 10px;
}

.symptoms-tooltip.has-many-items .symptom-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 4px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.symptoms-tooltip.has-many-items .symptom-item:last-child {
    border-bottom: none;
}

.symptoms-tooltip.has-many-items .symptom-color {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
}

.symptoms-tooltip.has-many-items .symptom-name {
    flex-grow: 1;
}

/* ==========================================================================
   –§–æ—Ä–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
   ========================================================================== */
.tracker-container {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 25px;
    margin-bottom: 30px;
}

.tracker-form {
    background: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    padding: 25px;
}

.form-section {
    margin-bottom: 25px;
}

.section-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 15px;
    color: var(--dark);
    display: flex;
    align-items: center;
    gap: 10px;
}

.symptoms-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
    margin-bottom: 15px;
}

.symptom-checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px;
    background: rgba(96, 244, 227, 0.1);
    border-radius: 8px;
    cursor: pointer;
    transition: var(--transition);
    font-size: 14px;
}

.symptom-checkbox:hover {
    background: rgba(96, 244, 227, 0.2);
}

.symptom-checkbox input {
    margin: 0;
}

.form-input,
.form-select,
.form-textarea {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    font-family: 'Montserrat', sans-serif;
    font-size: 14px;
    transition: var(--transition);
    background: white;
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 0 3px rgba(96, 244, 227, 0.2);
}

.form-textarea {
    resize: vertical;
    min-height: 80px;
}

/* ==========================================================================
   –ö–Ω–æ–ø–∫–∏
   ========================================================================== */
.btn {
    padding: 12px 25px;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    width: 100%;
    justify-content: center;
}

.btn-primary {
    background: var(--primary) !important;
    color: var(--dark) !important;
    border: 2px solid var(--primary) !important;
}

.btn-primary:hover {
    background: var(--secondary) !important;
    border-color: var(--secondary) !important;
    color: white !important;
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(255, 112, 236, 0.3) !important;
}

.btn-delete {
    background: var(--secondary) !important;
    color: white !important;
    border: 2px solid var(--secondary) !important;
}

.btn-delete:hover {
    background: var(--primary) !important;
    border-color: var(--primary) !important;
    color: var(--dark) !important;
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(96, 244, 227, 0.3) !important;
}

.btn-primary:active,
.btn-delete:active {
    transform: translateY(0);
}

.form-buttons {
    display: flex;
    gap: 15px;
    margin-top: 25px;
}

.form-buttons .btn {
    flex: 1;
    min-width: 0;
}

/* –ö–Ω–æ–ø–∫–∏ –º–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏–∏ */
.quick-menstruation {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 15px;
}

.btn-menstruation {
    background: linear-gradient(135deg, var(--menstruation), #FF8E8E) !important;
    color: white !important;
    border: 2px solid var(--menstruation) !important;
}

.btn-menstruation-light {
    background: linear-gradient(135deg, #FFB8B8, #FFD6D6) !important;
    color: var(--dark) !important;
    border: 2px solid #FFB8B8 !important;
}

.btn-menstruation-end {
    background: linear-gradient(135deg, var(--primary), #A8F0E9) !important;
    color: var(--dark) !important;
    border: 2px solid var(--primary) !important;
}

.btn-menstruation:hover,
.btn-menstruation-light:hover,
.btn-menstruation-end:hover {
    transform: translateY(-3px) !important;
    box-shadow: 0 6px 12px rgba(255, 107, 107, 0.3) !important;
}

/* ==========================================================================
   –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
   ========================================================================== */
.mood-integration {
    background: var(--accent);
    border-radius: var(--border-radius);
    padding: 20px;
    border: 2px solid var(--primary);
}

.mood-display {
    text-align: center;
    padding: 15px;
}

.mood-value {
    font-size: 32px;
    font-weight: 700;
    margin-bottom: 10px;
    color: var(--primary);
}

.mood-emoji {
    font-size: 48px;
    margin-bottom: 10px;
}

.mood-note {
    font-size: 14px;
    color: var(--gray);
    margin-top: 10px;
}

/* ==========================================================================
   –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –≥—Ä–∞—Ñ–∏–∫–∏
   ========================================================================== */
.analytics-container {
    background: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    padding: 25px;
    margin-bottom: 30px;
}

.charts-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 25px;
    margin-top: 20px;
}

#symptomsChartContainer {
    position: relative;
    height: 300px;
    width: 100%;
    min-height: 300px;
}

#symptomsChart {
    width: 100% !important;
    height: 300px !important;
}

.chart-container {
    position: relative;
    background: var(--white);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    height: 300px;
    display: flex;
    flex-direction: column;
}

.chart-title {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 15px;
    color: var(--dark);
    text-align: center;
    flex-shrink: 0;
}

/* ==========================================================================
   –õ–µ–≥–µ–Ω–¥–∞ —Å–∏–º–ø—Ç–æ–º–æ–≤
   ========================================================================== */
.symptoms-legend {
    background: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    padding: 20px;
    margin-bottom: 30px;
}

.legend-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    cursor: pointer;
}

.legend-header h4 {
    margin: 0;
    font-size: 16px;
    color: var(--dark);
    display: flex;
    align-items: center;
    gap: 10px;
}

.legend-toggle {
    background: none;
    border: none;
    font-size: 18px;
    color: var(--gray);
    cursor: pointer;
    transition: transform 0.3s;
    padding: 5px;
}

.legend-toggle:hover {
    color: var(--primary);
}

.legend-content {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
    transition: all 0.3s ease;
    max-height: 300px;
    overflow: hidden;
}

.legend-content.collapsed {
    max-height: 0;
    opacity: 0;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 12px;
    background: rgba(96, 244, 227, 0.08);
    border-radius: 10px;
    font-size: 14px;
    transition: all 0.2s;
    border: 1px solid transparent;
}

.legend-item:hover {
    background: rgba(96, 244, 227, 0.15);
    border-color: var(--primary);
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    flex-shrink: 0;
    border: 2px solid white;
    box-shadow: 0 0 4px rgba(0, 0, 0, 0.2);
}

.legend-name {
    flex-grow: 1;
    font-weight: 500;
    color: var(--dark);
}

.legend-count {
    font-weight: 600;
    color: var(--primary);
    min-width: 30px;
    text-align: right;
    font-size: 15px;
}

/* ==========================================================================
   –£—Ç–∏–ª–∏—Ç—ã –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
   ========================================================================== */
.loading {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100px;
}

.loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--primary);
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

.no-data {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--gray);
    text-align: center;
    padding: 20px;
}

.selected-date-display {
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* –í—ã–¥–µ–ª–µ–Ω–Ω—ã–π –¥–µ–Ω—å */
.calendar-day.selected {
    border: 3px solid var(--primary) !important;
    box-shadow: 0 0 0 3px rgba(96, 244, 227, 0.3) !important;
    transform: scale(1.05);
    z-index: 1;
}

.calendar-day.menstruation.selected {
    box-shadow: 0 0 0 3px rgba(96, 244, 227, 0.5), 
                0 6px 20px rgba(255, 107, 107, 0.4) !important;
}

    @media (max-width: 1024px) {

        /* –ü–ª–∞–Ω—à–µ—Ç—ã –∏ –º–∞–ª–µ–Ω—å–∫–∏–µ –Ω–æ—É—Ç–±—É–∫–∏ */
        main {
            padding: 25px 15px;
        }

        .tracker-container {
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .charts-grid {
            grid-template-columns: 1fr;
            gap: 20px;
        }

    }

    @media (max-width: 768px) {

        /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ö–µ–¥–µ—Ä –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ –∏ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ */
        body {
            padding-top: 60px;
            /* –£–º–µ–Ω—å—à–∏–ª–∏ –æ—Ç—Å—Ç—É–ø */
        }


        nav a.active {
            color: var(--dark);
        }


        /* –ü—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ (–µ—Å–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç hover) */
        @media (hover: hover) {
            nav a:hover::after {
                width: 100%;
            }
        }

        .user span {
            display: none;
            /* –°–∫—Ä—ã–≤–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
        }

        .user-avatar {
            width: 36px;
            height: 36px;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        main {
            padding: 20px 12px;
        }

        .page-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 24px;
            padding-bottom: 8px;
        }

        h1:after {
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
        }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ü–∏–∫–ª–∞ */
        .cycle-stats {
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            padding: 15px;
            border-radius: 14px;
        }

        .stat-title {
            font-size: 14px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 22px;
        }

        .stat-change {
            font-size: 13px;
        }

        /* –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Ü–∏–∫–ª–∞ */
        .cycle-calendar-container {
            padding: 20px;
            border-radius: 14px;
            margin-bottom: 25px;
        }

        .calendar-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 15px;
        }

        .calendar-title {
            font-size: 18px;
        }

        .calendar-controls {
            width: 100%;
            justify-content: space-between;
        }

        .today-btn {
            padding: 6px 12px;
            font-size: 14px;
        }

        .calendar-btn {
            width: 36px;
            height: 36px;
        }

        .weekdays {
            padding: 8px 0;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .weekday {
            padding: 8px 2px;
            font-size: 13px;
        }

        .calendar-grid {
            gap: 6px;
        }

        .calendar-day {
            min-height: 45px;
            border-radius: 10px;
            padding: 4px;
        }

        .day-number {
            font-size: 14px;
            margin-bottom: 3px;
        }

        .cycle-phase-dot {
            width: 6px;
            height: 6px;
        }

        /* –§–æ—Ä–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è */
        .tracker-form {
            padding: 20px;
            border-radius: 14px;
        }

        .mood-integration {
            padding: 20px;
            border-radius: 14px;
        }

        .section-title {
            font-size: 16px;
            margin-bottom: 12px;
        }

        .symptoms-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .symptom-checkbox {
            padding: 8px;
            font-size: 13px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            padding: 10px 12px;
            font-size: 14px;
            border-radius: 10px;
        }

        .mood-display {
            padding: 12px;
        }

        .mood-value {
            font-size: 28px;
        }

        .mood-emoji {
            font-size: 40px;
        }

        .btn {
            padding: 10px 20px;
            font-size: 14px;
            border-radius: 10px;
        }

        /* –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ */
        .analytics-container {
            padding: 20px;
            border-radius: 14px;
            margin-bottom: 25px;
        }

        .chart-container {
            height: 250px;
            padding: 15px;
        }

        .chart-title {
            font-size: 15px;
            margin-bottom: 12px;
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .toast {
            top: 70px;
            right: 10px;
            left: 10px;
            max-width: none;
            text-align: center;
            font-size: 13px;
            padding: 12px 16px;
        }

        /* –£–±–∏—Ä–∞–µ–º hover-—ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è —Ç–∞—á-—É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
        .calendar-day:hover,
        .stat-card:hover,
        .symptom-checkbox:hover,
        .btn:hover {
            transform: none;
            box-shadow: none;
            border-color: transparent;
        }

        .stat-card:hover {
            border-color: transparent;
        }

        .chart-container {
            height: 200px !important;
            padding: 10px;
        }

        /* –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ–¥–ø–∏—Å–µ–π –Ω–∞ –≥—Ä–∞—Ñ–∏–∫–∞—Ö */
        #symptomsChart {
            overflow-x: auto;
        }

        /* –î–µ–ª–∞–µ–º –ø–æ–¥–ø–∏—Å–∏ –∫–æ—Ä–æ—á–µ */
        .chart-title {
            font-size: 14px !important;
            text-align: center;
        }

        /* –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–∫–ª–æ–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∏ */
        #moodPhaseChart+.chartjs-render-monitor,
        #symptomsChart+.chartjs-render-monitor {
            max-width: 100% !important;
        }

        .legend-content {
            grid-template-columns: repeat(2, 1fr);
        }

        #symptomsChartContainer {
            height: 280px;
        }

        #symptomsChart {
            height: 250px !important;
        }

        .chart-container {
            height: 280px;
            padding: 15px;
        }
    }


    @media (max-width: 480px) {

        /* –ï—â–µ –±–æ–ª–µ–µ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ */
        body {
            padding-top: 55px;
        }

        main {
            padding: 15px 10px;
        }

        h1 {
            font-size: 22px;
            text-align: center;
            width: 100%;
        }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .cycle-stats {
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .stat-card {
            padding: 12px;
        }

        .stat-title {
            font-size: 13px;
        }

        .stat-value {
            font-size: 20px;
        }

        /* –ö–∞–ª–µ–Ω–¥–∞—Ä—å */
        .cycle-calendar-container {
            padding: 15px;
            border-radius: 12px;
        }

        .calendar-title {
            font-size: 16px;
        }

        .today-btn {
            padding: 5px 10px;
            font-size: 13px;
        }

        .calendar-btn {
            width: 32px;
            height: 32px;
        }

        .calendar-btn i {
            font-size: 12px;
        }

        .weekday {
            padding: 6px 1px;
            font-size: 12px;
        }

        .calendar-grid {
            gap: 4px;
        }

        .calendar-day {
            min-height: 40px;
            border-radius: 8px;
            padding: 3px;
        }

        .day-number {
            font-size: 13px;
        }

        /* –§–æ—Ä–º–∞ */
        .tracker-form,
        .mood-integration {
            padding: 15px;
        }

        .symptoms-grid {
            grid-template-columns: 1fr;
        }

        .section-title {
            font-size: 15px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            padding: 8px 10px;
            font-size: 13px;
        }

        .btn {
            padding: 8px 16px;
            font-size: 13px;
        }

        /* –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ */
        .analytics-container {
            padding: 15px;
        }

        .chart-container {
            height: 220px;
            padding: 12px;
        }

        .chart-container {
            height: 180px !important;
        }

        /* –£–±–∏—Ä–∞–µ–º –Ω–∞–∫–ª–æ–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∏ –Ω–∞ –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
        .chartjs-size-monitor,
        .chartjs-render-monitor {
            max-width: 100%;
            overflow: hidden;
        }

        /* –£–∫–æ—Ä–∞—á–∏–≤–∞–µ–º —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ */
        .chart-title {
            font-size: 13px !important;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

    }

    @media (max-width: 360px) {

        /* –û—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã */
        .calendar-day {
            min-height: 35px;
        }

        .day-number {
            font-size: 12px;
        }

        .stat-value {
            font-size: 18px;
        }

        .mood-value {
            font-size: 24px;
        }

        .mood-emoji {
            font-size: 36px;
        }
    }

    /* –õ–∞–Ω–¥—à–∞—Ñ—Ç–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è */
    @media (max-height: 500px) and (orientation: landscape) {

        .cycle-stats {
            grid-template-columns: repeat(4, 1fr);
        }

        .calendar-day {
            min-height: 35px;
        }

        .chart-container {
            height: 200px;
        }
    }


    /* –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø –î–õ–Ø –ì–†–ê–§–ò–ö–û–í (–î–û–ë–ê–í–¨ –≠–¢–û –í –ö–û–ù–ï–¶ –§–ê–ô–õ–ê) */
    .analytics-container {
        max-height: 500px;
        overflow-y: auto;
    }

    .charts-grid {
        min-height: 0;
        /* –í–∞–∂–Ω–æ –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–æ—Å—Ç–∞ */
    }

    .chart-container {
        height: 250px !important;
        min-height: 250px;
        max-height: 250px;
    }

    #moodPhaseChart,
    #symptomsChart {
        height: 250px !important;
        width: 100% !important;
        max-height: 250px !important;
    }
</style>
{% endblock %}


{% block content %}

<main>
    <div class="page-header">
        <h1>–î–Ω–µ–≤–Ω–∏–∫ —Ü–∏–∫–ª–∞</h1>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ü–∏–∫–ª–∞ -->
    <div class="cycle-stats">
        <div class="stat-card">
            <div class="stat-title">–¢–µ–∫—É—â–∏–π —Ü–∏–∫–ª</div>
            <div class="stat-value" id="cycleLength">28 –¥–Ω–µ–π</div>
            <div class="stat-change" id="cycleTrend">+2 –¥–Ω—è –∫ –ø—Ä–æ—à–ª–æ–º—É</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">–°–ª–µ–¥—É—é—â–∞—è –º–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏—è</div>
            <div class="stat-value" id="nextPeriod">—á–µ—Ä–µ–∑ 12 –¥–Ω–µ–π</div>
            <div class="stat-change" id="periodPrediction">–ü—Ä–æ–≥–Ω–æ–∑ —Ç–æ—á–Ω—ã–π</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">–§–µ—Ä—Ç–∏–ª—å–Ω–æ–µ –æ–∫–Ω–æ</div>
            <div class="stat-value" id="fertileWindow">—á–µ—Ä–µ–∑ 5 –¥–Ω–µ–π</div>
            <div class="stat-change" id="fertileStatus">–ù–∞—á–∏–Ω–∞–µ—Ç—Å—è</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">–°—Ä–µ–¥–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</div>
            <div class="stat-value" id="avgMoodCycle">7.2/10</div>
            <div class="stat-change" id="moodTrend">–õ—É—á—à–µ –Ω–∞ 0.5</div>
        </div>
    </div>

    <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Ü–∏–∫–ª–∞ -->
    <div class="cycle-calendar-container">
        <div class="calendar-header">
            <div class="calendar-title" id="monthYear">–î–µ–∫–∞–±—Ä—å 2024</div>
            <div class="calendar-controls">
                <button class="calendar-btn" onclick="changeMonth(-1)">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="today-btn" onclick="goToToday()">
                    –°–µ–≥–æ–¥–Ω—è
                </button>
                <button class="calendar-btn" onclick="changeMonth(1)">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>

        <div class="weekdays">
            <div class="weekday">–ü–Ω</div>
            <div class="weekday">–í—Ç</div>
            <div class="weekday">–°—Ä</div>
            <div class="weekday">–ß—Ç</div>
            <div class="weekday">–ü—Ç</div>
            <div class="weekday">–°–±</div>
            <div class="weekday">–í—Å</div>
        </div>

        <div class="calendar-grid" id="calendar">
            <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω JavaScript -->
        </div>
    </div>

    <!-- –§–û–†–ú–ê –û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–Ø -->
    <div class="tracker-container">
        <div class="tracker-form">
            <h3 class="section-title"><i class="fas fa-edit"></i> –û—Ç–º–µ—Ç–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è</h3>

            <!-- –ö–ù–û–ü–ö–ò –ú–ï–ù–°–¢–†–£–ê–¶–ò–ò -->
            <div class="form-section">
                <div class="quick-menstruation">
                    <button type="button" class="btn btn-menstruation" onclick="markMenstruationStart()">
                        <i class="fas fa-plus-circle"></i> –û—Ç–º–µ—Ç–∏—Ç—å –º–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏—é
                    </button>
                </div>
            </div>

            <!-- ‚úÖ –ë–õ–û–ö –° –°–ò–ú–ü–¢–û–ú–ê–ú–ò -->
            <div class="form-section">
                <div class="section-title">
                    <i class="fas fa-notes-medical"></i> –°–∏–º–ø—Ç–æ–º—ã
                </div>
                <div class="symptoms-grid" id="symptomsGrid"></div>
            </div>

            <!-- –ó–ê–ú–ï–¢–ö–ò -->
            <div class="form-section">
                <div class="section-title"><i class="fas fa-sticky-note"></i> –ó–∞–º–µ—Ç–∫–∏</div>
                <textarea id="cycleNotes" class="form-textarea"
                    placeholder="–ö–∞–∫ –≤—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—Ç–µ? –ß—Ç–æ –∑–∞–º–µ—Ç–∏–ª–∏?"></textarea>
            </div>

            <!-- –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–ô -->
            <div class="form-buttons">
                <button class="btn btn-primary" onclick="saveCycleEntry()">
                    <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å
                </button>
                <button class="btn btn-delete" onclick="clearSelectedDate()">
                    <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                </button>
            </div>
        </div>

        <div class="mood-integration">
            <h3 class="section-title"><i class="fas fa-chart-line"></i> –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è</h3>
            <div class="mood-display" id="todayMood">
                <div class="loading" id="moodLoading">
                    <div class="loading-spinner"></div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="goToMoodTracker()">
                <i class="fas fa-edit"></i> –û—Ç–º–µ—Ç–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
            </button>
        </div>
    </div>
    <!-- –ö–û–ù–ï–¶ –§–û–†–ú–´ –û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–Ø -->

    <!-- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
    <div class="analytics-container">
        <h3 class="section-title"><i class="fas fa-chart-bar"></i> –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ü–∏–∫–ª–∞</h3>
        <div class="charts-grid">
            <div class="chart-container" id="moodChartContainer">
                <div class="chart-title">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–æ —Ñ–∞–∑–∞–º —Ü–∏–∫–ª–∞</div>
                <canvas id="moodPhaseChart"></canvas>
                <div class="no-data" id="noMoodData" style="display: none;">
                    <i class="fas fa-chart-line" style="font-size: 40px; color: var(--gray); margin-bottom: 10px;"></i>
                    <p>–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞</p>
                    <p style="font-size: 12px;">–î–æ–±–∞–≤—å—Ç–µ –∑–∞–ø–∏—Å–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è</p>
                </div>
            </div>
            <div class="chart-container" id="symptomsChartContainer">
                <div class="chart-title">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∏–º–ø—Ç–æ–º–æ–≤</div>
                <canvas id="symptomsChart"></canvas>
                <div class="no-data" id="noSymptomsData" style="display: none;">
                    <i class="fas fa-chart-pie" style="font-size: 40px; color: var(--gray); margin-bottom: 10px;"></i>
                    <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–∏–º–ø—Ç–æ–º–∞—Ö</p>
                    <p style="font-size: 12px;">–û—Ç–º–µ—Ç—å—Ç–µ —Å–∏–º–ø—Ç–æ–º—ã –≤ –∑–∞–ø–∏—Å—è—Ö</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –õ–µ–≥–µ–Ω–¥–∞ —Å–∏–º–ø—Ç–æ–º–æ–≤ -->
    <div class="symptoms-legend">
        <div class="legend-header">
            <h4><i class="fas fa-info-circle"></i> –õ–µ–≥–µ–Ω–¥–∞ —Å–∏–º–ø—Ç–æ–º–æ–≤</h4>
            <button class="legend-toggle" onclick="toggleLegend()">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
        <div class="legend-content" id="symptomsLegend">
            <!-- –õ–µ–≥–µ–Ω–¥–∞ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ JavaScript -->
        </div>
    </div>
</main>

{% endblock %}
{% block extra_js %}
<script>

    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (—É–∂–µ –µ—Å—Ç—å, –Ω–æ –¥–æ–±–∞–≤–∏–º –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    window.showToast = showToast || function (message, type = 'success') {
        let toast = document.getElementById('toast');
        if (!toast) {
            toast = document.createElement('div');
            toast.id = 'toast';
            document.body.appendChild(toast);
        }

        toast.textContent = message;
        toast.className = `toast ${type === 'error' ? 'error' : ''} show`;

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode) {
                    document.body.removeChild(toast);
                }
            }, 300);
        }, 3000);
    };
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã API
    const CYCLE_API = "/api/cycle_entries";
    const MOOD_API = "/api/mood_entries";
    const TODAY_MOOD_API = "/api/today_mood";
    const CYCLE_STATS_API = "/api/cycle_stats";
    const CYCLE_PREDICTIONS_API = "/api/cycle_predictions";

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let currentDate = new Date();
    let cycleData = [];
    let moodData = [];
    let moodPhaseChart = null;
    let symptomsChart = null;
    let currentSelectedDate = null; // –í—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    let isEditMode = false; // –†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (true = —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É)
    let selectedAnalyticsMonth = null;
    let selectedAnalyticsYear = null;



    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', function () {
        console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–Ω–µ–≤–Ω–∏–∫–∞ —Ü–∏–∫–ª–∞...');
        initSymptomsGrid();
        loadInitialData();
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    async function loadInitialData() {
        try {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ —Ü–∏–∫–ª–∞ –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
            await loadCycleData();
            renderCalendar();

            // –û—Å—Ç–∞–ª—å–Ω–æ–µ –∑–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ–Ω–æ–º
            Promise.allSettled([
                loadMoodData(),
                loadCycleStats(),
                loadCyclePredictions(),
                loadTodayMood()
            ]);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
            showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ü–∏–∫–ª–∞
    async function loadCycleData() {
        try {
            const response = await fetch(CYCLE_API);
            console.log('üîç –ó–∞–ø—Ä–æ—Å –∫ CYCLE_API:', CYCLE_API, '–°—Ç–∞—Ç—É—Å:', response.status);

            if (response.ok) {
                cycleData = await response.json();
                console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —Ü–∏–∫–ª–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', cycleData.length, '–∑–∞–ø–∏—Å–µ–π');
            } else {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ü–∏–∫–ª–∞:', response.status);
            }
        } catch (error) {
            console.error('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ü–∏–∫–ª–∞:', error);
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
    async function loadMoodData() {
        try {
            const response = await fetch(MOOD_API);
            if (response.ok) {
                moodData = await response.json();
                console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è:', error);
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ü–∏–∫–ª–∞
    async function loadCycleStats() {
        try {
            const response = await fetch(CYCLE_STATS_API);
            if (response.ok) {
                const stats = await response.json();
                updateStatsDisplay(stats);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ü–∏–∫–ª–∞:', error);
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ —Ü–∏–∫–ª–∞
    async function loadCyclePredictions() {
        try {
            const response = await fetch(CYCLE_PREDICTIONS_API);
            if (response.ok) {
                const predictions = await response.json();
                updatePredictionsDisplay(predictions);
            } else {
                document.getElementById('nextPeriod').textContent = '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                document.getElementById('fertileWindow').textContent = '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ —Ü–∏–∫–ª–∞:', error);
            document.getElementById('nextPeriod').textContent = '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            document.getElementById('fertileWindow').textContent = '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
    async function loadTodayMood() {
        try {
            const response = await fetch(TODAY_MOOD_API);
            if (response.ok) {
                const todayMood = await response.json();
                updateTodayMoodDisplay(todayMood);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è:', error);
            updateTodayMoodDisplay(null);
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ç–∫–∏ —Å–∏–º–ø—Ç–æ–º–æ–≤
    function initSymptomsGrid() {
        const symptomsGrid = document.getElementById('symptomsGrid');
        if (!symptomsGrid) return;

        const defaultSymptoms = [
            '–ì–æ–ª–æ–≤–Ω–∞—è –±–æ–ª—å', '–°–ø–∞–∑–º—ã', '–£—Å—Ç–∞–ª–æ—Å—Ç—å', '–ù–∞–±—É—Ö–∞–Ω–∏–µ –≥—Ä—É–¥–∏',
            '–ü–µ—Ä–µ–ø–∞–¥—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è', '–¢—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å', '–í–∑–¥—É—Ç–∏–µ', '–ê–∫–Ω–µ',
            '–¢—è–≥–∞ –∫ —Å–ª–∞–¥–∫–æ–º—É', '–ë–µ—Å—Å–æ–Ω–Ω–∏—Ü–∞', '–¢–æ—à–Ω–æ—Ç–∞', '–ë–æ–ª—å –≤ —Å–ø–∏–Ω–µ'
        ];

        symptomsGrid.innerHTML = defaultSymptoms.map(symptom => `
        <label class="symptom-checkbox">
            <input type="checkbox" name="symptoms" value="${symptom}">
            ${symptom}
        </label>
    `).join('');
    }

    // –†–µ–Ω–¥–µ—Ä –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    function renderCalendar() {
        const calendar = document.getElementById('calendar');
        const monthYear = document.getElementById('monthYear');

        if (!calendar || !monthYear) {
            console.error('‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω—ã —ç–ª–µ–º–µ–Ω—Ç—ã –∫–∞–ª–µ–Ω–¥–∞—Ä—è');
            return;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        const monthNames = [
            '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
            '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
        ];
        monthYear.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;

        // –û—á–∏—â–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
        calendar.innerHTML = '';

        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        // –ü–µ—Ä–≤—ã–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞
        const firstDay = new Date(year, month, 1);
        // –ü–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞
        const lastDay = new Date(year, month + 1, 0);
        // –î–Ω–µ–π –≤ –º–µ—Å—è—Ü–µ
        const daysInMonth = lastDay.getDate();

        // –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è (1 = –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, 7 = –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ)
        let startDay = firstDay.getDay();
        if (startDay === 0) startDay = 7;

        // –î–Ω–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
        const prevMonthDays = new Date(year, month, 0).getDate();
        for (let i = startDay - 1; i > 0; i--) {
            const day = createDayElement(prevMonthDays - i + 1, 'other-month', true);
            calendar.appendChild(day);
        }

        // –î–Ω–∏ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
        const today = new Date();
        for (let i = 1; i <= daysInMonth; i++) {
            const date = new Date(year, month, i);
            const dateStr = formatDate(date);
            const day = createDayElement(i, '', false);

            // –û—Ç–º–µ—á–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å
            if (today.getDate() === i && today.getMonth() === month && today.getFullYear() === year) {
                day.classList.add('current-day');
            }

            // –ù–∞—Ö–æ–¥–∏–º –∑–∞–ø–∏—Å—å –æ —Ü–∏–∫–ª–µ –¥–ª—è —ç—Ç–æ–π –¥–∞—Ç—ã
            const cycleEntry = cycleData.find(entry => entry && entry.date === dateStr);

            if (cycleEntry) {
                // –û–¢–î–ï–õ–¨–ù–û –ø—Ä–æ–≤–µ—Ä—è–µ–º –º–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏—é –∏ —Å–∏–º–ø—Ç–æ–º—ã

                // 1. –ú–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏—è
                const hasMenstruation = cycleEntry.flow_intensity &&
                    cycleEntry.flow_intensity !== 'none' &&
                    cycleEntry.flow_intensity !== '';

                // 2. –°–∏–º–ø—Ç–æ–º—ã
                const symptoms = cycleEntry.symptoms || [];
                const hasSymptoms = symptoms.length > 0;

                // –ï—Å–ª–∏ –µ—Å—Ç—å –º–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏—è - –¥–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å
                if (hasMenstruation) {
                    day.classList.add('menstruation');

                    // –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤ —Ç–µ–∫—Å—Ç
                    const menstruationIndicator = document.createElement('div');
                    menstruationIndicator.className = 'menstruation-indicator';
                    menstruationIndicator.style.cssText = `
                    position: absolute;
                    top: 2px;
                    right: 2px;
                    font-size: 10px;
                    z-index: 3;
                `;
                    day.appendChild(menstruationIndicator);
                }

                // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–∏–º–ø—Ç–æ–º—ã - –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏—Ö (–¥–∞–∂–µ –µ—Å–ª–∏ –µ—Å—Ç—å –º–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏—è)
                if (hasSymptoms) {
                    const symptomsContainer = document.createElement('div');
                    symptomsContainer.className = 'symptoms-dots-compact';
                    symptomsContainer.style.cssText = `
                    position: relative;
                    z-index: ${hasMenstruation ? '2' : '1'};
                    display: flex;
                    flex-wrap: wrap;
                    gap: 1px;
                    margin-top: ${hasMenstruation ? '15px' : '3px'};
                    justify-content: center;
                `;

                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö —Ç–æ—á–µ–∫, –µ—Å–ª–∏ –∏—Ö –º–Ω–æ–≥–æ
                    const maxDots = hasMenstruation ? 6 : 8; // –ü—Ä–∏ –º–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—å—à–µ —Ç–æ—á–µ–∫

                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Å–µ —Å–∏–º–ø—Ç–æ–º—ã –∫–∞–∫ —Ä–∞–∑–Ω–æ—Ü–≤–µ—Ç–Ω—ã–µ —Ç–æ—á–∫–∏
                    symptoms.slice(0, maxDots).forEach(symptom => {
                        const dot = document.createElement('div');
                        dot.className = 'symptom-dot-compact';
                        dot.style.cssText = `
                        width: 4px;
                        height: 4px;
                        border-radius: 50%;
                        background: ${getSymptomColor(symptom)};
                        ${hasMenstruation ? 'box-shadow: 0 0 2px white;' : ''}
                    `;
                        dot.title = symptom; // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
                        symptomsContainer.appendChild(dot);
                    });

                    // –ï—Å–ª–∏ —Å–∏–º–ø—Ç–æ–º–æ–≤ –±–æ–ª—å—à–µ, —á–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º - –¥–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                    if (symptoms.length > maxDots) {
                        const moreIndicator = document.createElement('div');
                        moreIndicator.className = 'more-symptoms';
                        moreIndicator.textContent = `+${symptoms.length - maxDots}`;
                        moreIndicator.style.cssText = `
                        font-size: 8px;
                        color: ${hasMenstruation ? 'white' : '#666'};
                        margin-left: 1px;
                        font-weight: bold;
                    `;
                        moreIndicator.title = `–ï—â–µ ${symptoms.length - maxDots} —Å–∏–º–ø—Ç–æ–º–æ–≤`;
                        symptomsContainer.appendChild(moreIndicator);
                    }

                    day.appendChild(symptomsContainer);

                    // –î–æ–±–∞–≤–ª—è–µ–º —Ç—É–ª—Ç–∏–ø —Å–æ –≤—Å–µ–º–∏ —Å–∏–º–ø—Ç–æ–º–∞–º–∏
                    const tooltip = document.createElement('div');
                    tooltip.className = 'symptoms-tooltip';

                    if (symptoms.length > 5) {
                        tooltip.classList.add('has-many-items');
                        symptoms.forEach(symptom => {
                            const symptomItem = document.createElement('div');
                            symptomItem.className = 'symptom-item';

                            const colorDot = document.createElement('div');
                            colorDot.className = 'symptom-color';
                            colorDot.style.background = getSymptomColor(symptom);

                            const nameSpan = document.createElement('span');
                            nameSpan.className = 'symptom-name';
                            nameSpan.textContent = symptom;

                            symptomItem.appendChild(colorDot);
                            symptomItem.appendChild(nameSpan);
                            tooltip.appendChild(symptomItem);
                        });
                    } else {
                        tooltip.textContent = symptoms.join(', ');
                    }

                    day.appendChild(tooltip);
                }
            }

            // –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –¥–µ–Ω—å –æ—Ç–∫—Ä—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏
            day.addEventListener('click', function () {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç–∞ –Ω–µ –≤ –±—É–¥—É—â–µ–º
                if (!isValidDateForEntry(dateStr)) {
                    showToast('–ù–µ–ª—å–∑—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±—É–¥—É—â–∏–µ –¥–Ω–∏', 'error');
                    return;
                }

                // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–Ω—è
                document.querySelectorAll('.calendar-day.selected').forEach(day => {
                    day.classList.remove('selected');
                });

                // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–º—É –¥–Ω—é
                day.classList.add('selected');

                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –¥–Ω—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                openDayDetail(dateStr);
            });

            calendar.appendChild(day);
        }

        // –î–Ω–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞
        const totalCells = 35;
        const filledCells = startDay - 1 + daysInMonth;
        if (filledCells < totalCells) {
            for (let i = 1; i <= totalCells - filledCells; i++) {
                const day = createDayElement(i, 'other-month', true);
                calendar.appendChild(day);
            }
        }

        console.log('‚úÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω');
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –¥–Ω—è
    function createDayElement(dayNumber, className, isOtherMonth) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';

        if (className) {
            dayElement.classList.add(className);
        }

        const numberElement = document.createElement('div');
        numberElement.className = 'day-number';
        numberElement.textContent = dayNumber;

        dayElement.appendChild(numberElement);

        if (isOtherMonth) {
            dayElement.style.cursor = 'default';
            dayElement.style.pointerEvents = 'none';
            dayElement.style.opacity = '0.5';
        }

        return dayElement;
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–∏–º–ø—Ç–æ–º–æ–≤ –¥–ª—è –¥–∞—Ç—ã
    function getSymptomsForDate(dateStr) {
        if (!dateStr || !cycleData || !Array.isArray(cycleData)) return [];

        const entry = cycleData.find(entry => entry && entry.date === dateStr);
        return entry ? (entry.symptoms || []) : [];
    }

    // –¶–≤–µ—Ç –¥–ª—è —Å–∏–º–ø—Ç–æ–º–∞
    function getSymptomColor(symptom) {
        const colorMap = {
            '–ì–æ–ª–æ–≤–Ω–∞—è –±–æ–ª—å': '#FF6B6B',
            '–°–ø–∞–∑–º—ã': '#FF70EC',
            '–£—Å—Ç–∞–ª–æ—Å—Ç—å': '#60F4E3',
            '–ù–∞–±—É—Ö–∞–Ω–∏–µ –≥—Ä—É–¥–∏': '#FFD166',
            '–ü–µ—Ä–µ–ø–∞–¥—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è': '#B8B3E9',
            '–¢—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å': '#FFA502',
            '–í–∑–¥—É—Ç–∏–µ': '#2ed573',
            '–ê–∫–Ω–µ': '#ff4757',
            '–¢—è–≥–∞ –∫ —Å–ª–∞–¥–∫–æ–º—É': '#ff9ff3',
            '–ë–µ—Å—Å–æ–Ω–Ω–∏—Ü–∞': '#54a0ff',
            '–¢–æ—à–Ω–æ—Ç–∞': '#00d2d3',
            '–ë–æ–ª—å –≤ —Å–ø–∏–Ω–µ': '#f368e0',
            '–†–∞–∑–¥—Ä–∞–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å': '#ff9f43',
            '–ü–æ–≤—ã—à–µ–Ω–Ω—ã–π –∞–ø–ø–µ—Ç–∏—Ç': '#ee5253',
            '–ü–ª–∞–∫—Å–∏–≤–æ—Å—Ç—å': '#0abde3',
            '–û—Ç–µ–∫–∏': '#10ac84',
            '–ì–æ–ª–æ–≤–æ–∫—Ä—É–∂–µ–Ω–∏–µ': '#5f27cd',
            '–°–æ–Ω–ª–∏–≤–æ—Å—Ç—å': '#8395a7'
        };

        // –ï—Å–ª–∏ —Å–∏–º–ø—Ç–æ–º –Ω–µ –≤ —Å–ø–∏—Å–∫–µ, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ü–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ö–µ—à–∞
        if (!colorMap[symptom]) {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ü–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Å–∏–º–ø—Ç–æ–º–∞
            let hash = 0;
            for (let i = 0; i < symptom.length; i++) {
                hash = symptom.charCodeAt(i) + ((hash << 5) - hash);
            }

            const colors = [
                '#FF6B6B', '#FF70EC', '#60F4E3', '#FFD166', '#B8B3E9',
                '#FFA502', '#2ed573', '#ff4757', '#ff9ff3', '#54a0ff',
                '#00d2d3', '#f368e0', '#ff9f43', '#ee5253', '#0abde3',
                '#10ac84', '#5f27cd', '#8395a7', '#ff9f43', '#ee5253'
            ];

            const index = Math.abs(hash) % colors.length;
            colorMap[symptom] = colors[index];
        }

        return colorMap[symptom];
    }
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
    function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º
    function changeMonth(step) {
        currentDate.setMonth(currentDate.getMonth() + step);
        renderCalendar();
    }

    function goToToday() {
        currentDate = new Date();
        renderCalendar();

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É
        currentSelectedDate = null;
        isEditMode = false;

        // –£–¥–∞–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã –µ—Å–ª–∏ –µ—Å—Ç—å
        const dateDisplay = document.querySelector('.selected-date-display');
        if (dateDisplay) dateDisplay.remove();

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ñ–æ—Ä–º—ã
        const formTitle = document.querySelector('.tracker-form h3');
        if (formTitle) {
            formTitle.innerHTML = `<i class="fas fa-edit"></i> –û—Ç–º–µ—Ç–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è`;
        }

        // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
        clearForm();

        showToast('–ü–µ—Ä–µ—à–ª–∏ –∫ —Ç–µ–∫—É—â–µ–º—É –º–µ—Å—è—Ü—É', 'info');
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    function updateStatsDisplay(stats) {
        if (stats && stats.avg_mood) {
            document.getElementById('avgMoodCycle').textContent = `${parseFloat(stats.avg_mood).toFixed(1)}/10`;
        }
        if (stats && stats.total_entries) {
            document.getElementById('cycleLength').textContent = `${stats.total_entries} –∑–∞–ø–∏—Å–µ–π`;
        }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–≥–Ω–æ–∑–æ–≤
    function updatePredictionsDisplay(predictions) {
        if (!predictions || predictions.error) return;

        if (predictions.next_period) {
            const nextPeriod = new Date(predictions.next_period);
            const today = new Date();
            const daysDiff = Math.ceil((nextPeriod - today) / (1000 * 60 * 60 * 24));
            if (daysDiff > 0) {
                document.getElementById('nextPeriod').textContent = `—á–µ—Ä–µ–∑ ${daysDiff} –¥–Ω–µ–π`;
            } else if (daysDiff === 0) {
                document.getElementById('nextPeriod').textContent = '—Å–µ–≥–æ–¥–Ω—è';
            } else {
                document.getElementById('nextPeriod').textContent = `${Math.abs(daysDiff)} –¥–Ω–µ–π –Ω–∞–∑–∞–¥`;
            }
        }

        if (predictions.current_cycle_day) {
            document.getElementById('cycleLength').textContent = `${predictions.current_cycle_day} –¥–µ–Ω—å`;
        }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
    function updateTodayMoodDisplay(moodData) {
        const moodDisplay = document.getElementById('todayMood');
        const moodLoading = document.getElementById('moodLoading');

        if (moodLoading) {
            moodLoading.style.display = 'none';
        }

        if (moodData && moodData.mood !== undefined && moodData.mood !== null) {
            const emoji = getMoodEmoji(moodData.mood);
            moodDisplay.innerHTML = `
            <div class="mood-value">${moodData.mood}/10</div>
            <div class="mood-emoji">${emoji}</div>
            <div class="mood-note">${moodData.note || '–ë–µ–∑ –∑–∞–º–µ—Ç–∫–∏'}</div>
        `;
        } else {
            moodDisplay.innerHTML = `
            <div class="mood-value">-/-</div>
            <div class="mood-emoji">üòê</div>
            <div class="mood-note">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –Ω–µ –æ—Ç–º–µ—á–µ–Ω–æ</div>
        `;
        }
    }

    function getMoodEmoji(moodValue) {
        if (moodValue >= 8) return 'üòä';
        if (moodValue >= 5) return 'üòê';
        if (moodValue >= 3) return 'üòï';
        return 'üòû';
    }

    async function saveCycleEntry() {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∞—Ç—É
        let dateStr;
        if (currentSelectedDate && isEditMode) {
            dateStr = currentSelectedDate;
        } else {
            dateStr = formatDate(new Date());
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç–∞ –Ω–µ –≤ –±—É–¥—É—â–µ–º
        const selected = new Date(dateStr);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (selected > today) {
            showToast('–ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å –≤ –±—É–¥—É—â–µ–º', 'error');
            return;
        }

        // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Å–∏–º–ø—Ç–æ–º—ã
        const selectedSymptoms = Array.from(
            document.querySelectorAll('input[name="symptoms"]:checked')
        ).map(cb => cb.value);

        // –ü–æ–ª—É—á–∞–µ–º –∑–∞–º–µ—Ç–∫–∏
        const notes = document.getElementById('cycleNotes').value.trim();

        // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
        const uniqueSymptoms = [...new Set(selectedSymptoms)];

        // –ü–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å
        const existingEntry = cycleData.find(entry => entry.date === dateStr);

        try {
            // –ï—Å–ª–∏ –µ—Å—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –∑–∞–ø–∏—Å—å - –æ–±–Ω–æ–≤–ª—è–µ–º –µ—ë
            if (existingEntry) {
                // –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å–∏–º–ø—Ç–æ–º—ã (—Å—Ç–∞—Ä—ã–µ + –Ω–æ–≤—ã–µ)
                const existingSymptoms = existingEntry.symptoms || [];
                const allSymptoms = [...new Set([...existingSymptoms, ...uniqueSymptoms])];

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º flow_intensity –∏–∑ —Å—Ç–∞—Ä–æ–π –∑–∞–ø–∏—Å–∏
                const flowIntensity = existingEntry.flow_intensity || 'none';

                const response = await fetch(`${CYCLE_API}/${dateStr}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symptoms: allSymptoms,
                        flow_intensity: flowIntensity, // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏—é!
                        notes: notes || existingEntry.notes
                    })
                });

                if (response.ok) {
                    showToast('–ó–∞–ø–∏—Å—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞!', 'success');
                    await loadCycleData();
                    renderCalendar();
                    await updateAnalytics();
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏');
                }
            } else {
                // –ï—Å–ª–∏ –∑–∞–ø–∏—Å–∏ –Ω–µ—Ç - —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é
                if (!uniqueSymptoms.length && !notes) {
                    showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–ª–µ', 'error');
                    return;
                }

                const response = await fetch(CYCLE_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date: dateStr,
                        symptoms: uniqueSymptoms,
                        flow_intensity: 'none', // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–µ—Ç –º–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏–∏
                        notes: notes
                    })
                });

                if (response.ok) {
                    showToast('–ó–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!', 'success');
                    await loadCycleData();
                    renderCalendar();
                    clearForm();
                    await updateAnalytics();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                }
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏: ' + error.message, 'error');
        }
    }

    // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã
    function clearForm() {
        // –°–Ω–∏–º–∞–µ–º –≤—Å–µ –≥–∞–ª–æ—á–∫–∏ —Å–∏–º–ø—Ç–æ–º–æ–≤
        document.querySelectorAll('input[name="symptoms"]:checked').forEach(checkbox => {
            checkbox.checked = false;
        });

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏—è
        document.getElementById('flowLevel').value = '';

        // –û—á–∏—â–∞–µ–º –∑–∞–º–µ—Ç–∫–∏
        document.getElementById('cycleNotes').value = '';
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    async function updateAnalytics() {
        try {
            await Promise.all([
                loadMoodData(),
                loadCycleStats(),
                loadCyclePredictions(),
                loadTodayMood()
            ]);

            if (typeof updateChartsWithRealData === 'function') {
                updateChartsWithRealData();
            }

            const statsResponse = await fetch(CYCLE_STATS_API);
            if (statsResponse.ok) {
                const stats = await statsResponse.json();
                updateStatsDisplay(stats);
            }
        } catch (updateError) {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:', updateError);
        }
    }

    // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ç—Ä–µ–∫–µ—Ä—É –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
    function goToMoodTracker() {
        window.location.href = "/calendar";
    }

    // –û—Ç–∫—Ä—ã—Ç–∏–µ –¥–µ—Ç–∞–ª–µ–π –¥–Ω—è
    function openDayDetail(dateStr) {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–ø–ª—ã–≤–∞—à–∫—É —Å –¥–∞—Ç–æ–π
        showToast(`–î–µ–Ω—å ${dateStr}`, 'info');
        const d = new Date(dateStr);
        selectedAnalyticsMonth = d.getMonth(); // 0-11
        selectedAnalyticsYear = d.getFullYear();

        updateChartsWithRealData();
    }

    // –£—Ç–∏–ª–∏—Ç—ã
    function showToast(message, type = 'success') {
        let toast = document.getElementById('toast');
        if (!toast) {
            toast = document.createElement('div');
            toast.id = 'toast';
            document.body.appendChild(toast);
        }

        toast.textContent = message;
        toast.className = `toast ${type === 'error' ? 'error' : ''} show`;

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode) {
                    document.body.removeChild(toast);
                }
            }, 300);
        }, 3000);
    }

    // –ü—Ä–æ—Å—Ç–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
    console.log('üìÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–Ω–µ–≤–Ω–∏–∫–∞ —Ü–∏–∫–ª–∞...');


    function initCharts() {
        // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
        setTimeout(() => {
            updateChartsWithRealData();
        }, 500);
    }

    function updateChartsWithRealData() {

        let filteredCycleData = cycleData;

        if (selectedAnalyticsMonth !== null && selectedAnalyticsYear !== null) {
            filteredCycleData = cycleData.filter(entry => {
                const d = new Date(entry.date);
                return (
                    d.getMonth() === selectedAnalyticsMonth &&
                    d.getFullYear() === selectedAnalyticsYear
                );
            });
        }


        // –°–∫—Ä—ã–≤–∞–µ–º "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö" –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        const noMoodData = document.getElementById('noMoodData');
        const noSymptomsData = document.getElementById('noSymptomsData');

        // –ì—Ä–∞—Ñ–∏–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –ø–æ —Ñ–∞–∑–∞–º
        const moodChartData = calculateRealMoodByPhase();
        const moodCtx = document.getElementById('moodPhaseChart');

        if (moodCtx && moodChartData.hasData) {
            if (noMoodData) noMoodData.style.display = 'none';

            // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            if (moodPhaseChart) {
                moodPhaseChart.destroy();
            }

            moodPhaseChart = new Chart(moodCtx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: moodChartData.labels,
                    datasets: [{
                        label: '–°—Ä–µ–¥–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ',
                        data: moodChartData.values,
                        borderColor: 'rgb(96, 244, 227)',
                        backgroundColor: 'rgba(96, 244, 227, 0.1)',
                        tension: 0.3,
                        fill: true,
                        borderWidth: 3,
                        pointBackgroundColor: 'rgb(96, 244, 227)',
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: ${context.raw}/10`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10,
                            min: 0,
                            title: {
                                display: true,
                                text: '–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ (0-10)'
                            },
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '–§–∞–∑–∞ —Ü–∏–∫–ª–∞'
                            }
                        }
                    }
                }
            });
        } else {
            if (noMoodData) noMoodData.style.display = 'flex';
        }

        // –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–∏–º–ø—Ç–æ–º–æ–≤ - –ê–î–ê–ü–¢–ò–í–ù–´–ô –ë–ï–ó –ü–†–û–ö–†–£–¢–ö–ò
        const symptomsData = calculateRealSymptomFrequency(filteredCycleData);
        const symptomsCtx = document.getElementById('symptomsChart');

        if (symptomsCtx && symptomsData.hasData) {
            if (noSymptomsData) noSymptomsData.style.display = 'none';

            // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            if (symptomsChart) {
                symptomsChart.destroy();
            }

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –∏ –ø–æ–≤–æ—Ä–æ—Ç –ø–æ–¥–ø–∏—Å–µ–π
            const symptomsCount = symptomsData.labels.length;
            const fontSize = Math.max(10, Math.min(14, 14 - (symptomsCount - 5) * 0.5));
            const rotation = symptomsCount > 8 ? 45 : 0;

            symptomsChart = new Chart(symptomsCtx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: symptomsData.labels,
                    datasets: [{
                        label: '–ß–∞—Å—Ç–æ—Ç–∞ —Å–∏–º–ø—Ç–æ–º–æ–≤',
                        data: symptomsData.values,
                        backgroundColor: symptomsData.colors,
                        borderColor: symptomsData.borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `${context.label}: ${context.raw} —Ä–∞–∑`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π'
                            },
                            ticks: {
                                precision: 0
                            }
                        },
                        x: {
                            ticks: {
                                autoSkip: false,
                                maxRotation: rotation,
                                minRotation: rotation,
                                font: {
                                    size: fontSize
                                }
                            }
                        }
                    },
                    layout: {
                        padding: {
                            left: 10,
                            right: 10,
                            top: 10,
                            bottom: symptomsCount > 10 ? 50 : 30
                        }
                    },
                    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å—Ç–æ–ª–±—Ü–æ–≤
                    barPercentage: symptomsCount > 15 ? 0.8 : 0.9,
                    categoryPercentage: symptomsCount > 15 ? 0.7 : 0.8
                }
            });
        } else {
            if (noSymptomsData) noSymptomsData.style.display = 'flex';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –ø–æ —Ñ–∞–∑–∞–º
    function calculateRealMoodByPhase() {
        if (!moodData || moodData.length === 0) {
            return { hasData: false };
        }

        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –ø–æ —Ñ–∞–∑–∞–º (–¥–ª—è –¥–µ–º–æ - —Ñ–∞–∑—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –ø–æ –¥–Ω—é —Ü–∏–∫–ª–∞)
        const phaseMoods = {
            follicular: [],
            ovulation: [],
            luteal: [],
            menstruation: []
        };

        // –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞: –¥–µ–Ω—å —Ü–∏–∫–ª–∞ 1-7 = –º–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏—è, 8-13 = —Ñ–æ–ª–ª–∏–∫—É–ª—è—Ä–Ω–∞—è, 
        // 14 = –æ–≤—É–ª—è—Ü–∏—è, 15-28 = –ª—é—Ç–µ–∏–Ω–æ–≤–∞—è
        moodData.forEach(entry => {
            if (entry.date && entry.mood !== undefined) {
                const date = new Date(entry.date);
                const dayOfMonth = date.getDate();

                if (dayOfMonth <= 7) {
                    phaseMoods.menstruation.push(entry.mood);
                } else if (dayOfMonth <= 13) {
                    phaseMoods.follicular.push(entry.mood);
                } else if (dayOfMonth === 14) {
                    phaseMoods.ovulation.push(entry.mood);
                } else {
                    phaseMoods.luteal.push(entry.mood);
                }
            }
        });

        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
        const calculateAverage = (arr) => {
            if (arr.length === 0) return null;
            const sum = arr.reduce((a, b) => a + b, 0);
            return parseFloat((sum / arr.length).toFixed(1));
        };

        const follicularAvg = calculateAverage(phaseMoods.follicular);
        const ovulationAvg = calculateAverage(phaseMoods.ovulation);
        const lutealAvg = calculateAverage(phaseMoods.luteal);
        const menstruationAvg = calculateAverage(phaseMoods.menstruation);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ —Ñ–∞–∑–∞ —Å –¥–∞–Ω–Ω—ã–º–∏
        const hasValidData = [follicularAvg, ovulationAvg, lutealAvg, menstruationAvg]
            .some(avg => avg !== null);

        if (!hasValidData) {
            return { hasData: false };
        }

        return {
            hasData: true,
            labels: ['–§–æ–ª–ª–∏–∫—É–ª—è—Ä–Ω–∞—è', '–û–≤—É–ª—è—Ü–∏—è', '–õ—é—Ç–µ–∏–Ω–æ–≤–∞—è', '–ú–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏—è'],
            values: [
                follicularAvg || 0,
                ovulationAvg || 0,
                lutealAvg || 0,
                menstruationAvg || 0
            ]
        };
    }

    function calculateRealSymptomFrequency(data) {
        if (!data || data.length === 0) {
            return { hasData: false };
        }

        const symptomCounts = {};

        data.forEach(entry => {
            (entry.symptoms || []).forEach(symptom => {
                symptomCounts[symptom] = (symptomCounts[symptom] || 0) + 1;
            });
        });

        const labels = Object.keys(symptomCounts);
        const values = Object.values(symptomCounts);

        if (labels.length === 0) {
            return { hasData: false };
        }

        return {
            hasData: true,
            labels: labels,
            values: values,
            colors: labels.map(getSymptomColor),
            borderColors: labels.map(getSymptomColor)
        };
    }


    // –û—Ç–∫—Ä—ã—Ç–∏–µ –¥–µ—Ç–∞–ª–µ–π –¥–Ω—è —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    async function openDayDetail(dateStr) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç–∞ –Ω–µ –≤ –±—É–¥—É—â–µ–º
        if (!isValidDateForEntry(dateStr)) {
            showToast('–ù–µ–ª—å–∑—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±—É–¥—É—â–∏–µ –¥–Ω–∏', 'error');
            return;
        }

        console.log('üìÖ –û—Ç–∫—Ä—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –¥–Ω—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', dateStr);

        currentSelectedDate = dateStr;
        isEditMode = true;

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç—Ç–æ–π –¥–∞—Ç—ã
        const existingEntry = await loadDayEntry(dateStr);

        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏
        fillFormWithData(dateStr, existingEntry);

        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ñ–æ—Ä–º–µ
        document.querySelector('.tracker-form').scrollIntoView({
            behavior: 'smooth',
            block: 'start'
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        showToast(`–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–Ω—è ${formatDateDisplay(dateStr)}`, 'info');
    }

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    function formatDateDisplay(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('ru-RU', {
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        });
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –¥–∞—Ç–∞ –Ω–µ –≤ –±—É–¥—É—â–µ–º
    function isValidDateForEntry(dateStr) {
        try {
            const selectedDate = new Date(dateStr);
            const today = new Date();

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–∞—Ç
            selectedDate.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);

            return selectedDate <= today;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞—Ç—ã:', error);
            return false;
        }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–ø–∏—Å–∏ –¥–Ω—è
    async function loadDayEntry(dateStr) {
        try {
            const response = await fetch(`${CYCLE_API}?date=${dateStr}`);
            if (response.ok) {
                const entries = await response.json();
                return entries.length > 0 ? entries[0] : null;
            }
            return null;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–∏:', error);
            return null;
        }
    }

    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã –¥–∞–Ω–Ω—ã–º–∏
    function fillFormWithData(dateStr, entry) {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ñ–æ—Ä–º—ã
        const formTitle = document.querySelector('.tracker-form h3');
        if (formTitle) {
            formTitle.innerHTML = `<i class="fas fa-edit"></i>  ${formatDateDisplay(dateStr)}`;
        }

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
        clearForm();

        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        if (entry) {
            // –°–∏–º–ø—Ç–æ–º—ã
            if (entry.symptoms && Array.isArray(entry.symptoms)) {
                entry.symptoms.forEach(symptom => {
                    const checkbox = Array.from(document.querySelectorAll('input[name="symptoms"]'))
                        .find(cb => cb.value === symptom);
                    if (checkbox) checkbox.checked = true;
                });
            }

            // –í—ã–¥–µ–ª–µ–Ω–∏—è
            const flowSelect = document.getElementById('flowLevel');
            if (flowSelect && entry.flow_intensity) {
                flowSelect.value = entry.flow_intensity;
            }

            // –ó–∞–º–µ—Ç–∫–∏
            const notesTextarea = document.getElementById('cycleNotes');
            if (notesTextarea && entry.notes) {
                notesTextarea.value = entry.notes;
            }
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –£–¥–∞–ª–∏—Ç—å
    function clearSelectedDate() {
        if (!currentSelectedDate) {
            showToast('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ', 'error');
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∑–∞–ø–∏—Å—å –¥–ª—è —ç—Ç–æ–π –¥–∞—Ç—ã
        const existingEntry = cycleData.find(entry => entry.date === currentSelectedDate);

        if (existingEntry) {
            // –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø–∏—Å—å - —É–¥–∞–ª—è–µ–º
            deleteCycleEntry();
        } else {
            // –ï—Å–ª–∏ –∑–∞–ø–∏—Å–∏ –Ω–µ—Ç - –ø—Ä–æ—Å—Ç–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
            resetToToday();
            showToast('–§–æ—Ä–º–∞ –æ—á–∏—â–µ–Ω–∞', 'info');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ –∫ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç–µ
    function resetToToday() {
        console.log('üîÑ –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É...');

        // –°–±—Ä–æ—Å –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
        currentSelectedDate = null;
        isEditMode = false;

        // ‚úÖ –£–±–∏—Ä–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞—Ç—ã –µ—Å–ª–∏ –æ—Å—Ç–∞–ª–æ—Å—å
        const dateDisplay = document.querySelector('.selected-date-display');
        if (dateDisplay) {
            dateDisplay.remove();
            console.log('üóëÔ∏è –£–¥–∞–ª–µ–Ω –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞—Ç—ã');
        }

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ñ–æ—Ä–º—ã
        const formTitle = document.querySelector('.tracker-form h3');
        if (formTitle) {
            formTitle.innerHTML = `<i class="fas fa-edit"></i> –û—Ç–º–µ—Ç–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è`;
            console.log('üìù –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∑–∞–≥–æ–ª–æ–≤–æ–∫');
        }

        // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        document.querySelectorAll('.calendar-day.selected').forEach(day => {
            day.classList.remove('selected');
        });

        // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
        clearForm();

        showToast('–í—ã–±—Ä–∞–Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω—è—è –¥–∞—Ç–∞', 'info');
        console.log('‚úÖ –°–±—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω');
    }

    async function markMenstruationStart() {
        let targetDate;

        // –ï—Å–ª–∏ –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë, –∏–Ω–∞—á–µ - —Å–µ–≥–æ–¥–Ω—è
        if (currentSelectedDate) {
            targetDate = currentSelectedDate;
        } else {
            targetDate = formatDate(new Date());
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç–∞ –Ω–µ –≤ –±—É–¥—É—â–µ–º
        if (!isValidDateForEntry(targetDate)) {
            showToast('–ù–µ–ª—å–∑—è –æ—Ç–º–µ—Ç–∏—Ç—å –º–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏—é –≤ –±—É–¥—É—â–µ–º', 'error');
            return;
        }

        // –ü–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å
        const existingEntry = cycleData.find(entry => entry.date === targetDate);

        try {
            if (existingEntry) {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å
                const response = await fetch(`${CYCLE_API}/${targetDate}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symptoms: existingEntry.symptoms || [], // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–∏–º–ø—Ç–æ–º—ã!
                        flow_intensity: 'medium', // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏—é
                        notes: existingEntry.notes || '–ù–∞—á–∞–ª–æ –º–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏–∏'
                    })
                });

                if (response.ok) {
                    showToast(`–ú–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏—è –æ—Ç–º–µ—á–µ–Ω–∞ –Ω–∞ ${formatDateDisplay(targetDate)}!`, 'success');
                    await loadCycleData();
                    renderCalendar();
                }
            } else {
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å
                const response = await fetch(CYCLE_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date: targetDate,
                        symptoms: [],
                        flow_intensity: 'medium',
                        notes: '–ù–∞—á–∞–ª–æ –º–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏–∏'
                    })
                });

                if (response.ok) {
                    showToast(`–ú–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏—è –æ—Ç–º–µ—á–µ–Ω–∞ –Ω–∞ ${formatDateDisplay(targetDate)}!`, 'success');
                    await loadCycleData();
                    renderCalendar();
                }
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞:', error);
            showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏
    async function deleteCycleEntry() {
        if (!currentSelectedDate) {
            showToast('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ', 'error');
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å —á—Ç–æ —É–¥–∞–ª—è—Ç—å
        const existingEntry = cycleData.find(entry => entry.date === currentSelectedDate);
        if (!existingEntry) {
            showToast('–î–ª—è —ç—Ç–æ–π –¥–∞—Ç—ã –Ω–µ—Ç –∑–∞–ø–∏—Å–∏', 'info');
            return;
        }

        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∑–∞ ${formatDateDisplay(currentSelectedDate)}?`)) {
            return;
        }

        try {
            // üîß –í–ê–ñ–ù–û: URL –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å Flask –º–∞—Ä—à—Ä—É—Ç—É
            console.log('üîó –û—Ç–ø—Ä–∞–≤–ª—è—é DELETE –∑–∞–ø—Ä–æ—Å –Ω–∞:', `${CYCLE_API}/${currentSelectedDate}`);

            const response = await fetch(`${CYCLE_API}/${currentSelectedDate}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç—É—Å, –Ω–æ –∏ —Ç–µ–ª–æ –æ—Ç–≤–µ—Ç–∞
            const result = await response.json();

            if (response.ok && result.success) {
                showToast(`–ó–∞–ø–∏—Å—å –∑–∞ ${formatDateDisplay(currentSelectedDate)} —É–¥–∞–ª–µ–Ω–∞!`, 'success');

                // ‚úÖ –í–ê–ñ–ù–û: –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å—å –∏–∑ –õ–û–ö–ê–õ–¨–ù–û–ì–û –º–∞—Å—Å–∏–≤–∞ cycleData
                const index = cycleData.findIndex(entry => entry.date === currentSelectedDate);
                if (index > -1) {
                    cycleData.splice(index, 1);
                    console.log(`üóëÔ∏è –£–¥–∞–ª–µ–Ω–∞ –∑–∞–ø–∏—Å—å –∏–∑ cycleData: ${currentSelectedDate}`);
                    console.log('üìä –¢–µ–ø–µ—Ä—å –≤ cycleData –∑–∞–ø–∏—Å–µ–π:', cycleData.length);
                }

                // ‚úÖ –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                renderCalendar();

                // ‚úÖ –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É
                resetToToday();

                // ‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º –ª–µ–≥–µ–Ω–¥—É —Å–∏–º–ø—Ç–æ–º–æ–≤
                updateSymptomsLegend();

                // ‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É
                updateChartsWithRealData();

            } else {
                // –ï—Å–ª–∏ response.ok, –Ω–æ –Ω–µ—Ç success –≤ —Ç–µ–ª–µ –æ—Ç–≤–µ—Ç–∞
                const errorMsg = result.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏';
                throw new Error(errorMsg);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
            showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏: ' + error.message, 'error');
        }
    }
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
    function initCharts() {
        // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
        setTimeout(() => {
            console.log('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤...');
            console.log('üìÅ –î–∞–Ω–Ω—ã–µ —Ü–∏–∫–ª–∞:', cycleData.length, '–∑–∞–ø–∏—Å–µ–π');
            updateChartsWithRealData();
        }, 500);
    }
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    async function loadInitialData() {
        try {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            await loadCycleData();
            renderCalendar();

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            await Promise.allSettled([
                loadMoodData(),
                loadCycleStats(),
                loadCyclePredictions(),
                loadTodayMood()
            ]);

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≥—Ä–∞—Ñ–∏–∫–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
            initCharts();

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
            showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ª–µ–≥–µ–Ω–¥—ã —Å–∏–º–ø—Ç–æ–º–æ–≤
    function updateSymptomsLegend() {
        const legendContainer = document.getElementById('symptomsLegend');
        if (!legendContainer) return;

        // –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–∏–º–ø—Ç–æ–º–æ–≤
        const symptomStats = {};
        cycleData.forEach(entry => {
            if (entry.symptoms && Array.isArray(entry.symptoms)) {
                entry.symptoms.forEach(symptom => {
                    symptomStats[symptom] = (symptomStats[symptom] || 0) + 1;
                });
            }
        });

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —á–∞—Å—Ç–æ—Ç–µ
        const sortedSymptoms = Object.entries(symptomStats)
            .sort((a, b) => b[1] - a[1]);

        if (sortedSymptoms.length === 0) {
            legendContainer.innerHTML = '<p style="text-align: center; color: var(--gray);">–°–∏–º–ø—Ç–æ–º—ã –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>';
            return;
        }

        // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –ª–µ–≥–µ–Ω–¥—ã
        legendContainer.innerHTML = sortedSymptoms.map(([symptom, count]) => `
        <div class="legend-item">
            <div class="legend-color" style="background: ${getSymptomColor(symptom)}"></div>
            <div class="legend-name">${symptom}</div>
            <div class="legend-count">${count}</div>
        </div>
    `).join('');
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ª–µ–≥–µ–Ω–¥—ã 
    function toggleLegend() {
        const content = document.getElementById('symptomsLegend');
        const toggleBtn = document.querySelector('.legend-toggle i');

        if (!content || !toggleBtn) return;

        content.classList.toggle('collapsed');

        if (content.classList.contains('collapsed')) {
            toggleBtn.classList.remove('fa-chevron-up');
            toggleBtn.classList.add('fa-chevron-down');
        } else {
            toggleBtn.classList.remove('fa-chevron-down');
            toggleBtn.classList.add('fa-chevron-up');
        }
    }
    async function loadCycleData() {
        try {
            const response = await fetch(CYCLE_API);
            console.log('üîç –ó–∞–ø—Ä–æ—Å –∫ CYCLE_API:', CYCLE_API, '–°—Ç–∞—Ç—É—Å:', response.status);

            if (response.ok) {
                cycleData = await response.json();
                console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —Ü–∏–∫–ª–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', cycleData.length, '–∑–∞–ø–∏—Å–µ–π');

                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–µ–≥–µ–Ω–¥—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                updateSymptomsLegend();
            } else {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ü–∏–∫–ª–∞:', response.status);
            }
        } catch (error) {
            console.error('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ü–∏–∫–ª–∞:', error);
        }
    }

    // –í—ã–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö
    loadInitialData();
</script>
{% endblock %}