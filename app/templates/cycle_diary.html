{% extends "base.html" %}

{% block title %}Lumi ‚Äî –î–Ω–µ–≤–Ω–∏–∫ —Ü–∏–∫–ª–∞{% endblock %}

{% block extra_css %}
<style>
:root {
--primary: #60F4E3;
--primary-dark: #48cbbd;
--secondary: #FF70EC;
--accent: #FFEFFD;
--dark: #264653;
--light: #f8f9fa;
--white: #ffffff;
--gray: #6c757d;
--success: #4CAF50;
--warning: #FFC107;
--danger: #F44336;
--border-radius: 16px;
--shadow: 0 6px 16px rgba(0,0,0,0.1);
--accent-pink: #FF70EC;
            
--menstruation: #FF6B6B;
--follicular: #60F4E3;
--ovulation: #FF70EC;
--luteal: #FFD166;
--pms: #B8B3E9;
}

       
        * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: 'Montserrat', sans-serif;
}

body {
    margin: 0;
    background: linear-gradient(to right, #60F4E3 0%, #FFEFFD 50%, #FF70EC 100%);
    color: var(--dark);
    line-height: 1.6;
    min-height: 100vh;
    padding-top: 80px; /* –í–∞–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç—Å—Ç—É–ø –¥–ª—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ö–µ–¥–µ—Ä–∞ */
}

         main {
            padding: 30px 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 {
            font-size: 28px;
            color: var(--dark);
            position: relative;
            padding-bottom: 10px;
            font-weight: 700;
        }

        h1:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 4px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            border-radius: 2px;
        }

        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ü–∏–∫–ª–∞ */
        .cycle-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            text-align: center;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
        }

        .stat-title {
            font-size: 16px;
            color: var(--gray);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-change {
            font-size: 14px;
            margin-top: 5px;
            color: var(--gray);
        }

        /* –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Ü–∏–∫–ª–∞ */
        .cycle-calendar-container {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 30px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--dark);
        }

        .calendar-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .calendar-btn {
            background: var(--primary);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            transition: var(--transition);
            color: var(--dark);
        }

        .calendar-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }

        .today-btn {
            padding: 8px 16px;
            background: var(--white);
            border: 2px solid var(--primary);
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            color: var(--dark);
        }

        .today-btn:hover {
            background: var(--primary);
            transform: translateY(-2px);
        }

        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--gray);
            background: rgba(96, 244, 227, 0.1);
            border-radius: 10px;
            padding: 10px 0;
        }

        .weekday {
            padding: 10px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .calendar-day {
            aspect-ratio: 1/1;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: var(--light);
            transition: var(--transition);
            position: relative;
            padding: 5px;
            border: 2px solid transparent;
            font-weight: 600;
        }

        .calendar-day:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-color: var(--primary);
        }

        .day-number {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .cycle-phase-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin: 1px 0;
        }

        .symptoms-dots {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            justify-content: center;
            margin-top: 3px;
        }

        /* –§–∞–∑—ã —Ü–∏–∫–ª–∞ */
        .menstruation {
            background: linear-gradient(135deg, var(--menstruation), #FFA8A8);
            color: white;
        }

        .follicular {
            background: linear-gradient(135deg, var(--follicular), #A8F0E9);
        }

        .ovulation {
            background: linear-gradient(135deg, var(--ovulation), #FFB6F1);
            color: white;
        }

        .luteal {
            background: linear-gradient(135deg, var(--luteal), #FFE8B2);
        }

        .pms-phase {
            background: linear-gradient(135deg, var(--pms), #D8D5F2);
        }

        .fertile-window {
            border: 2px dashed var(--ovulation);
        }

        .predicted {
            border: 2px dotted var(--gray);
            opacity: 0.7;
        }

        .current-day {
            background: var(--accent);
            border: 2px solid var(--primary);
            box-shadow: 0 2px 8px rgba(96, 244, 227, 0.3);
        }

        .other-month {
            background: rgba(248, 248, 248, 0.5);
            color: #ccc;
        }

        /* –§–æ—Ä–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è */
        .tracker-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        @media (max-width: 968px) {
            .tracker-container {
                grid-template-columns: 1fr;
            }
        }

        .tracker-form {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 25px;
        }

        .form-section {
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .symptoms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .symptom-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: rgba(96, 244, 227, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
        }

        .symptom-checkbox:hover {
            background: rgba(96, 244, 227, 0.2);
        }

        .symptom-checkbox input {
            margin: 0;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            transition: var(--transition);
            background: white;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(96, 244, 227, 0.2);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .mood-integration {
            background: var(--accent);
            border-radius: var(--border-radius);
            padding: 20px;
            border: 2px solid var(--primary);
        }

        .mood-display {
            text-align: center;
            padding: 15px;
        }

        .mood-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--primary);
        }

        .mood-emoji {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .mood-note {
            font-size: 14px;
            color: var(--gray);
            margin-top: 10px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            width: 100%;
            justify-content: center;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--dark);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ */
        .analytics-container {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 25px;
            margin-bottom: 30px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-top: 20px;
        }


@media (max-width: 1024px) {
    /* –ü–ª–∞–Ω—à–µ—Ç—ã –∏ –º–∞–ª–µ–Ω—å–∫–∏–µ –Ω–æ—É—Ç–±—É–∫–∏ */
    main {
        padding: 25px 15px;
    }
    
    .tracker-container {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .charts-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }
}

@media (max-width: 768px) {
    /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ö–µ–¥–µ—Ä –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ –∏ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ */
    body {
        padding-top: 60px; /* –£–º–µ–Ω—å—à–∏–ª–∏ –æ—Ç—Å—Ç—É–ø */
    }
    
    
    nav a.active {
        color: var(--dark);
    }
    

    /* –ü—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ (–µ—Å–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç hover) */
    @media (hover: hover) {
        nav a:hover::after {
            width: 100%;
        }
    }
    
    .user span {
        display: none; /* –°–∫—Ä—ã–≤–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
    }
    
    .user-avatar {
        width: 36px;
        height: 36px;
    }
    
    /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
    main {
        padding: 20px 12px;
    }
    
    .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
        margin-bottom: 20px;
    }
    
    h1 {
        font-size: 24px;
        padding-bottom: 8px;
    }
    
    h1:after {
        left: 50%;
        transform: translateX(-50%);
        width: 50px;
    }
    
    /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ü–∏–∫–ª–∞ */
    .cycle-stats {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-bottom: 25px;
    }
    
    .stat-card {
        padding: 15px;
        border-radius: 14px;
    }
    
    .stat-title {
        font-size: 14px;
        margin-bottom: 8px;
    }
    
    .stat-value {
        font-size: 22px;
    }
    
    .stat-change {
        font-size: 13px;
    }
    
    /* –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Ü–∏–∫–ª–∞ */
    .cycle-calendar-container {
        padding: 20px;
        border-radius: 14px;
        margin-bottom: 25px;
    }
    
    .calendar-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
        margin-bottom: 15px;
    }
    
    .calendar-title {
        font-size: 18px;
    }
    
    .calendar-controls {
        width: 100%;
        justify-content: space-between;
    }
    
    .today-btn {
        padding: 6px 12px;
        font-size: 14px;
    }
    
    .calendar-btn {
        width: 36px;
        height: 36px;
    }
    
    .weekdays {
        padding: 8px 0;
        font-size: 14px;
        margin-bottom: 8px;
    }
    
    .weekday {
        padding: 8px 2px;
        font-size: 13px;
    }
    
    .calendar-grid {
        gap: 6px;
    }
    
    .calendar-day {
        min-height: 45px;
        border-radius: 10px;
        padding: 4px;
    }
    
    .day-number {
        font-size: 14px;
        margin-bottom: 3px;
    }
    
    .cycle-phase-dot {
        width: 6px;
        height: 6px;
    }
    
    /* –§–æ—Ä–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è */
    .tracker-form {
        padding: 20px;
        border-radius: 14px;
    }
    
    .mood-integration {
        padding: 20px;
        border-radius: 14px;
    }
    
    .section-title {
        font-size: 16px;
        margin-bottom: 12px;
    }
    
    .symptoms-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
    }
    
    .symptom-checkbox {
        padding: 8px;
        font-size: 13px;
    }
    
    .form-input, .form-select, .form-textarea {
        padding: 10px 12px;
        font-size: 14px;
        border-radius: 10px;
    }
    
    .mood-display {
        padding: 12px;
    }
    
    .mood-value {
        font-size: 28px;
    }
    
    .mood-emoji {
        font-size: 40px;
    }
    
    .btn {
        padding: 10px 20px;
        font-size: 14px;
        border-radius: 10px;
    }
    
    /* –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ */
    .analytics-container {
        padding: 20px;
        border-radius: 14px;
        margin-bottom: 25px;
    }
    
    .chart-container {
        height: 250px;
        padding: 15px;
    }
    
    .chart-title {
        font-size: 15px;
        margin-bottom: 12px;
    }
    
    /* –õ–µ–≥–µ–Ω–¥–∞ */
    .legend {
        padding: 15px;
        border-radius: 14px;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 12px;
        justify-content: center;
    }
    
    .legend-item {
        font-size: 12px;
        padding: 6px 10px;
        flex-shrink: 0;
    }
    
    .legend-color {
        width: 12px;
        height: 12px;
    }
    
    /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
    .toast {
        top: 70px;
        right: 10px;
        left: 10px;
        max-width: none;
        text-align: center;
        font-size: 13px;
        padding: 12px 16px;
    }
    
    /* –£–±–∏—Ä–∞–µ–º hover-—ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è —Ç–∞—á-—É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    .calendar-day:hover,
    .stat-card:hover,
    .symptom-checkbox:hover,
    .btn:hover {
        transform: none;
        box-shadow: none;
        border-color: transparent;
    }
    
    .stat-card:hover {
        border-color: transparent;
    }
}

@media (max-width: 480px) {
    /* –ï—â–µ –±–æ–ª–µ–µ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ */
    body {
        padding-top: 55px;
    }

    main {
        padding: 15px 10px;
    }
    
    h1 {
        font-size: 22px;
        text-align: center;
        width: 100%;
    }
    
    /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
    .cycle-stats {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .stat-card {
        padding: 12px;
    }
    
    .stat-title {
        font-size: 13px;
    }
    
    .stat-value {
        font-size: 20px;
    }
    
    /* –ö–∞–ª–µ–Ω–¥–∞—Ä—å */
    .cycle-calendar-container {
        padding: 15px;
        border-radius: 12px;
    }
    
    .calendar-title {
        font-size: 16px;
    }
    
    .today-btn {
        padding: 5px 10px;
        font-size: 13px;
    }
    
    .calendar-btn {
        width: 32px;
        height: 32px;
    }
    
    .calendar-btn i {
        font-size: 12px;
    }
    
    .weekday {
        padding: 6px 1px;
        font-size: 12px;
    }
    
    .calendar-grid {
        gap: 4px;
    }
    
    .calendar-day {
        min-height: 40px;
        border-radius: 8px;
        padding: 3px;
    }
    
    .day-number {
        font-size: 13px;
    }
    
    /* –§–æ—Ä–º–∞ */
    .tracker-form,
    .mood-integration {
        padding: 15px;
    }
    
    .symptoms-grid {
        grid-template-columns: 1fr;
    }
    
    .section-title {
        font-size: 15px;
    }
    
    .form-input, .form-select, .form-textarea {
        padding: 8px 10px;
        font-size: 13px;
    }
    
    .btn {
        padding: 8px 16px;
        font-size: 13px;
    }
    
    /* –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ */
    .analytics-container {
        padding: 15px;
    }
    
    .chart-container {
        height: 220px;
        padding: 12px;
    }
    
    /* –õ–µ–≥–µ–Ω–¥–∞ */
    .legend {
        flex-direction: column;
        align-items: center;
        gap: 10px;
        padding: 12px;
    }
    
    .legend-item {
        width: 100%;
        justify-content: center;
        padding: 8px;
    }
}

@media (max-width: 360px) {
    /* –û—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω—ã */
    .calendar-day {
        min-height: 35px;
    }
    
    .day-number {
        font-size: 12px;
    }
    
    .stat-value {
        font-size: 18px;
    }
    
    .mood-value {
        font-size: 24px;
    }
    
    .mood-emoji {
        font-size: 36px;
    }
}

/* –õ–∞–Ω–¥—à–∞—Ñ—Ç–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è */
@media (max-height: 500px) and (orientation: landscape) {
    
    .cycle-stats {
        grid-template-columns: repeat(4, 1fr);
    }
    
    .calendar-day {
        min-height: 35px;
    }
    
    .chart-container {
        height: 200px;
    }
}

    </style>
{% endblock %}


{% block content %}

    <main>
        <div class="page-header">
            <h1>–î–Ω–µ–≤–Ω–∏–∫ —Ü–∏–∫–ª–∞</h1>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ü–∏–∫–ª–∞ -->
        <div class="cycle-stats">
            <div class="stat-card">
                <div class="stat-title">–¢–µ–∫—É—â–∏–π —Ü–∏–∫–ª</div>
                <div class="stat-value" id="cycleLength">28 –¥–Ω–µ–π</div>
                <div class="stat-change" id="cycleTrend">+2 –¥–Ω—è –∫ –ø—Ä–æ—à–ª–æ–º—É</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">–°–ª–µ–¥—É—é—â–∞—è –º–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏—è</div>
                <div class="stat-value" id="nextPeriod">—á–µ—Ä–µ–∑ 12 –¥–Ω–µ–π</div>
                <div class="stat-change" id="periodPrediction">–ü—Ä–æ–≥–Ω–æ–∑ —Ç–æ—á–Ω—ã–π</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">–§–µ—Ä—Ç–∏–ª—å–Ω–æ–µ –æ–∫–Ω–æ</div>
                <div class="stat-value" id="fertileWindow">—á–µ—Ä–µ–∑ 5 –¥–Ω–µ–π</div>
                <div class="stat-change" id="fertileStatus">–ù–∞—á–∏–Ω–∞–µ—Ç—Å—è</div>
            </div>
            <div class="stat-card">
                <div class="stat-title">–°—Ä–µ–¥–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</div>
                <div class="stat-value" id="avgMoodCycle">7.2/10</div>
                <div class="stat-change" id="moodTrend">–õ—É—á—à–µ –Ω–∞ 0.5</div>
            </div>
        </div>

        <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Ü–∏–∫–ª–∞ -->
        <div class="cycle-calendar-container">
            <div class="calendar-header">
                <div class="calendar-title" id="monthYear">–î–µ–∫–∞–±—Ä—å 2024</div>
                <div class="calendar-controls">
                    <button class="calendar-btn" onclick="changeMonth(-1)">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="today-btn" onclick="goToToday()">
                        –°–µ–≥–æ–¥–Ω—è
                    </button>
                    <button class="calendar-btn" onclick="changeMonth(1)">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <div class="weekdays">
                <div class="weekday">–ü–Ω</div>
                <div class="weekday">–í—Ç</div>
                <div class="weekday">–°—Ä</div>
                <div class="weekday">–ß—Ç</div>
                <div class="weekday">–ü—Ç</div>
                <div class="weekday">–°–±</div>
                <div class="weekday">–í—Å</div>
            </div>

            <div class="calendar-grid" id="calendar">
                <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω JavaScript -->
            </div>
        </div>

        <!-- –§–æ—Ä–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ–º -->
        <div class="tracker-container">
            <div class="tracker-form">
                <h3 class="section-title"><i class="fas fa-edit"></i> –û—Ç–º–µ—Ç–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è</h3>
                
                <div class="form-section">
                    <div class="section-title"><i class="fas fa-heartbeat"></i> –°–∏–º–ø—Ç–æ–º—ã</div>
                    <div class="symptoms-grid" id="symptomsGrid">
                        <!-- –°–∏–º–ø—Ç–æ–º—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-title"><i class="fas fa-tint"></i> –í—ã–¥–µ–ª–µ–Ω–∏—è</div>
                    <select id="flowLevel" class="form-select">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å...</option>
                        <option value="none">–ù–µ—Ç –≤—ã–¥–µ–ª–µ–Ω–∏–π</option>
                        <option value="light">–°–ª–∞–±—ã–µ</option>
                        <option value="medium">–£–º–µ—Ä–µ–Ω–Ω—ã–µ</option>
                        <option value="heavy">–û–±–∏–ª—å–Ω—ã–µ</option>
                    </select>
                </div>

                <div class="form-section">
                    <div class="section-title"><i class="fas fa-sticky-note"></i> –ó–∞–º–µ—Ç–∫–∏</div>
                    <textarea id="cycleNotes" class="form-textarea" placeholder="–ö–∞–∫ –≤—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ—Ç–µ? –ß—Ç–æ –∑–∞–º–µ—Ç–∏–ª–∏?"></textarea>
                </div>

                <button class="btn btn-primary" onclick="saveCycleEntry()">
                    <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å
                </button>
            </div>

            <div class="mood-integration">
                <h3 class="section-title"><i class="fas fa-chart-line"></i> –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è</h3>
                <div class="mood-display" id="todayMood">
                    <div class="loading" id="moodLoading">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="goToMoodTracker()">
                    <i class="fas fa-edit"></i> –û—Ç–º–µ—Ç–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
                </button>
            </div>
        </div>

   
 <!-- –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
<div class="analytics-container">
    <h3 class="section-title"><i class="fas fa-chart-bar"></i> –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ü–∏–∫–ª–∞</h3>
    <div class="charts-grid">
        <div class="chart-container" id="moodChartContainer">
            <div class="chart-title">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–æ —Ñ–∞–∑–∞–º —Ü–∏–∫–ª–∞</div>
            <canvas id="moodPhaseChart"></canvas>
            <div class="no-data" id="noMoodData" style="display: none;">
                <i class="fas fa-chart-line" style="font-size: 40px; color: var(--gray); margin-bottom: 10px;"></i>
                <p>–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞</p>
                <p style="font-size: 12px;">–î–æ–±–∞–≤—å—Ç–µ –∑–∞–ø–∏—Å–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è</p>
            </div>
        </div>
        <div class="chart-container" id="symptomsChartContainer">
            <div class="chart-title">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∏–º–ø—Ç–æ–º–æ–≤</div>
            <canvas id="symptomsChart"></canvas>
            <div class="no-data" id="noSymptomsData" style="display: none;">
                <i class="fas fa-chart-pie" style="font-size: 40px; color: var(--gray); margin-bottom: 10px;"></i>
                <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–∏–º–ø—Ç–æ–º–∞—Ö</p>
                <p style="font-size: 12px;">–û—Ç–º–µ—Ç—å—Ç–µ —Å–∏–º–ø—Ç–æ–º—ã –≤ –∑–∞–ø–∏—Å—è—Ö</p>
            </div>
        </div>
    </div>
</div>
        <!-- –õ–µ–≥–µ–Ω–¥–∞ -->
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: var(--menstruation);"></div>
                <span>–ú–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏—è</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: var(--follicular);"></div>
                <span>–§–æ–ª–ª–∏–∫—É–ª—è—Ä–Ω–∞—è —Ñ–∞–∑–∞</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: var(--ovulation);"></div>
                <span>–û–≤—É–ª—è—Ü–∏—è</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: var(--luteal);"></div>
                <span>–õ—é—Ç–µ–∏–Ω–æ–≤–∞—è —Ñ–∞–∑–∞</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: var(--pms);"></div>
                <span>–ü–ú–°</span>
            </div>
            <div class="legend-item">
                <div style="width: 16px; height: 16px; border: 2px dashed var(--ovulation); border-radius: 50%;"></div>
                <span>–§–µ—Ä—Ç–∏–ª—å–Ω–æ–µ –æ–∫–Ω–æ</span>
            </div>
        </div>
    </main>

    <div class="toast" id="toast"></div>

{% endblock %}
{% block extra_js %}
<script>

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (—É–∂–µ –µ—Å—Ç—å, –Ω–æ –¥–æ–±–∞–≤–∏–º –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
window.showToast = showToast || function(message, type = 'success') {
    let toast = document.getElementById('toast');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast';
        document.body.appendChild(toast);
    }
    
    toast.textContent = message;
    toast.className = `toast ${type === 'error' ? 'error' : ''} show`;
    
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            if (toast.parentNode) {
                document.body.removeChild(toast);
            }
        }, 300);
    }, 3000);
};
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã API
const CYCLE_API = "/api/cycle_entries";
const MOOD_API = "/api/mood_entries";
const TODAY_MOOD_API = "/api/today_mood";
const CYCLE_STATS_API = "/api/cycle_stats";
const CYCLE_PREDICTIONS_API = "/api/cycle_predictions";

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let currentDate = new Date();
let cycleData = [];
let moodData = [];
let moodPhaseChart = null;
let symptomsChart = null;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–Ω–µ–≤–Ω–∏–∫–∞ —Ü–∏–∫–ª–∞...');
    initSymptomsGrid();
    loadInitialData();
});

// –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
async function loadInitialData() {
    try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ —Ü–∏–∫–ª–∞ –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        await loadCycleData();
        renderCalendar();
        
        // –û—Å—Ç–∞–ª—å–Ω–æ–µ –∑–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ–Ω–æ–º
        Promise.allSettled([
            loadMoodData(),
            loadCycleStats(),
            loadCyclePredictions(),
            loadTodayMood()
        ]);
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
        showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ü–∏–∫–ª–∞
async function loadCycleData() {
    try {
        const response = await fetch(CYCLE_API);
        console.log('üîç –ó–∞–ø—Ä–æ—Å –∫ CYCLE_API:', CYCLE_API, '–°—Ç–∞—Ç—É—Å:', response.status);
        
        if (response.ok) {
            cycleData = await response.json();
            console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —Ü–∏–∫–ª–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', cycleData.length, '–∑–∞–ø–∏—Å–µ–π');
        } else {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ü–∏–∫–ª–∞:', response.status);
        }
    } catch (error) {
        console.error('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ü–∏–∫–ª–∞:', error);
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
async function loadMoodData() {
    try {
        const response = await fetch(MOOD_API);
        if (response.ok) {
            moodData = await response.json();
            console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è:', error);
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ü–∏–∫–ª–∞
async function loadCycleStats() {
    try {
        const response = await fetch(CYCLE_STATS_API);
        if (response.ok) {
            const stats = await response.json();
            updateStatsDisplay(stats);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ü–∏–∫–ª–∞:', error);
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ —Ü–∏–∫–ª–∞
async function loadCyclePredictions() {
    try {
        const response = await fetch(CYCLE_PREDICTIONS_API);
        if (response.ok) {
            const predictions = await response.json();
            updatePredictionsDisplay(predictions);
        } else {
            document.getElementById('nextPeriod').textContent = '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            document.getElementById('fertileWindow').textContent = '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ —Ü–∏–∫–ª–∞:', error);
        document.getElementById('nextPeriod').textContent = '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        document.getElementById('fertileWindow').textContent = '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    }
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
async function loadTodayMood() {
    try {
        const response = await fetch(TODAY_MOOD_API);
        if (response.ok) {
            const todayMood = await response.json();
            updateTodayMoodDisplay(todayMood);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è:', error);
        updateTodayMoodDisplay(null);
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ç–∫–∏ —Å–∏–º–ø—Ç–æ–º–æ–≤
function initSymptomsGrid() {
    const symptomsGrid = document.getElementById('symptomsGrid');
    if (!symptomsGrid) return;
    
    const defaultSymptoms = [
        '–ì–æ–ª–æ–≤–Ω–∞—è –±–æ–ª—å', '–°–ø–∞–∑–º—ã', '–£—Å—Ç–∞–ª–æ—Å—Ç—å', '–ù–∞–±—É—Ö–∞–Ω–∏–µ –≥—Ä—É–¥–∏',
        '–ü–µ—Ä–µ–ø–∞–¥—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è', '–¢—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å', '–í–∑–¥—É—Ç–∏–µ', '–ê–∫–Ω–µ',
        '–¢—è–≥–∞ –∫ —Å–ª–∞–¥–∫–æ–º—É', '–ë–µ—Å—Å–æ–Ω–Ω–∏—Ü–∞', '–¢–æ—à–Ω–æ—Ç–∞', '–ë–æ–ª—å –≤ —Å–ø–∏–Ω–µ'
    ];

    symptomsGrid.innerHTML = defaultSymptoms.map(symptom => `
        <label class="symptom-checkbox">
            <input type="checkbox" name="symptoms" value="${symptom}">
            ${symptom}
        </label>
    `).join('');
}

// –†–µ–Ω–¥–µ—Ä –∫–∞–ª–µ–Ω–¥–∞—Ä—è
function renderCalendar() {
    const calendar = document.getElementById('calendar');
    const monthYear = document.getElementById('monthYear');
    
    if (!calendar || !monthYear) {
        console.error('‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω—ã —ç–ª–µ–º–µ–Ω—Ç—ã –∫–∞–ª–µ–Ω–¥–∞—Ä—è');
        return;
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
    const monthNames = [
        '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
        '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
    ];
    monthYear.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;

    // –û—á–∏—â–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
    calendar.innerHTML = '';

    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();

    // –ü–µ—Ä–≤—ã–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞
    const firstDay = new Date(year, month, 1);
    // –ü–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞
    const lastDay = new Date(year, month + 1, 0);
    // –î–Ω–µ–π –≤ –º–µ—Å—è—Ü–µ
    const daysInMonth = lastDay.getDate();
    
    // –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è (1 = –ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, 7 = –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ)
    let startDay = firstDay.getDay();
    if (startDay === 0) startDay = 7;

    // –î–Ω–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
    const prevMonthDays = new Date(year, month, 0).getDate();
    for (let i = startDay - 1; i > 0; i--) {
        const day = createDayElement(prevMonthDays - i + 1, 'other-month', true);
        calendar.appendChild(day);
    }

    // –î–Ω–∏ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
    const today = new Date();
    for (let i = 1; i <= daysInMonth; i++) {
        const date = new Date(year, month, i);
        const dateStr = formatDate(date);
        const day = createDayElement(i, '', false);

        // –û—Ç–º–µ—á–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–π –¥–µ–Ω—å
        if (today.getDate() === i && today.getMonth() === month && today.getFullYear() === year) {
            day.classList.add('current-day');
        }

        // –ù–∞—Ö–æ–¥–∏–º –∑–∞–ø–∏—Å—å –æ —Ü–∏–∫–ª–µ –¥–ª—è —ç—Ç–æ–π –¥–∞—Ç—ã
        const cycleEntry = cycleData.find(entry => entry && entry.date === dateStr);
        
        // –ö–†–ê–°–ù–´–ô –¥–ª—è –¥–Ω–µ–π –º–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–ø–∏—Å—å —Å flow_intensity)
        if (cycleEntry) {
            // –ï—Å–ª–∏ –µ—Å—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏—è (–Ω–µ 'none') - –∫—Ä–∞—Å–Ω—ã–π —Ñ–æ–Ω
            if (cycleEntry.flow_intensity && cycleEntry.flow_intensity !== 'none') {
                day.classList.add('menstruation');
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫–∏ –¥–ª—è —Å–∏–º–ø—Ç–æ–º–æ–≤
            const symptoms = cycleEntry.symptoms || [];
            if (symptoms.length > 0) {
                const symptomsDots = document.createElement('div');
                symptomsDots.className = 'symptoms-dots';
                symptoms.slice(0, 3).forEach(symptom => {
                    const dot = document.createElement('div');
                    dot.className = 'cycle-phase-dot';
                    dot.style.background = getSymptomColor(symptom);
                    symptomsDots.appendChild(dot);
                });
                day.appendChild(symptomsDots);
            }
        }

        // –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –¥–µ–Ω—å –æ—Ç–∫—Ä—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏
        day.addEventListener('click', function() {
            openDayDetail(dateStr);
        });

        calendar.appendChild(day);
    }

    // –î–Ω–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞
    const totalCells = 42;
    const filledCells = startDay - 1 + daysInMonth;
    if (filledCells < totalCells) {
        for (let i = 1; i <= totalCells - filledCells; i++) {
            const day = createDayElement(i, 'other-month', true);
            calendar.appendChild(day);
        }
    }
    
    console.log('‚úÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω');
}

// –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –¥–Ω—è
function createDayElement(dayNumber, className, isOtherMonth) {
    const dayElement = document.createElement('div');
    dayElement.className = 'calendar-day';
    
    if (className) {
        dayElement.classList.add(className);
    }

    const numberElement = document.createElement('div');
    numberElement.className = 'day-number';
    numberElement.textContent = dayNumber;

    dayElement.appendChild(numberElement);

    if (isOtherMonth) {
        dayElement.style.cursor = 'default';
        dayElement.style.pointerEvents = 'none';
        dayElement.style.opacity = '0.5';
    }

    return dayElement;
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–∏–º–ø—Ç–æ–º–æ–≤ –¥–ª—è –¥–∞—Ç—ã
function getSymptomsForDate(dateStr) {
    if (!dateStr || !cycleData || !Array.isArray(cycleData)) return [];
    
    const entry = cycleData.find(entry => entry && entry.date === dateStr);
    return entry ? (entry.symptoms || []) : [];
}

// –¶–≤–µ—Ç –¥–ª—è —Å–∏–º–ø—Ç–æ–º–∞
function getSymptomColor(symptom) {
    const colors = {
        '–ì–æ–ª–æ–≤–Ω–∞—è –±–æ–ª—å': '#FF6B6B',
        '–°–ø–∞–∑–º—ã': '#FF70EC',
        '–£—Å—Ç–∞–ª–æ—Å—Ç—å': '#60F4E3',
        '–ù–∞–±—É—Ö–∞–Ω–∏–µ –≥—Ä—É–¥–∏': '#FFD166',
        '–ü–µ—Ä–µ–ø–∞–¥—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è': '#B8B3E9',
        '–¢—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å': '#FFA502',
        '–í–∑–¥—É—Ç–∏–µ': '#2ed573',
        '–ê–∫–Ω–µ': '#ff4757'
    };
    return colors[symptom] || '#B8B3E9';
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º
function changeMonth(step) {
    currentDate.setMonth(currentDate.getMonth() + step);
    renderCalendar();
}

function goToToday() {
    currentDate = new Date();
    renderCalendar();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function updateStatsDisplay(stats) {
    if (stats && stats.avg_mood) {
        document.getElementById('avgMoodCycle').textContent = `${parseFloat(stats.avg_mood).toFixed(1)}/10`;
    }
    if (stats && stats.total_entries) {
        document.getElementById('cycleLength').textContent = `${stats.total_entries} –∑–∞–ø–∏—Å–µ–π`;
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–æ–≥–Ω–æ–∑–æ–≤
function updatePredictionsDisplay(predictions) {
    if (!predictions || predictions.error) return;

    if (predictions.next_period) {
        const nextPeriod = new Date(predictions.next_period);
        const today = new Date();
        const daysDiff = Math.ceil((nextPeriod - today) / (1000 * 60 * 60 * 24));
        if (daysDiff > 0) {
            document.getElementById('nextPeriod').textContent = `—á–µ—Ä–µ–∑ ${daysDiff} –¥–Ω–µ–π`;
        } else if (daysDiff === 0) {
            document.getElementById('nextPeriod').textContent = '—Å–µ–≥–æ–¥–Ω—è';
        } else {
            document.getElementById('nextPeriod').textContent = `${Math.abs(daysDiff)} –¥–Ω–µ–π –Ω–∞–∑–∞–¥`;
        }
    }

    if (predictions.current_cycle_day) {
        document.getElementById('cycleLength').textContent = `${predictions.current_cycle_day} –¥–µ–Ω—å`;
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
function updateTodayMoodDisplay(moodData) {
    const moodDisplay = document.getElementById('todayMood');
    const moodLoading = document.getElementById('moodLoading');
    
    if (moodLoading) {
        moodLoading.style.display = 'none';
    }
    
    if (moodData && moodData.mood !== undefined && moodData.mood !== null) {
        const emoji = getMoodEmoji(moodData.mood);
        moodDisplay.innerHTML = `
            <div class="mood-value">${moodData.mood}/10</div>
            <div class="mood-emoji">${emoji}</div>
            <div class="mood-note">${moodData.note || '–ë–µ–∑ –∑–∞–º–µ—Ç–∫–∏'}</div>
        `;
    } else {
        moodDisplay.innerHTML = `
            <div class="mood-value">-/-</div>
            <div class="mood-emoji">üòê</div>
            <div class="mood-note">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –Ω–µ –æ—Ç–º–µ—á–µ–Ω–æ</div>
        `;
    }
}

function getMoodEmoji(moodValue) {
    if (moodValue >= 8) return 'üòä';
    if (moodValue >= 5) return 'üòê';
    if (moodValue >= 3) return 'üòï';
    return 'üòû';
}

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ —Ü–∏–∫–ª–∞
async function saveCycleEntry() {
    const selectedSymptoms = Array.from(document.querySelectorAll('input[name="symptoms"]:checked'))
        .map(input => input.value);
    const flowLevel = document.getElementById('flowLevel').value;
    const notes = document.getElementById('cycleNotes').value.trim();

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–æ–ª—å–∫–æ –∑–∞–º–µ—Ç–∫–∏
    if (!selectedSymptoms.length && !flowLevel && !notes) {
        showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–ª–µ', 'error');
        return;
    }

    try {
        const today = formatDate(new Date());
        const response = await fetch(CYCLE_API, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                date: today,
                symptoms: selectedSymptoms,
                flow_intensity: flowLevel,
                notes: notes
            })
        });

        if (response.ok) {
            const result = await response.json();
            showToast('–ó–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!', 'success');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä—å
            await loadCycleData();
            renderCalendar();
            
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
            document.querySelectorAll('input[name="symptoms"]:checked').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.getElementById('flowLevel').value = '';
            document.getElementById('cycleNotes').value = '';
        } else {
            const errorData = await response.json();
            throw new Error(errorData.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏: ' + error.message, 'error');
    }
}

// –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ç—Ä–µ–∫–µ—Ä—É –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
function goToMoodTracker() {
    window.location.href = "/calendar";
}

// –û—Ç–∫—Ä—ã—Ç–∏–µ –¥–µ—Ç–∞–ª–µ–π –¥–Ω—è
function openDayDetail(dateStr) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–ø–ª—ã–≤–∞—à–∫—É —Å –¥–∞—Ç–æ–π
    showToast(`–î–µ–Ω—å ${dateStr}`, 'info');
    
    // TODO: –ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–µ—Ç–∞–ª—è–º–∏
    // window.location.href = `/cycle/day/${dateStr}`;
}

// –£—Ç–∏–ª–∏—Ç—ã
function showToast(message, type = 'success') {
    let toast = document.getElementById('toast');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast';
        document.body.appendChild(toast);
    }
    
    toast.textContent = message;
    toast.className = `toast ${type === 'error' ? 'error' : ''} show`;
    
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            if (toast.parentNode) {
                document.body.removeChild(toast);
            }
        }, 300);
    }, 3000);
}

// –ü—Ä–æ—Å—Ç–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
console.log('üìÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–Ω–µ–≤–Ω–∏–∫–∞ —Ü–∏–∫–ª–∞...');


function initCharts() {
    // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
    setTimeout(() => {
        updateChartsWithRealData();
    }, 500);
}

function updateChartsWithRealData() {
    // –°–∫—Ä—ã–≤–∞–µ–º "–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö" –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
    const noMoodData = document.getElementById('noMoodData');
    const noSymptomsData = document.getElementById('noSymptomsData');
    
    // –ì—Ä–∞—Ñ–∏–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –ø–æ —Ñ–∞–∑–∞–º
    const moodChartData = calculateRealMoodByPhase(); // –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
    const moodCtx = document.getElementById('moodPhaseChart');
    
    if (moodCtx && moodChartData.hasData) {
        if (noMoodData) noMoodData.style.display = 'none';
        
        // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        if (moodPhaseChart) {
            moodPhaseChart.destroy();
        }
        
        moodPhaseChart = new Chart(moodCtx.getContext('2d'), {
            type: 'line',
            data: {
                labels: moodChartData.labels,
                datasets: [{
                    label: '–°—Ä–µ–¥–Ω–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ',
                    data: moodChartData.values,
                    borderColor: 'rgb(96, 244, 227)',
                    backgroundColor: 'rgba(96, 244, 227, 0.1)',
                    tension: 0.3,
                    fill: true,
                    borderWidth: 3,
                    pointBackgroundColor: 'rgb(96, 244, 227)',
                    pointRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ: ${context.raw}/10`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 10,
                        min: 0,
                        title: {
                            display: true,
                            text: '–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ (0-10)'
                        },
                        ticks: {
                            stepSize: 1
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '–§–∞–∑–∞ —Ü–∏–∫–ª–∞'
                        }
                    }
                }
            }
        });
    } else {
        if (noMoodData) noMoodData.style.display = 'flex';
    }
    
    // –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–∏–º–ø—Ç–æ–º–æ–≤
    const symptomsData = calculateRealSymptomFrequency();
    const symptomsCtx = document.getElementById('symptomsChart');
    
    if (symptomsCtx && symptomsData.hasData) {
        if (noSymptomsData) noSymptomsData.style.display = 'none';
        
        // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫ –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        if (symptomsChart) {
            symptomsChart.destroy();
        }
        
        symptomsChart = new Chart(symptomsCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: symptomsData.labels,
                datasets: [{
                    label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π',
                    data: symptomsData.values,
                    backgroundColor: symptomsData.colors,
                    borderColor: symptomsData.borderColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `–í—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è –≤ ${context.raw} –∑–∞–ø–∏—Å—è—Ö`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π'
                        },
                        ticks: {
                            precision: 0
                        }
                    },
                    x: {
                        ticks: {
                            autoSkip: false,
                            maxRotation: 45
                        }
                    }
                }
            }
        });
    } else {
        if (noSymptomsData) noSymptomsData.style.display = 'flex';
    }
}

// –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –ø–æ —Ñ–∞–∑–∞–º
function calculateRealMoodByPhase() {
    if (!moodData || moodData.length === 0) {
        return { hasData: false };
    }
    
    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –ø–æ —Ñ–∞–∑–∞–º (–¥–ª—è –¥–µ–º–æ - —Ñ–∞–∑—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –ø–æ –¥–Ω—é —Ü–∏–∫–ª–∞)
    const phaseMoods = {
        follicular: [],
        ovulation: [],
        luteal: [],
        menstruation: []
    };
    
    // –ü—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞: –¥–µ–Ω—å —Ü–∏–∫–ª–∞ 1-7 = –º–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏—è, 8-13 = —Ñ–æ–ª–ª–∏–∫—É–ª—è—Ä–Ω–∞—è, 
    // 14 = –æ–≤—É–ª—è—Ü–∏—è, 15-28 = –ª—é—Ç–µ–∏–Ω–æ–≤–∞—è
    moodData.forEach(entry => {
        if (entry.date && entry.mood !== undefined) {
            const date = new Date(entry.date);
            const dayOfMonth = date.getDate();
            
            if (dayOfMonth <= 7) {
                phaseMoods.menstruation.push(entry.mood);
            } else if (dayOfMonth <= 13) {
                phaseMoods.follicular.push(entry.mood);
            } else if (dayOfMonth === 14) {
                phaseMoods.ovulation.push(entry.mood);
            } else {
                phaseMoods.luteal.push(entry.mood);
            }
        }
    });
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
    const calculateAverage = (arr) => {
        if (arr.length === 0) return null;
        const sum = arr.reduce((a, b) => a + b, 0);
        return parseFloat((sum / arr.length).toFixed(1));
    };
    
    const follicularAvg = calculateAverage(phaseMoods.follicular);
    const ovulationAvg = calculateAverage(phaseMoods.ovulation);
    const lutealAvg = calculateAverage(phaseMoods.luteal);
    const menstruationAvg = calculateAverage(phaseMoods.menstruation);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ —Ñ–∞–∑–∞ —Å –¥–∞–Ω–Ω—ã–º–∏
    const hasValidData = [follicularAvg, ovulationAvg, lutealAvg, menstruationAvg]
        .some(avg => avg !== null);
    
    if (!hasValidData) {
        return { hasData: false };
    }
    
    return {
        hasData: true,
        labels: ['–§–æ–ª–ª–∏–∫—É–ª—è—Ä–Ω–∞—è', '–û–≤—É–ª—è—Ü–∏—è', '–õ—é—Ç–µ–∏–Ω–æ–≤–∞—è', '–ú–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏—è'],
        values: [
            follicularAvg || 0,
            ovulationAvg || 0,
            lutealAvg || 0,
            menstruationAvg || 0
        ]
    };
}

// –§—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ —Å–∏–º–ø—Ç–æ–º–∞—Ö
function calculateRealSymptomFrequency() {
    if (!cycleData || cycleData.length === 0) {
        return { hasData: false };
    }
    
    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Å–∏–º–ø—Ç–æ–º—ã –∏–∑ –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π
    const symptomCounts = {};
    
    cycleData.forEach(entry => {
        if (entry.symptoms && Array.isArray(entry.symptoms)) {
            entry.symptoms.forEach(symptom => {
                if (symptomCounts[symptom]) {
                    symptomCounts[symptom]++;
                } else {
                    symptomCounts[symptom] = 1;
                }
            });
        }
    });
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —á–∞—Å—Ç–æ—Ç–µ
    const sortedSymptoms = Object.entries(symptomCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8); // –ë–µ—Ä–µ–º —Ç–æ–ø-8 —Å–∏–º–ø—Ç–æ–º–æ–≤
    
    if (sortedSymptoms.length === 0) {
        return { hasData: false };
    }
    
    // –¶–≤–µ—Ç–∞ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
    const colors = [
        'rgba(255, 107, 107, 0.7)',
        'rgba(255, 112, 236, 0.7)',
        'rgba(96, 244, 227, 0.7)',
        'rgba(255, 209, 102, 0.7)',
        'rgba(184, 179, 233, 0.7)',
        'rgba(46, 213, 115, 0.7)',
        'rgba(255, 71, 87, 0.7)',
        'rgba(255, 165, 2, 0.7)'
    ];
    
    const borderColors = [
        'rgb(255, 107, 107)',
        'rgb(255, 112, 236)',
        'rgb(96, 244, 227)',
        'rgb(255, 209, 102)',
        'rgb(184, 179, 233)',
        'rgb(46, 213, 115)',
        'rgb(255, 71, 87)',
        'rgb(255, 165, 2)'
    ];
    
    return {
        hasData: true,
        labels: sortedSymptoms.map(item => item[0]),
        values: sortedSymptoms.map(item => item[1]),
        colors: colors.slice(0, sortedSymptoms.length),
        borderColors: borderColors.slice(0, sortedSymptoms.length)
    };
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
function initCharts() {
    // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
    setTimeout(() => {
        updateChartsWithRealData();
    }, 500);
}

// –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
async function loadInitialData() {
    try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        await loadCycleData();
        renderCalendar();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        await Promise.allSettled([
            loadMoodData(),
            loadCycleStats(),
            loadCyclePredictions(),
            loadTodayMood()
        ]);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≥—Ä–∞—Ñ–∏–∫–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
        initCharts();
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
        showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
    }
}

// –í—ã–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö
loadInitialData();
</script>
{% endblock %}