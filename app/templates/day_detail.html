<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumi ‚Äî –î–µ–Ω—å {{ date }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
:root {
  --primary: #60F4E3;
  --primary-dark: #48cbbd;
  --secondary: #FF70EC;
  --accent: #FFEFFD;
  --dark: #264653;
  --light: #f8f9fa;
  --white: #ffffff;
  --gray: #6c757d;
  --success: #4CAF50;
  --warning: #FFC107;
  --danger: #F44336;
  --border-radius: 16px;
  --shadow: 0 6px 16px rgba(0,0,0,0.1);
  --transition: all 0.3s ease;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  font-family: 'Montserrat', sans-serif;
}

body { 
  margin: 0; 
  background: linear-gradient(to right, #60F4E3 0%, #FFEFFD 50%, #FF70EC 100%);
  color: var(--dark);
  line-height: 1.6;
  min-height: 100vh;
}

header { 
  background: rgba(255, 255, 255, 0.95);
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  padding: 15px 25px; 
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  backdrop-filter: blur(10px);
}

.logo { 
  font-weight: 700; 
  font-size: 24px; 
  display: flex;
  align-items: center;
  gap: 8px;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: 500;
  color: var(--dark);
}

.user-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid var(--white);
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

nav {
  display: flex;
  gap: 15px;
  align-items: center;
}

.nav-link {
  color: var(--dark);
  text-decoration: none;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 8px 12px;
  border-radius: 8px;
  transition: var(--transition);
}

.nav-link:hover {
  background: rgba(96, 244, 227, 0.1);
}

main { 
  padding: 30px 20px; 
  max-width: 800px; 
  margin: 0 auto; 
}

.day-header {
  text-align: center;
  margin-bottom: 30px;
  background: rgba(255, 255, 255, 0.9);
  padding: 25px;
  border-radius: var(--border-radius);
  box-shadow: var(--shadow);
}

.day-title {
  font-size: 24px;
  font-weight: 700;
  color: var(--dark);
  margin-bottom: 10px;
}

.back-btn {
  background: var(--white);
  color: var(--dark);
  border: 2px solid var(--primary);
  padding: 10px 20px;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: var(--transition);
  margin: 0 auto;
}

.back-btn:hover {
  background: var(--primary);
  transform: translateY(-2px);
}

.mood-section {
  background: var(--white);
  border-radius: var(--border-radius);
  box-shadow: var(--shadow);
  padding: 15px 25px;
  margin-bottom: 20px;
}

.section-title {
  font-size: 18px;
  margin-bottom: 15px;
  color: var(--dark);
  text-align: center;
  font-weight: 700;
}

.mood-display {
  text-align: center;
  margin-bottom: 15px;
}

.mood-value {
  font-size: 36px;
  font-weight: 700;
  margin-bottom: 8px;
  color: var(--primary);
}

.mood-emoji {
  font-size: 48px;
  margin-bottom: 10px;
}

.mood-note {
  background: var(--light);
  padding: 10px 15px;
  border-radius: 12px;
  margin-top: 10px;
  text-align: left;
  border-left: 4px solid var(--primary);
}

.mood-note p {
  margin: 0;
  color: var(--dark);
  line-height: 1.5;
}

.no-mood {
  text-align: center;
  padding: 40px;
  color: var(--gray);
}

.no-mood i {
  font-size: 48px;
  margin-bottom: 15px;
  opacity: 0.5;
}

.add-mood-section {
  background: var(--accent);
  border-radius: var(--border-radius);
  padding: 15px 25px;
  margin-bottom: 20px;
  border: 2px solid var(--primary);
}

.mood-slider-container {
  margin: 20px 0;
}

.mood-slider {
  width: 100%;
  height: 20px;
  border-radius: 10px;
  background: linear-gradient(to right, var(--danger), var(--warning), var(--success));
  outline: none;
  -webkit-appearance: none;
  appearance: none;
}

.mood-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: var(--white);
  border: 3px solid var(--primary);
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  transition: var(--transition);
}

.mood-slider::-webkit-slider-thumb:hover {
  transform: scale(1.1);
}

.mood-slider::-moz-range-thumb {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: var(--white);
  border: 3px solid var(--primary);
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

.mood-labels {
  display: flex;
  justify-content: space-between;
  margin-top: 10px;
  font-size: 12px;
  color: var(--gray);
  font-weight: 600;
}

.mood-preview {
  text-align: center;
  margin: 15px 0;
  font-size: 18px;
  font-weight: 600;
  padding: 10px;
  background: rgba(255, 255, 255, 0.7);
  border-radius: 10px;
}

.note-input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(96, 244, 227, 0.3);
}

.form-actions {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-top: 20px;
}

.btn {
  padding: 12px 25px;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
}

.btn-primary {
  background: var(--primary);
  color: var(--dark);
}

.btn-primary:hover {
  background: var(--primary-dark);
  transform: translateY(-2px);
}

.btn-danger {
  background: var(--danger);
  color: var(--white);
}

.btn-danger:hover {
  background: #d32f2f;
  transform: translateY(-2px);
}

.positive-things {
  background: var(--white);
  border-radius: var(--border-radius);
  box-shadow: var(--shadow);
  padding: 25px;
  margin-bottom: 20px;
}

.add-positive-form {
  margin-bottom: 20px;
}

.input-group {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
}

.positive-input {
  flex: 1;
  padding: 12px 15px;
  border: 2px solid var(--primary);
  border-radius: 12px;
  font-family: 'Montserrat', sans-serif;
  font-size: 14px;
  transition: var(--transition);
}

.positive-input:focus {
  outline: none;
  border-color: var(--secondary);
  box-shadow: 0 0 0 3px rgba(255, 112, 236, 0.2);
}

.positive-list {
  display: grid;
  gap: 10px;
}

.positive-item {
  background: rgba(96, 244, 227, 0.1);
  padding: 15px;
  border-radius: 8px;
  border-left: 4px solid var(--primary);
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 10px;
  margin-bottom: 10px;
  animation: slideIn 0.3s ease;
  transition: var(--transition);
}

.positive-item:hover {
  transform: translateX(5px);
  background: rgba(96, 244, 227, 0.2);
}

.positive-item-content {
  flex: 1;
  min-width: 0; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ */
}

.positive-item-text {
  word-wrap: break-word;
  overflow-wrap: break-word;
  line-height: 1.4;
}

.positive-item-actions {
  display: flex;
  gap: 5px;
  flex-shrink: 0;
}

.positive-item-btn {
  background: none;
  border: none;
  cursor: pointer;
  padding: 5px;
  border-radius: 4px;
  transition: var(--transition);
  color: var(--gray);
}

.positive-item-btn:hover {
  background: rgba(0,0,0,0.1);
  color: var(--dark);
}

.delete-btn:hover {
  color: var(--danger);
}

.empty-positive {
  text-align: center;
  padding: 40px 20px;
  color: var(--gray);
}

.empty-positive i {
  font-size: 48px;
  margin-bottom: 15px;
  opacity: 0.5;
}

.hourly-mood-section {
  background: var(--white);
  border-radius: var(--border-radius);
  box-shadow: var(--shadow);
  padding: 25px;
  margin-bottom: 20px;
}

.hours-grid {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 8px;
  margin-top: 15px;
}

.hour-item {
  background: var(--light);
  border: 2px solid transparent;
  border-radius: 8px;
  padding: 8px 4px;
  text-align: center;
  cursor: pointer;
  transition: var(--transition);
  min-height: 70px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  position: relative;
}

.hour-item:hover {
  border-color: var(--primary);
  transform: translateY(-2px);
}

.hour-item.active {
  background: var(--primary);
  color: var(--dark);
  border-color: var(--primary-dark);
}

.hour-time {
  font-size: 11px;
  font-weight: 600;
  margin-bottom: 4px;
}

.hour-mood {
  font-size: 16px;
  margin-bottom: 2px;
}

.time-note {
  font-size: 9px;
  opacity: 0.7;
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  line-height: 1.2;
  padding: 0 2px;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è */
.hour-item.mood-good {
  background: rgba(96, 244, 227, 0.3);
  border-color: var(--primary);
}

.hour-item.mood-neutral {
  background: rgba(255, 112, 236, 0.2);
  border-color: var(--secondary);
}

.hour-item.mood-bad {
  background: rgba(244, 67, 54, 0.2);
  border-color: var(--danger);
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
.toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background: var(--success);
  color: white;
  padding: 15px 20px;
  border-radius: 8px;
  box-shadow: var(--shadow);
  z-index: 1000;
  font-weight: 600;
  transform: translateX(100%);
  transition: transform 0.3s ease;
}

.toast.show {
  transform: translateX(0);
}

.toast.error {
  background: var(--danger);
}

@media (max-width: 768px) {
  main {
    padding: 20px 15px;
  }
  
  .mood-section, .add-mood-section, .positive-things, .hourly-mood-section {
    padding: 12px 15px;
  }
  
  .mood-value {
    font-size: 28px;
  }
  
  .mood-emoji {
    font-size: 26px;
  }
  
  .hours-grid {
    grid-template-columns: repeat(4, 1fr);
  }
  
  .hour-item {
    min-height: 65px;
    padding: 6px 3px;
  }
  
  .hour-time {
    font-size: 10px;
  }
  
  .hour-mood {
    font-size: 14px;
  }
  
  .time-note {
    font-size: 8px;
  }
}

@media (max-width: 480px) {
  .hours-grid {
    grid-template-columns: repeat(3, 1fr);
  }
  
  header {
    flex-direction: column;
    gap: 15px;
    padding: 15px;
  }
  
  nav {
    flex-direction: column;
    gap: 10px;
  }
  
  .form-actions {
    flex-direction: column;
  }
  
  .btn {
    width: 100%;
    justify-content: center;
  }
  
  .input-group {
    flex-direction: column;
  }
  
  .positive-input {
    width: 100%;
  }
}

@media (max-width: 360px) {
  .hours-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .hour-item {
    min-height: 60px;
  }
}
    </style>
</head>
<body>
<header>
  <div class="logo">
    <span>Lumi</span>
  </div>
  <nav>
    <a href="{{ url_for('main.calendar') }}" class="nav-link">
      <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ –∫–∞–ª–µ–Ω–¥–∞—Ä—é
    </a>
    <div class="user-info">
    <span id="username">
        {% if current_user.is_authenticated %}
            {{ current_user.first_name or current_user.username }}
        {% else %}
            –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        {% endif %}
    </span>
    {% if current_user.avatar_path %}
        <img src="{{ url_for('static', filename=current_user.avatar_path) }}" alt="–ê–≤–∞—Ç–∞—Ä" class="user-avatar">
    {% else %}
        <img src="https://ui-avatars.com/api/?name={{ current_user.first_name or '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' }}&background=60F4E3&color=264653" alt="–ê–≤–∞—Ç–∞—Ä" class="user-avatar">
    {% endif %}
    </div>
  </nav>
</header>

<main>
  <div class="day-header">
    <h2 class="day-title" id="dayTitle">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
  </div>

  <div class="mood-section">
    <h3 class="section-title">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –¥–Ω—è</h3>
    
    <div id="moodDisplay">
      <div class="no-mood" id="noMood">
        <i class="fas fa-cloud"></i>
        <h4>–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –Ω–µ –æ—Ç–º–µ—á–µ–Ω–æ</h4>
        <p>–î–æ–±–∞–≤—å—Ç–µ –≤–∞—à–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –Ω–∏–∂–µ</p>
      </div>
      
      <div class="mood-display" id="moodDisplayContent" style="display: none;">
        <div class="mood-value" id="moodValue">0/10</div>
        <div class="mood-emoji" id="moodEmoji">üòê</div>
        <div class="mood-note" id="moodNoteDisplay">
          <p id="moodNoteText">–ù–µ—Ç –∑–∞–º–µ—Ç–∫–∏</p>
        </div>
        <div class="form-actions">
          <button class="btn btn-danger" onclick="deleteMood()">
            <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="add-mood-section">
    <h3 class="section-title">–û—Ü–µ–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ</h3>
    
    <div class="mood-slider-container">
      <input type="range" min="1" max="10" value="5" class="mood-slider" id="moodSlider" oninput="updateMoodPreview()">
      <div class="mood-labels">
        <span>üòû –ü–ª–æ—Ö–æ</span>
        <span>üòê –ù–æ—Ä–º–∞–ª—å–Ω–æ</span>
        <span>üòä –û—Ç–ª–∏—á–Ω–æ</span>
      </div>
    </div>
    
    <div class="mood-preview" id="moodPreview">
      5/10 - –ù–æ—Ä–º–∞–ª—å–Ω–æ üòê
    </div>
    
    <div class="form-actions">
      <button class="btn btn-primary" onclick="saveMood()">
        <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
      </button>
    </div>
  </div>

  <div class="hourly-mood-section">
    <h3 class="section-title">–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–æ —á–∞—Å–∞–º (24 —á–∞—Å–∞)</h3>
    <div class="hours-grid" id="hoursGrid">
      <!-- 24 —á–∞—Å–∞ –±—É–¥—É—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
    </div>
  </div>

  <div class="positive-things">
    <h3 class="section-title">–ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–æ–≤–ª–∏—è–ª–æ –Ω–∞ –≤–∞—à –¥–µ–Ω—å?</h3>
    
    <!-- –§–æ—Ä–º–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞–¥–æ—Å—Ç–Ω–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞ -->
    <div class="add-positive-form">
      <div class="input-group">
        <input type="text" id="positiveInput" placeholder="–ß—Ç–æ —Å–µ–≥–æ–¥–Ω—è –≤–∞—Å –ø–æ—Ä–∞–¥–æ–≤–∞–ª–æ?" class="positive-input">
        <button class="btn btn-primary" onclick="addPositiveThing()">
          <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å
        </button>
      </div>
    </div>
    
    <div class="positive-list" id="positiveList">
      <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
    </div>
  </div>

  <div style="text-align: center; margin-top: 20px;">
    <button class="back-btn" onclick="goBack()">
      <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ –∫–∞–ª–µ–Ω–¥–∞—Ä—é
    </button>
  </div>
</main>

<script>
const API_BASE = "{{ url_for('main.mood_entries') }}";
const JOYS_API = "{{ url_for('main.joys') }}";
const HOURLY_MOODS_API = "{{ url_for('main.hourly_moods') }}";
let currentDate = null;
let currentMood = null;
let hourlyMoods = {};
let positiveThings = [];

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...');
    loadDayData();
    init24HourTracking();
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    const positiveInput = document.getElementById('positiveInput');
    if (positiveInput) {
        positiveInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addPositiveThing();
            }
        });
    }
});

function getDateFromUrl() {
    const path = window.location.pathname;
    const match = path.match(/\/calendar\/day\/(\d{4}-\d{1,2}-\d{1,2})/);
    return match ? match[1] : null;
}

async function loadDayData() {
    const date = getDateFromUrl();
    if (!date) {
        showError('–î–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
        return;
    }

    currentDate = date;
    console.log('üìÖ –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞:', currentDate);

    try {
        const response = await fetch(`${API_BASE}?date=${date}`);
        if (response.ok) {
            const dayMoods = await response.json();
            updateDayView(dayMoods);
        } else {
            throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–Ω—è:', error);
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –¥–Ω—è');
    }
}

function updateDayView(dayMoods) {
    const date = currentDate;
    if (!date) return;

    const [year, month, day] = date.split('-');
    const dateObj = new Date(year, month - 1, day);
    
    document.getElementById('dayTitle').textContent = dateObj.toLocaleDateString("ru-RU", {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    
    // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—É—é –∑–∞–ø–∏—Å—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –∑–∞ –¥–µ–Ω—å (—É –Ω–∞—Å –æ–¥–Ω–∞ –∑–∞–ø–∏—Å—å –Ω–∞ –¥–µ–Ω—å)
    if (dayMoods.length > 0) {
        currentMood = dayMoods[0];
        showMoodDisplay(currentMood);
    } else {
        showNoMood();
    }

    loadPositiveThings();
    updateHourlyMoods();
}

function showMoodDisplay(mood) {
    document.getElementById('noMood').style.display = 'none';
    document.getElementById('moodDisplayContent').style.display = 'block';
    
    document.getElementById('moodValue').textContent = `${mood.mood}/10`;
    document.getElementById('moodEmoji').textContent = getMoodEmoji(mood.mood);
    
    if (mood.note && mood.note.trim() !== '') {
        document.getElementById('moodNoteText').textContent = mood.note;
        document.getElementById('moodNoteDisplay').style.display = 'block';
    } else {
        document.getElementById('moodNoteDisplay').style.display = 'none';
    }
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É —Ç–µ–∫—É—â–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    document.getElementById('moodSlider').value = mood.mood;
    updateMoodPreview();
}

function showNoMood() {
    document.getElementById('noMood').style.display = 'block';
    document.getElementById('moodDisplayContent').style.display = 'none';
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
    document.getElementById('moodSlider').value = 5;
    updateMoodPreview();
}

function getMoodEmoji(moodValue) {
    if (moodValue >= 8) return 'üòä';
    if (moodValue >= 5) return 'üòê';
    if (moodValue >= 3) return 'üòï';
    return 'üòû';
}

function getMoodText(moodValue) {
    if (moodValue >= 9) return '–û—Ç–ª–∏—á–Ω–æ';
    if (moodValue >= 7) return '–û—á–µ–Ω—å —Ö–æ—Ä–æ—à–æ';
    if (moodValue >= 5) return '–ù–æ—Ä–º–∞–ª—å–Ω–æ';
    if (moodValue >= 3) return '–ù–µ –æ—á–µ–Ω—å';
    return '–ü–ª–æ—Ö–æ';
}

function getMoodColorClass(moodValue) {
    if (moodValue >= 7) return 'mood-good';
    if (moodValue >= 4) return 'mood-neutral';
    return 'mood-bad';
}

function updateMoodPreview() {
    const moodValue = document.getElementById('moodSlider').value;
    const emoji = getMoodEmoji(parseInt(moodValue));
    const text = getMoodText(parseInt(moodValue));
    
    document.getElementById('moodPreview').textContent = `${moodValue}/10 - ${text} ${emoji}`;
}

async function saveMood() {
    const moodValue = parseInt(document.getElementById('moodSlider').value);
    const note = '';

    try {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –¥–Ω—è
        const response = await fetch(API_BASE, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                date: currentDate,
                mood: moodValue,
            })
        });

        if (!response.ok) {
            const err = await response.json();
            throw new Error(err.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–±—â–µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è');
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—á–∞—Å–æ–≤–æ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
        await fetch(HOURLY_MOODS_API, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                date: currentDate,
                hour: new Date().getHours(), 
                mood: moodValue,
                note: note
            })
        });

        await updateHourlyMoods();
        await loadDayData();
        showToast('–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!', 'success');

    } catch (error) {
        console.error(error);
        showToast('–û—à–∏–±–∫–∞: ' + error.message, 'error');
    }
}

async function deleteMood() {
    if (!currentMood || !confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–∏?')) return;

    try {
        const response = await fetch(`${API_BASE}/${currentMood.id}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            await loadDayData();
            showToast('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞!', 'success');
        } else {
            throw new Error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏', 'error');
    }
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–∞–¥–æ—Å—Ç–Ω—ã–º–∏ –º–æ–º–µ–Ω—Ç–∞–º–∏
async function loadPositiveThings() {
    try {
        const response = await fetch(JOYS_API);
        if (response.ok) {
            const joys = await response.json();
            // –§–∏–ª—å—Ç—Ä—É–µ–º —Ä–∞–¥–æ—Å—Ç–∏ –ø–æ —Ç–µ–∫—É—â–µ–π –¥–∞—Ç–µ
            positiveThings = joys.filter(joy => {
                const joyDate = new Date(joy.created_at).toISOString().split('T')[0];
                return joyDate === currentDate;
            });
            renderPositiveList();
        } else {
            throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞–¥–æ—Å—Ç–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞–¥–æ—Å—Ç–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤:', error);
        positiveThings = [];
        renderPositiveList();
    }
}

function renderPositiveList() {
    const positiveList = document.getElementById('positiveList');
    
    if (positiveThings.length === 0) {
        positiveList.innerHTML = `
            <div class="empty-positive">
                <i class="fas fa-sun"></i>
                <p>–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ —Ä–∞–¥–æ—Å—Ç–Ω—ã—Ö –º–æ–º–µ–Ω—Ç–∞—Ö</p>
                <small>–î–æ–±–∞–≤—å—Ç–µ —á—Ç–æ-—Ç–æ, —á—Ç–æ –≤–∞—Å —Å–µ–≥–æ–¥–Ω—è –ø–æ—Ä–∞–¥–æ–≤–∞–ª–æ!</small>
            </div>
        `;
    } else {
        positiveList.innerHTML = positiveThings.map((item, index) => `
            <div class="positive-item">
                <div class="positive-item-content">
                    <div class="positive-item-text">
                        <strong>${item.text}</strong>
                    </div>
                    ${item.created_at ? `<div class="time-note" style="margin-top: 5px;">${new Date(item.created_at).toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</div>` : ''}
                </div>
                <div class="positive-item-actions">
                    <button class="positive-item-btn delete-btn" onclick="deletePositiveThing(${item.id})" title="–£–¥–∞–ª–∏—Ç—å">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }
}

async function addPositiveThing() {
    const input = document.getElementById('positiveInput');
    const text = input.value.trim();
    
    if (!text) {
        showToast('–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–¥–æ—Å—Ç–Ω–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞', 'error');
        return;
    }
    
    try {
        const response = await fetch(JOYS_API, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                text: text
            })
        });

        if (response.ok) {
            const newJoy = await response.json();
            positiveThings.unshift(newJoy);
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
            input.value = '';
            renderPositiveList();
            showToast('–†–∞–¥–æ—Å—Ç–Ω—ã–π –º–æ–º–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω! üåü');
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–æ–≤–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
            const positiveList = document.getElementById('positiveList');
            positiveList.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
            const errorData = await response.json();
            throw new Error(errorData.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        showToast('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–∞–¥–æ—Å—Ç–Ω–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞: ' + error.message, 'error');
    }
}

async function deletePositiveThing(joyId) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ä–∞–¥–æ—Å—Ç–Ω—ã–π –º–æ–º–µ–Ω—Ç?')) return;

    try {
        const response = await fetch(`${JOYS_API}/${joyId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            // –£–¥–∞–ª—è–µ–º –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—Å–∏–≤–∞
            positiveThings = positiveThings.filter(item => item.id !== joyId);
            renderPositiveList();
            showToast('–ó–∞–ø–∏—Å—å —É–¥–∞–ª–µ–Ω–∞');
        } else {
            throw new Error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏', 'error');
    }
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ—á–∞—Å–æ–≤—ã–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ–º
async function updateHourlyMoods() {
    try {
        console.log('üïí –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—á–∞—Å–æ–≤–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è –¥–ª—è –¥–∞—Ç—ã:', currentDate);
        const response = await fetch(`${HOURLY_MOODS_API}?date=${currentDate}`);
        
        console.log('üì° –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);
        
        if (response.ok) {
            const hourlyData = await response.json();
            console.log('‚úÖ –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø–æ—á–∞—Å–æ–≤–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è:', hourlyData);
            
            hourlyMoods = {};
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ–±—ä–µ–∫—Ç hourlyMoods –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ –±–∞–∑—ã
            hourlyData.forEach(entry => {
                hourlyMoods[entry.hour] = {
                    id: entry.id,
                    mood: entry.mood,
                    note: entry.note
                };
            });
            
            console.log('üìä hourlyMoods –æ–±—ä–µ–∫—Ç:', hourlyMoods);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            renderHourlyMoods();
        } else {
            console.error('‚ùå –û—à–∏–±–∫–∞ HTTP:', response.status, response.statusText);
            const errorText = await response.text();
            console.error('‚ùå –¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏:', errorText);
            throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—á–∞—Å–æ–≤–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è');
        }
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—á–∞—Å–æ–≤–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è:', error);
        hourlyMoods = {};
        renderHourlyMoods();
    }
}

function renderHourlyMoods() {
    console.log('üé® –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø–æ—á–∞—Å–æ–≤–æ–≥–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è. –î–∞–Ω–Ω—ã–µ:', hourlyMoods);
    
    let updatedCount = 0;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å–µ—Ö —á–∞—Å–æ–≤
    for (let hour = 0; hour < 24; hour++) {
        const hourItem = document.querySelector(`[data-hour="${hour}"]`);
        const moodElement = document.getElementById(`hourMood${hour}`);
        const noteElement = document.getElementById(`hourNote${hour}`);
        
        if (hourItem && moodElement && noteElement) {
            if (hourlyMoods[hour]) {
                const moodData = hourlyMoods[hour];
                console.log(`üïê –ß–∞—Å ${hour}: –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ ${moodData.mood}, –∑–∞–º–µ—Ç–∫–∞: "${moodData.note}"`);
                
                moodElement.textContent = getMoodEmoji(moodData.mood);
                noteElement.textContent = moodData.note || '';
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª–∞—Å—Å—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è
                hourItem.className = 'hour-item active';
                hourItem.classList.add(getMoodColorClass(moodData.mood));
                
                updatedCount++;
            } else {
                moodElement.textContent = '-';
                noteElement.textContent = '';
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–ª–∞—Å—Å—ã
                hourItem.className = 'hour-item';
                hourItem.classList.remove('mood-good', 'mood-neutral', 'mood-bad', 'active');
            }
        } else {
            console.warn(`‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —á–∞—Å–∞ ${hour}`);
        }
    }
    
    console.log(`‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ ${updatedCount} —á–∞—Å–æ–≤ –∏–∑ 24`);
}

async function selectHour(hour) {
    console.log('üéØ –í—ã–±—Ä–∞–Ω —á–∞—Å:', hour);
    
    const moodInput = prompt(`–í–≤–µ–¥–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –¥–ª—è ${hour.toString().padStart(2, '0')}:00 (1-10):`);
    if (moodInput && moodInput >= 1 && moodInput <= 10) {
        const mood = parseInt(moodInput);
        const note = prompt('–î–æ–±–∞–≤—å—Ç–µ –∑–∞–º–µ—Ç–∫—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):') || '';
        
        console.log('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è:', { 
            date: currentDate, 
            hour: hour, 
            mood: mood, 
            note: note 
        });
        
        try {
            const response = await fetch(HOURLY_MOODS_API, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    date: currentDate,
                    hour: hour,
                    mood: mood,
                    note: note
                })
            });

            console.log('üì° –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status, response.statusText);

            if (response.ok) {
                console.log('‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –±–∞–∑—É');
                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
                await updateHourlyMoods();
                showToast(`–ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –¥–ª—è ${hour.toString().padStart(2, '0')}:00 —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!`);
            } else {
                const errorData = await response.json();
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', errorData);
                throw new Error(errorData.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞:', error);
            showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏—è: ' + error.message, 'error');
        }
    }
}

function init24HourTracking() {
    const hoursGrid = document.getElementById('hoursGrid');
    if (!hoursGrid) {
        console.error('‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω —ç–ª–µ–º–µ–Ω—Ç hoursGrid');
        return;
    }
    
    console.log('üéØ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è 24-—á–∞—Å–æ–≤–æ–π —Å–µ—Ç–∫–∏');
    
    let html = '';
    for (let hour = 0; hour < 24; hour++) {
        const hourDisplay = hour.toString().padStart(2, '0');
        html += `
            <div class="hour-item" data-hour="${hour}" onclick="selectHour(${hour})">
                <div class="hour-time">${hourDisplay}:00</div>
                <div class="hour-mood" id="hourMood${hour}">-</div>
                <div class="time-note" id="hourNote${hour}"></div>
            </div>
        `;
    }
    hoursGrid.innerHTML = html;
    console.log('‚úÖ 24-—á–∞—Å–æ–≤–∞—è —Å–µ—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∞');
}

function goBack() {
    window.location.href = "{{ url_for('main.calendar') }}";
}

function showToast(message, type = 'info') {
    // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π toast
    const toast = document.createElement('div');
    toast.className = `toast ${type === 'error' ? 'error' : ''}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º toast
    setTimeout(() => {
        toast.classList.add('show');
    }, 10);
    
    // –£–±–∏—Ä–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 300);
    }, 3000);
}

function showError(message) {
    document.getElementById('dayTitle').textContent = '–û—à–∏–±–∫–∞';
    const moodDisplay = document.getElementById('moodDisplay');
    moodDisplay.innerHTML = `<div class="no-mood"><p>${message}</p></div>`;
}
</script>
</body>
</html>